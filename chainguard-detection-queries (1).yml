---
apiVersion: v1
spec:
  query: |
    -- Catch DNS traffic going to machines other than the host-configured DNS server (event-based)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1071/004/ (C2: Application Layer Protocol: DNS)
    --
    -- interval: 120
    -- tags: persistent events net
    --
    -- NOTE: The interval above must match WHERE clause to avoid missing events
    --
    -- This only supports IPv4 traffic due to an osquery bug with 'dns_resolvers'
    -- The non-event version is unexpected-dns-traffic.sql
    SELECT
      protocol,
      s.remote_port,
      s.remote_address,
      p.name,
      p.path,
      p.cmdline AS child_cmd,
      p.cwd,
      s.pid,
      p.parent AS parent_pid,
      pp.cmdline AS parent_cmd,
      hash.sha256,
      CONCAT (p.name, ',', remote_address, ',', remote_port) AS exception_key
    FROM
      socket_events s
      LEFT JOIN processes p ON s.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      s.time > (strftime('%s', 'now') -120)
      AND remote_port IN (53, 5353)
      AND remote_address NOT LIKE '%:%'
      AND s.remote_address NOT LIKE '172.1%'
      AND s.remote_address NOT LIKE '172.2%'
      AND s.remote_address NOT LIKE '172.30.%'
      AND s.remote_address NOT LIKE '172.31.%'
      AND s.remote_address NOT LIKE '10.%'
      AND s.remote_address NOT LIKE '192.168.%'
      AND s.remote_address NOT LIKE '127.%'
      AND remote_address NOT IN (
        SELECT DISTINCT
          address
        FROM
          dns_resolvers
        WHERE
          type = 'nameserver'
          and address != ''
      )
      -- systemd-resolve sometimes shows up this way
      -- If we could narrow this down using 'sys_resolvers' I would, but it is misuse of GROUP_CONCAT
      AND NOT (
        s.pid = -1
        AND s.remote_port = 53
        and p.parent = ''
      )
      -- Some applications hard-code a safe DNS resolver, or allow the user to configure one
      AND s.remote_address NOT IN (
        '1.1.1.1', -- Cloudflare
        '1.1.1.2', -- Cloudflare
        '8.8.8.8', -- Google
        '8.8.4.4', -- Google (backup)
        '208.67.222.222', -- OpenDNS
        '75.75.75.75', -- Comcast
        '75.75.76.76', -- Comcast
        '68.105.28.13' -- Cox
      )
      -- Exceptions that specifically talk to one server
      AND exception_key NOT IN (
        'coredns,0.0.0.0,53',
        'syncthing,46.162.192.181,53'
      )
      AND p.name != 'nessusd'
      -- Local DNS servers and custom clients go here
      AND p.path NOT IN (
        '/usr/lib/systemd/systemd-resolved',
        '/Library/Nessus/run/sbin/nessusd',
        '/Applications/Slack.app/Contents/Frameworks/Slack Helper.app/Contents/MacOS/Slack Helper',
        '/Applications/Spotify.app/Contents/Frameworks/Spotify Helper.app/Contents/MacOS/Spotify Helper'
      )
      AND p.path NOT LIKE '/Applications/Google Chrome.app/Contents/Frameworks/Google Chrome Framework.framework/Versions/%/Helpers/Google Chrome Helper.app/Contents/MacOS/Google Chrome Helper'
      -- Workaround for the GROUP_CONCAT subselect adding a blank ent
    GROUP BY
      s.remote_address,
      s.remote_port
    HAVING
      remote_address != ''
  description: Catch DNS traffic going to machines other than the host-configured DNS server (event-based)
  name: 'Detection - C2: Unexpected Dns Traffic Events'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Catch DNS traffic going to machines other than the host-configured DNS server (state-based)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1071/004/ (C2: Application Layer Protocol: DNS)
    --
    -- tags: transient state net often dns
    --
    -- NOTE: This only supports IPv4 traffic due to an osquery bug with 'dns_resolvers'
    SELECT
      s.family,
      protocol,
      s.local_port,
      s.remote_port,
      s.local_address,
      s.remote_address,
      p.name,
      p.path,
      p.cmdline AS child_cmd,
      p.cwd,
      s.pid,
      p.parent AS parent_pid,
      pp.cmdline AS parent_cmd,
      hash.sha256,
      GROUP_CONCAT(
        (
          SELECT DISTINCT
            address
          FROM
            dns_resolvers
          WHERE
            type = 'nameserver'
            AND address != ''
        ),
        ','
      ) AS sys_resolvers,
      CONCAT (p.name, ',', remote_address, ',', remote_port) AS exception_key
    FROM
      process_open_sockets s
      LEFT JOIN processes p ON s.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      remote_port IN (53, 5353)
      AND remote_address NOT LIKE '%:%'
      AND s.remote_address NOT LIKE '172.1%'
      AND s.remote_address NOT LIKE '172.2%'
      AND s.remote_address NOT LIKE '172.30.%'
      AND s.remote_address NOT LIKE '172.31.%'
      AND s.remote_address NOT LIKE '10.%'
      AND s.remote_address NOT LIKE '192.168.%'
      AND s.remote_address NOT LIKE '127.%'
      AND remote_address NOT IN (
        SELECT DISTINCT
          address
        FROM
          dns_resolvers
        WHERE
          type = 'nameserver'
          and address != ''
      )
      -- systemd-resolve sometimes shows up this way
      -- If we could narrow this down using 'sys_resolvers' I would, but it is misuse of GROUP_CONCAT
      AND NOT (
        s.pid = -1
        AND s.remote_port = 53
        and s.protocol = 17
        and p.parent = ''
      )
      -- Some applications hard-code a safe DNS resolver, or allow the user to configure one
      AND s.remote_address NOT IN (
        '1.1.1.1', -- Cloudflare
        '1.1.1.2', -- Cloudflare
        '8.8.8.8', -- Google
        '8.8.4.4', -- Google (backup)
        '208.67.222.222', -- OpenDNS
        '75.75.75.75', -- Comcast
        '68.105.28.13' -- Cox
      )
      -- Other exceptions
      AND exception_key NOT IN (
        'coredns,0.0.0.0,53',
        'nessusd,50.16.123.71,53',
        'syncthing,46.162.192.181,53'
      )
      -- Local DNS servers and custom clients go here
      AND p.path NOT IN (
        '/usr/lib/systemd/systemd-resolved',
        '/Applications/Slack.app/Contents/Frameworks/Slack Helper.app/Contents/MacOS/Slack Helper',
        '/Applications/Spotify.app/Contents/Frameworks/Spotify Helper.app/Contents/MacOS/Spotify Helper'
      )
      AND p.path NOT LIKE '/Applications/Google Chrome.app/Contents/Frameworks/Google Chrome Framework.framework/Versions/%/Helpers/Google Chrome Helper.app/Contents/MacOS/Google Chrome Helper'
      -- Workaround for the GROUP_CONCAT subselect adding a blank ent
      -- Workaround for the GROUP_CONCAT subselect adding a blank ent
    GROUP BY
      s.remote_address,
      s.remote_port
    HAVING
      remote_address != ''
  description: Catch DNS traffic going to machines other than the host-configured DNS server (state-based)
  name: 'Detection - C2: Unexpected Dns Traffic'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unexpected programs communicating over HTTPS (state-based)
    --
    -- This query is a bit awkward and hobbled due to the lack of osquery support
    -- for looking up binary signatures in Linux.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1071/ (C&C, Application Layer Protocol)
    --
    -- tags: transient state net often
    -- platform: linux
    SELECT
      s.remote_address,
      p.name,
      p.path,
      p.cmdline AS child_cmd,
      p.cwd,
      pp.path AS parent_path,
      p.parent AS parent_pid,
      pp.cmdline AS parent_cmd,
      s.state,
      hash.sha256,
      -- This intentionally avoids file.path, as it won't join across mount namespaces
      CONCAT (
        MIN(p.euid, 500),
        ',',
        REPLACE(
          REPLACE(
            REGEX_MATCH (p.path, '(/.*?)/', 1),
            '/nix',
            '/usr'
          ),
          '/snap',
          '/opt'
        ),
        '/',
        REGEX_MATCH (p.path, '.*/(.*?)$', 1),
        ',',
        MIN(f.uid, 500),
        'u,',
        MIN(f.gid, 500),
        'g,',
        p.name
      ) AS exception_key
    FROM
      process_open_sockets s
      LEFT JOIN processes p ON s.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      protocol IN (6, 17)
      AND s.remote_port = 443
      AND s.remote_address NOT IN ('127.0.0.1', '::ffff:127.0.0.1', '::1')
      AND s.remote_address NOT LIKE 'fe80:%'
      AND s.remote_address NOT LIKE '127.%'
      AND s.remote_address NOT LIKE '192.168.%'
      AND s.remote_address NOT LIKE '172.1%'
      AND s.remote_address NOT LIKE '172.2%'
      AND s.remote_address NOT LIKE '172.30.%'
      AND s.remote_address NOT LIKE '172.31.%'
      AND s.remote_address NOT LIKE '::ffff:172.%'
      AND s.remote_address NOT LIKE '10.%'
      AND s.remote_address NOT LIKE '::ffff:10.%'
      AND s.remote_address NOT LIKE 'fc00:%'
      AND p.path != ''
      AND NOT exception_key IN (
        '0,/usr/dockerd,0u,0g,dockerd',
        '0,/usr/flatpak-system-helper,0u,0g,flatpak-system-',
        '0,/usr/launcher,0u,0g,launcher',
        '0,/usr/nix,0u,0g,nix',
        '0,/usr/packagekitd,0u,0g,packagekitd',
        '0,/usr/pacman,0u,0g,pacman',
        '0,/usr/python3.10,0u,0g,dnf',
        '0,/usr/tailscaled,0u,0g,tailscaled',
        '0,/usr/.tailscaled-wrapped,0u,0g,.tailscaled-wra',
        '500,/app/slack,u,g,slack',
        '500,/app/thunderbird,u,g,thunderbird',
        '500,/app/zoom.real,u,g,zoom.real',
        '500,/home/chainctl,500u,100g,chainctl',
        '500,/home/chainctl,500u,500g,chainctl',
        '500,/home/gitsign,500u,500g,gitsign',
        '500,/home/go,500u,500g,go',
        '500,/ko-app/chainctl,u,g,chainctl',
        '500,/ko-app/controlplane,u,g,controlplane',
        '500,/opt/1password,0u,0g,1password',
        '500,/opt/chrome,0u,0g,chrome',
        '500,/opt/firefox,0u,0g,firefox',
        '500,/opt/kubectl,0u,0g,kubectl',
        '500,/opt/slack,0u,0g,slack',
        '500,/opt/spotify,0u,0g,spotify',
        '500,/usr/abrt-action-generate-core-backtrace,0u,0g,abrt-action-gen',
        '500,/usr/chainctl,0u,0g,chainctl',
        '500,/usr/chrome,0u,0g,chrome',
        '500,/usr/code,0u,0g,code',
        '500,/usr/curl,0u,0g,curl',
        '500,/usr/electron,0u,0g,electron',
        '500,/usr/firefox,0u,0g,firefox',
        '500,/usr/firefox,0u,0g,.firefox-wrappe',
        '500,/usr/firefox,0u,0g,Socket Process',
        '500,/usr/flatpak-oci-authenticator,0u,0g,flatpak-oci-aut',
        '500,/usr/geoclue,0u,0g,geoclue',
        '500,/usr/gitsign,0u,0g,gitsign',
        '500,/usr/gnome-software,0u,0g,gnome-software',
        '500,/usr/go,500u,500g,go',
        '500,/usr/kubectl,500u,500g,kubectl',
        '500,/usr/slack,0u,0g,slack',
        '500,/usr/syncthing,0u,0g,syncthing',
        '500,/usr/terraform,0u,0g,terraform',
        '500,/usr/WebKitNetworkProcess,0u,0g,WebKitNetworkPr',
        '500,/usr/xmobar,0u,0g,xmobar'
      )
      -- Exceptions where we have to be more flexible for the process name
      AND NOT exception_key LIKE '500,/usr/node,0u,0g,npm exec %'
      AND NOT exception_key LIKE '500,%/terraform-provider-aws_%,500u,500g,terraform-provi'
      -- stay weird, NixOS (Fastly nix mirror)
      AND NOT (
        pp.cmdline = '/run/current-system/sw/bin/bash'
        AND p.path LIKE '/nix/store/%'
        AND s.remote_address LIKE '151.101.%'
        AND s.state = 'ESTABLISHED'
      )
    GROUP BY
      p.cmdline
  description: Unexpected programs communicating over HTTPS (state-based)
  name: 'Detection - C2: Unexpected Https Client Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unexpected programs speaking over ICMP (event-based)
    --
    -- references:
    --   *https://attack.mitre.org/techniques/T1095/ (C2: Non-Application Layer Protocol)
    --
    -- interval: 30
    -- tags: transient events net
    SELECT
      se.*,
      p.path,
      p.cmdline
    FROM
      socket_events se
      LEFT JOIN processes p ON se.pid = p.pid
    WHERE
      se.time > (strftime('%s', 'now') -30)
      AND family = 2 -- PF_INET
      AND protocol = 1 -- ICMP
      AND p.name NOT IN ('ping')
  description: Unexpected programs speaking over ICMP (event-based)
  name: 'Detection - C2: Unexpected Icmp Socket Events'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unexpected programs speaking over ICMP (state-based)
    --
    -- references:
    --   *https://attack.mitre.org/techniques/T1095/ (C2: Non-Application Layer Protocol)
    --
    -- tags: transient state net often
    SELECT
      pop.pid,
      p.path,
      p.cmdline
    FROM
      process_open_sockets pop
      JOIN processes p ON pop.pid = p.pid
    WHERE
      family = 2 -- PF_INET
      AND protocol = 1 -- ICMP
      AND p.name NOT IN ('ping')
  description: Unexpected programs speaking over ICMP (state-based)
  name: 'Detection - C2: Unexpected Icmp Socket'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unexpected programs listening on a TCP port (state-based).
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1571/ (Non-Standard Port)
    --
    -- tags: persistent state net
    SELECT
      lp.address,
      lp.port,
      lp.protocol,
      p.uid,
      p.pid,
      p.name,
      p.path,
      p.cmdline,
      p.cwd,
      hash.sha256,
      CONCAT (
        MIN(lp.port, 32768),
        ',',
        lp.protocol,
        ',',
        MIN(p.uid, 500),
        ',',
        p.name
      ) AS exception_key
    FROM
      listening_ports lp
      LEFT JOIN processes p ON lp.pid = p.pid
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      port != 0
      AND lp.address NOT IN ('224.0.0.251', '::1')
      AND lp.address NOT LIKE '127.0.0.%'
      AND lp.address NOT LIKE '172.1%'
      AND lp.address NOT LIKE 'fe80::%'
      AND lp.address NOT LIKE '::ffff:127.0.0.%'
      -- All outgoing UDP (protocol 17) sessions are 'listening'
      AND NOT (
        lp.protocol = 17
        AND lp.port > 1024
      )
      -- Random webservers
      AND NOT (
        p.uid > 500
        AND lp.port IN (8000, 8080)
        AND lp.protocol = 6
      )
      -- Filter out unmapped raw sockets
      AND NOT (p.pid == '')
      -- Exceptions: the uid is capped at 500 to represent regular users versus system users
      -- port is capped at 32768 to represent transient ports
      AND NOT CONCAT (
        MIN(lp.port, 32768),
        ',',
        lp.protocol,
        ',',
        MIN(p.uid, 500),
        ',',
        p.name
      ) IN (
        '10250,6,0,kubelet',
        '10256,6,0,kube-proxy',
        '1716,6,500,kdeconnectd',
        '17,255,0,dhcpcd',
        '17,255,0,tailscaled',
        '17,255,500,dhcpcd',
        '17,255,500,mtr-packet',
        '22000,6,500,syncthing',
        '22,6,0,sshd',
        '3000,6,472,grafana-server',
        '3000,6,500,grafana-server',
        '32768,6,0,tailscaled',
        '32768,6,0,.tailscaled-wra',
        '32768,6,500,com.docker.backend',
        '32768,6,500,dleyna-renderer',
        '32768,6,500,spotify',
        '3551,6,0,apcupsd',
        '4143,6,500,linkerd2-proxy',
        '4191,6,500,linkerd2-proxy',
        '443,6,500,jcef_helper',
        '4443,6,500,metrics-server',
        '5000,6,500,ControlCenter',
        '5001,6,0,registry',
        '53,17,0,coredns',
        '53,17,500,dnsmasq',
        '5355,6,193,systemd-resolve',
        '53,6,0,coredns',
        '53,6,500,dnsmasq',
        '5432,6,70,postgres',
        '546,17,500,dhcpcd',
        '58,255,0,dhcpcd',
        '58,255,0,NetworkManager',
        '58,255,500,dhcpcd',
        '58,255,500,mtr-packet',
        '631,17,0,cups-browsed',
        '5000,6,0,registry',
        '6379,6,500,redis-server',
        '6443,6,0,kube-apiserver',
        '67,17,500,dnsmasq',
        '68,17,500,dhcpcd',
        '7000,6,500,ControlCenter',
        '8008,6,500,controlplane',
        '8009,6,0,java',
        '80,6,101,nginx',
        '80,6,60,nginx',
        '8080,6,0,coredns',
        '8080,6,0,java',
        '8086,6,0,influxd',
        '8086,6,500,controller',
        '8086,6,500,influxd',
        '8090,6,500,linkerd-policy-',
        '8123,6,500,Brackets-node',
        '8181,6,0,coredns',
        '8443,6,0,kube-apiserver',
        '8443,6,500,controller',
        '8443,6,500,controlplane',
        '9000,6,500,authentik-proxy',
        '9090,6,500,controlplane',
        '9153,6,0,coredns',
        '9300,6,500,authentik-proxy'
      )
      AND NOT (
        p.path LIKE ',ko-app,%'
        AND lp.port > 1024
        and lp.protocol = 6
      )
      AND NOT (
        p.name IN ('hugo', 'docker-proxy', 'rootlessport')
        AND lp.port > 1024
        and lp.protocol = 6
      )
    GROUP BY
      exception_key
  description: Unexpected programs listening on a TCP port (state-based).
  name: 'Detection - C2: Unexpected Listening Port Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unexpected programs listening on a TCP port.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1571/ (Non-Standard Port)
    --
    -- tags: persistent state net low
    -- platform: darwin
    SELECT
      lp.address,
      lp.port,
      lp.protocol,
      p.uid,
      p.pid,
      p.name,
      p.path,
      p.cmdline,
      p.cwd,
      hash.sha256,
      signature.authority AS program_authority,
      CONCAT (
        MIN(lp.port, 49152),
        ',',
        lp.protocol,
        ',',
        MIN(p.uid, 500),
        ',',
        p.name,
        ',',
        signature.authority
      ) AS exception_key
    FROM
      listening_ports lp
      LEFT JOIN processes p ON lp.pid = p.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN signature ON p.path = signature.path
    WHERE
      port != 0
      AND lp.address NOT IN ('224.0.0.251', '::1')
      AND lp.address NOT LIKE '127.0.0.%'
      AND lp.address NOT LIKE '172.1%'
      AND lp.address NOT LIKE 'fe80::%'
      AND lp.address NOT LIKE '::ffff:127.0.0.%'
      -- All outgoing UDP (protocol 17) sessions are 'listening'
      AND NOT (
        lp.protocol = 17
        AND lp.port > 1024
      )
      -- Random webservers
      AND NOT (
        p.uid > 500
        AND lp.port IN (8000, 8080)
        AND lp.protocol = 6
      )
      -- Filter out unmapped raw sockets
      AND NOT (p.pid == '')
      -- Exceptions: the uid is capped at 500 to represent regular users versus system users
      -- port is capped at 49152 to represent transient ports
      AND NOT exception_key IN (
        '10011,6,0,launchd,Software Signing',
        '1313,6,500,hugo,',
        '1338,6,500,registry,',
        '137,17,0,launchd,Software Signing',
        '137,17,222,netbiosd,Software Signing',
        '138,17,0,launchd,Software Signing',
        '138,17,222,netbiosd,Software Signing',
        '16587,6,500,RescueTime,Developer ID Application: RescueTime, Inc (FSY4RB8H39)',
        '17500,6,500,Dropbox,Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',
        '2112,6,500,fake,',
        '2112,6,500,rekor-server,',
        '22000,6,500,syncthing,',
        '22,6,0,launchd,Software Signing',
        '24678,6,500,node,',
        '2968,6,500,EEventManager,Developer ID Application: Seiko Epson Corporation (TXAEAV5RN4)',
        '33060,6,74,mysqld,Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        '3306,6,500,mariadbd,',
        '3306,6,74,mysqld,Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        '3400,6,500,Sonos,Developer ID Application: Sonos, Inc. (2G4LW83Q3E)',
        '41949,6,500,IPNExtension,Apple Mac OS Application Signing',
        '43398,6,500,IPNExtension,Apple Mac OS Application Signing',
        '443,6,500,com.docker.backend,Developer ID Application: Docker Inc (9BNSXJN65R)',
        '44450,6,500,Linear Helper,Developer ID Application: Linear Orbit, Inc. (7VZ2S3V9RV)',
        '45972,6,500,IPNExtension,Apple Mac OS Application Signing',
        '49152,6,0,AirPlayXPCHelper,Software Signing',
        '49152,6,0,launchd,Software Signing',
        '49152,6,0,remoted,Software Signing',
        '49152,6,0,remotepairingdeviced,Software Signing',
        '49152,6,500,com.docker.backend,Developer ID Application: Docker Inc (9BNSXJN65R)',
        '49152,6,500,GarageBand,Apple Mac OS Application Signing',
        '49152,6,500,IPNExtension,Apple Mac OS Application Signing',
        '49152,6,500,java,Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        '49152,6,500,jetbrains-toolbox,Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        '49152,6,500,LogiMgrDaemon,Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        '49152,6,500,Music,Software Signing',
        '49152,6,500,node,',
        '49152,6,500,rapportd,Software Signing',
        '49152,6,500,Sketch,Developer ID Application: Bohemian Coding (WUGMZZ5K46)',
        '49152,6,500,SketchMirrorHelper,Developer ID Application: Bohemian Coding (WUGMZZ5K46)',
        '49152,6,500,Spotify,Developer ID Application: Spotify (2FNC3A47ZF)',
        '49152,6,500,telepresence,',
        '49152,6,500,vpnkit-bridge,Developer ID Application: Docker Inc (9BNSXJN65R)',
        '49152,6,500,WorkflowAppControl,Developer ID Application: Brother Industries, LTD. (5HCL85FLGW)',
        '5000,6,500,ControlCenter,Software Signing',
        '5060,6,500,CommCenter,Software Signing',
        '546,17,0,configd,Software Signing',
        '5900,6,0,launchd,Software Signing',
        '5900,6,0,screensharingd,Software Signing',
        '6000,6,500,X11.bin,Developer ID Application: Apple Inc. - XQuartz (NA574AWV7E)',
        '631,6,0,cupsd,Software Signing',
        '68,17,0,configd,Software Signing',
        '7000,6,500,ControlCenter,Software Signing',
        '80,6,500,com.docker.backend,Developer ID Application: Docker Inc (9BNSXJN65R)',
        '8770,6,500,sharingd,Software Signing',
        '88,17,0,kdc,Software Signing',
        '8828,6,500,Code Helper,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '8829,6,500,Code Helper,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '8830,6,500,Code Helper,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '8831,6,500,Code Helper,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '8832,6,500,Code Helper,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '8833,6,500,Code Helper,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '8834,6,0,nessusd,Developer ID Application: Tenable, Inc. (4B8J598M7U)',
        '8834,6,500,Code Helper,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '88,6,0,kdc,Software Signing',
        '9101,6,500,github_actions_exporter,'
      )
      AND NOT (
        signature.authority = 'Developer ID Application: Linear Orbit, Inc. (7VZ2S3V9RV)'
        AND lp.port > 1024
      )
      AND NOT (
        signature.authority = 'Developer ID Application: Microsoft Corporation (UBF8T346G9)'
        AND lp.port > 5000
      )
      AND NOT (
        p.path LIKE ',ko-app,%'
        AND lp.port > 1024
        and lp.protocol = 6
      )
      AND NOT (
        p.name IN ('hugo', 'node', 'com.docker.backend', 'kubectl')
        AND lp.port > 1024
        and lp.protocol = 6
      )
      AND NOT (
        p.path LIKE '/private/var/folders/%/go-build%/exe/%'
        AND lp.port > 1024
        AND lp.protocol = 6
      )
      AND NOT (
        p.cwd LIKE '/Users/%/src/%'
        AND p.cmdline LIKE './%'
        AND lp.port > 1024
        AND lp.protocol = 6
      )
    GROUP BY
      exception_key
  description: Unexpected programs listening on a TCP port.
  name: 'Detection - C2: Unexpected Listening Port Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unexpected programs communicating over non-HTTPS protocols (state-based)
    --
    -- This query is a bit awkward and hobbled due to the lack of osquery support
    -- for looking up binary signatures in Linux.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1071/ (C&C, Application Layer Protocol)
    --
    -- tags: transient state net rapid
    -- platform: linux
    SELECT
      s.remote_address,
      p.name,
      p.path,
      p.cmdline AS child_cmd,
      p.cwd,
      pp.path AS parent_path,
      p.parent AS parent_pid,
      pp.cmdline AS parent_cmd,
      s.state,
      hash.sha256,
      -- This intentionally avoids file.path, as it won't join across mount namespaces
      CONCAT (
        MIN(s.remote_port, 32768),
        ',',
        s.protocol,
        ',',
        MIN(p.euid, 500),
        ',',
        REPLACE(
          REPLACE(
            REGEX_MATCH (p.path, '(/.*?)/', 1),
            '/nix',
            '/usr'
          ),
          '/snap',
          '/opt'
        ),
        '/',
        REGEX_MATCH (p.path, '.*/(.*?)$', 1),
        ',',
        MIN(f.uid, 500),
        'u,',
        MIN(f.gid, 500),
        'g,',
        p.name
      ) AS exception_key
    FROM
      process_open_sockets s
      LEFT JOIN processes p ON s.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      protocol > 0
      AND s.remote_port > 0 -- See unexpected-https-client
      AND NOT (
        s.remote_port = 443
        AND protocol IN (6, 17)
      ) -- See unexpected-dns-traffic
      AND NOT (
        s.remote_port = 53
        AND protocol IN (6, 17)
      )
      AND s.remote_address NOT IN (
        '127.0.0.1',
        '::ffff:127.0.0.1',
        '::1',
        '::',
        '0.0.0.0'
      )
      AND s.remote_address NOT LIKE 'fe80:%'
      AND s.remote_address NOT LIKE '127.%'
      AND s.remote_address NOT LIKE '192.168.%'
      AND s.remote_address NOT LIKE '172.1%'
      AND s.remote_address NOT LIKE '172.2%'
      AND s.remote_address NOT LIKE '172.30.%'
      AND s.remote_address NOT LIKE '172.31.%'
      AND s.remote_address NOT LIKE '::ffff:172.%'
      AND s.remote_address NOT LIKE '10.%'
      AND s.remote_address NOT LIKE '::ffff:10.%'
      AND s.remote_address NOT LIKE 'fc00:%'
      AND p.path != ''
      AND NOT exception_key IN (
        '123,17,500,/usr/chronyd,0u,0g,chronyd',
        '143,6,500,/app/thunderbird,u,g,thunderbird',
        '22000,6,500,/usr/syncthing,0u,0g,syncthing',
        '22,6,500,/usr/ssh,0u,0g,ssh',
        '4070,6,500,/opt/spotify,0u,0g,spotify',
        '5228,6,500,/opt/chrome,0u,0g,chrome',
        '5228,6,500,/usr/chrome,0u,0g,chrome',
        '8000,6,500,/opt/chrome,0u,0g,chrome',
        '8000,6,500,/usr/firefox,0u,0g,firefox',
        '80,6,0,/usr/NetworkManager,0u,0g,NetworkManager',
        '80,6,0,/usr/tailscaled,0u,0g,tailscaled',
        '80,6,0,/usr/.tailscaled-wrapped,0u,0g,.tailscaled-wra',
        '80,6,500,/app/thunderbird,u,g,thunderbird',
        '80,6,500,/opt/chrome,0u,0g,chrome',
        '80,6,500,/opt/firefox,0u,0g,firefox',
        '80,6,500,/usr/chrome,0u,0g,chrome',
        '80,6,500,/usr/curl,0u,0g,curl',
        '80,6,500,/usr/firefox,0u,0g,firefox',
        '80,6,500,/usr/firefox,0u,0g,.firefox-wrappe',
        '8080,6,500,/opt/chrome,0u,0g,chrome',
        '8080,6,500,/usr/firefox,0u,0g,firefox',
        '8443,6,500,/opt/chrome,0u,0g,chrome',
        '8443,6,500,/usr/firefox,0u,0g,firefox',
        '993,6,500,/app/thunderbird,u,g,thunderbird'
      )
      AND NOT (
        p.name = 'syncthing'
        AND f.filename = 'syncthing'
        AND s.remote_port > 1024
        AND s.protocol = 6
        AND p.euid > 500
      )
      AND NOT (
        p.name = 'chrome'
        AND f.filename = 'chrome'
        AND s.remote_port > 5000
        AND s.protocol = 6
        AND p.euid > 500
      )
    GROUP BY
      p.cmdline
  description: Unexpected programs communicating over non-HTTPS protocols (state-based)
  name: 'Detection - C2: Unexpected Talkers Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Programs communicating over the network in unexpected ways (state-based)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1071/ (C&C, Application Layer Protocol)
    --
    -- tags: transient state net often
    -- platform: darwin
    SELECT
      protocol,
      s.local_port,
      s.remote_port,
      s.remote_address,
      p.name,
      p.path,
      p.cmdline AS child_cmd,
      p.cwd,
      s.pid,
      p.parent AS parent_pid,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmd,
      hash.sha256,
      CONCAT (
        MIN(s.remote_port, 32768),
        ',',
        protocol,
        ',',
        MIN(p.uid, 500),
        ',',
        p.name,
        ',',
        signature.identifier,
        ',',
        signature.authority
      ) AS exception_key
    FROM
      process_open_sockets s
      LEFT JOIN processes p ON s.pid = p.pid
      LEFT JOIN processes pp ON pp.pid = p.parent
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN signature ON p.path = signature.path
    WHERE
      protocol > 0
      AND s.remote_port > 0
      AND s.remote_address NOT IN ('127.0.0.1', '::ffff:127.0.0.1', '::1')
      AND s.remote_address NOT LIKE 'fe80:%'
      AND s.remote_address NOT LIKE '127.%'
      AND s.remote_address NOT LIKE '192.168.%'
      AND s.remote_address NOT LIKE '172.1%'
      AND s.remote_address NOT LIKE '172.2%'
      AND s.remote_address NOT LIKE '172.30.%'
      AND s.remote_address NOT LIKE '172.31.%'
      AND s.remote_address NOT LIKE '::ffff:172.%'
      AND s.remote_address NOT LIKE '10.%'
      AND s.remote_address NOT LIKE '::ffff:10.%'
      AND s.remote_address NOT LIKE 'fc00:%'
      AND s.state != 'LISTEN' -- Ignore most common application paths
      AND p.path NOT LIKE '/Applications/%.app/Contents/%'
      AND p.path NOT LIKE '/Library/Apple/System/Library/%'
      AND p.path NOT LIKE '/Library/Application Support/%/Contents/%'
      AND p.path NOT LIKE '/System/Applications/%'
      AND p.path NOT LIKE '/System/Library/%'
      AND p.path NOT LIKE '/Users/%/Library/%.app/Contents/MacOS/%'
      AND p.path NOT LIKE '/System/%'
      AND p.path NOT LIKE '/opt/homebrew/Cellar/%/bin/%'
      AND p.path NOT LIKE '/usr/libexec/%'
      AND p.path NOT LIKE '/usr/sbin/%'
      AND p.path NOT LIKE '/private/var/folders/%/go-build%/%'
      AND NOT (
        remote_port = 53
        AND protocol IN (6, 17)
        AND p.name IN (
          '1password',
          'Acrobat Update Helper',
          'chainctl',
          'cloud_sql_proxy',
          'Code Helper',
          'com.apple.MobileSoftwareUpdate.UpdateBrainService',
          'cosign',
          'crc',
          'curl',
          'dig',
          'Evernote Helper',
          'figma_agent',
          'gh',
          'git-remote-http',
          'gitsign',
          'go',
          'grafana-server',
          'grype',
          'host',
          'htop',
          'istioctl',
          'k6',
          'k9s',
          'ko',
          'launcher',
          'ngrok',
          'nix',
          'node',
          'obs',
          'obs-browser-page',
          'obs-ffmpeg-mux',
          'obsidian',
          'opera',
          'ping',
          'Python',
          'python3.10',
          'Reflect',
          'Reflect Helper',
          'ruby',
          'sample',
          'ssh',
          'steam_osx',
          'syncthing',
          'tailscaled',
          'terraform',
          'tkn',
          'traceroute',
          'vcluster',
          'wget',
          'whois',
          'zoom'
        )
      )
      AND NOT exception_key IN (
        '22,6,500,Cyberduck,ch.sudo.cyberduck,Developer ID Application: David Kocher (G69SCX94XU)',
        '22,6,500,ssh,,',
        '22,6,500,ssh,com.apple.openssh,Software Signing',
        '22,6,500,ssh,ssh,',
        '22,6,500,ssh,ssh-55554944fbf65684ab9b37c2bad3a27ef78b23f4,',
        '30004,6,500,java,net.java.openjdk.java,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '30011,6,500,java,net.java.openjdk.java,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '32768,6,500,java,net.java.openjdk.java,Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        '3307,6,500,cloud_sql_proxy,a.out,',
        '43,6,500,DropboxMacUpdate,com.dropbox.DropboxMacUpdate,Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',
        '443,17,500,Code Helper,com.microsoft.VSCode.helper,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '443,17,500,Evernote Helper,com.evernote.Evernote.helper,Apple Mac OS Application Signing',
        '443,17,500,Reflect Helper,app.reflect.ReflectDesktop,Developer ID Application: Reflect App, LLC (789ULN5MZB)',
        '443,17,500,Slack Helper,,',
        '443,6,0,com.apple.MobileSoftwareUpdate.UpdateBrainService,com.apple.MobileSoftwareUpdate.UpdateBrainService,Software Signing',
        '443,6,0,Install,com.adobe.Install,Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        '443,6,0,launcher,launcher,Developer ID Application: Kolide Inc (YZ3EM74M78)',
        '443,6,0,nessusd,nessusd,Developer ID Application: Tenable, Inc. (4B8J598M7U)',
        '443,6,0,nix,nix,',
        '443,6,0,OneDrivePkgTelemetry,com.microsoft.OneDrivePkgTelemetry,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '443,6,0,Setup,com.adobe.acc.Setup,Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        '443,6,500,,,',
        '443,6,500,Acrobat Update Helper,com.adobe.ARMDCHelper,Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        '443,6,500,bash,bash,',
        '443,6,500,chainctl,,',
        '443,6,500,chainctl,a.out,',
        '443,6,500,chainctl,chainctl,',
        '443,6,500,chainctl_Darwin_arm64,a.out,',
        '443,6,500,civo,a.out,',
        '443,6,500,cloud_sql_proxy,a.out,',
        '443,6,500,Code Helper,com.microsoft.VSCode.helper,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '443,6,500,Code Helper (Renderer),com.github.Electron.helper,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '443,6,500,cosign,,',
        '443,6,500,cosign,a.out,',
        '443,6,500,cosign,cosign,',
        '443,6,500,crane,,',
        '443,6,500,crane,a.out,',
        '443,6,500,crane,crane,',
        '443,6,500,ctclient,a.out,',
        '443,6,500,curl,com.apple.curl,Software Signing',
        '443,6,500,darkfiles,a.out,',
        '443,6,500,docker-credential-gcr,a.out,',
        '443,6,500,Electron,com.microsoft.VSCode,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '443,6,500,emacs-28.2,emacs-28.2,',
        '443,6,500,Evernote Helper,com.evernote.Evernote.helper,Apple Mac OS Application Signing',
        '443,6,500,figma_agent,com.figma.agent,Developer ID Application: Figma, Inc. (T8RA8NE3B7)',
        '443,6,500,FlyDelta,com.delta.iphone.ver1,Apple iPhone OS Application Signing',
        '443,6,500,gh,a.out,',
        '443,6,500,gh,gh,',
        '443,6,500,git,com.apple.git,Software Signing',
        '443,6,500,git,git,',
        '443,6,500,GitHub.UI,GitHub,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '443,6,500,GitKraken Boards,com.axosoft.glo,Apple iPhone OS Application Signing',
        '443,6,500,git-remote-http,,',
        '443,6,500,git-remote-http,com.apple.git-remote-http,Software Signing',
        '443,6,500,git-remote-http,git-remote-http-555549448cff17dcad50330caee64c85205e6a99,',
        '443,6,500,git-remote-http,git-remote-http-5555494493930c47f9d9385e94cdee8b19968153,',
        '443,6,500,git-remote-http,git-remote-http-55554944ce011d0e889a3cf58e5ac97ac15728f3,',
        '443,6,500,git-remote-http,git-remote-http-55554944e5dca79a2b44332e941af547708b0c68,',
        '443,6,500,gitsign,,',
        '443,6,500,gitsign,a.out,',
        '443,6,500,gitsign,gitsign,',
        '443,6,500,go,a.out,',
        '443,6,500,go,org.golang.go,Developer ID Application: Google LLC (EQHXZ8M8AV)',
        '443,6,500,grype,grype,',
        '443,6,500,grype,grype,Developer ID Application: ANCHORE, INC. (9MJHKYX5AT)',
        '443,6,500,helm,a.out,',
        '443,6,500,istioctl,a.out,',
        '443,6,500,java,net.java.openjdk.java,Developer ID Application: Eclipse Foundation, Inc. (JCDTMS22B4)',
        '443,6,500,java,net.java.openjdk.java,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '443,6,500,java,net.java.openjdk.java,Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        '443,6,500,ko,a.out,',
        '443,6,500,ksfetch,ksfetch,Developer ID Application: Google LLC (EQHXZ8M8AV)',
        '443,6,500,kubectl,,',
        '443,6,500,kubectl,a.out,',
        '443,6,500,limactl,,',
        '443,6,500,main,a.out,',
        '443,6,500,melange,a.out,',
        '443,6,500,minikube,,',
        '443,6,500,ngrok,darwin_amd64,Developer ID Application: ngrok LLC (TEX8MHRDQ9)',
        '443,6,500,nix,nix,',
        '443,6,500,node,node,Developer ID Application: Node.js Foundation (HX7739G8FX)',
        '443,6,500,OneDriveStandaloneUpdater,com.microsoft.OneDriveStandaloneUpdater,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '443,6,500,prober,a.out,',
        '443,6,500,provisio,,',
        '443,6,500,pulumi-resource-gcp,a.out,',
        '443,6,500,pulumi-resource-github,a.out,',
        '443,6,500,python2.7,python2.7,',
        '443,6,500,python3.10,python3.10,',
        '443,6,500,Python,com.apple.python3,Software Signing',
        '443,6,500,Python,org.python.python,',
        '443,6,500,Python,Python,',
        '443,6,500,Reflect,app.reflect.ReflectDesktop,Developer ID Application: Reflect App, LLC (789ULN5MZB)',
        '443,6,500,Reflect Helper,app.reflect.ReflectDesktop,Developer ID Application: Reflect App, LLC (789ULN5MZB)',
        '443,6,500,sample,com.apple.dt.SamplingTools.sample,Software Signing',
        '443,6,500,scorecard-darwin-amd64,,',
        '443,6,500,Slack Helper,,',
        '443,6,500,Slack Helper,com.tinyspeck.slackmacgap.helper,Apple Mac OS Application Signing',
        '443,6,500,Slack Helper,com.tinyspeck.slackmacgap.helper,Developer ID Application: Slack Technologies, Inc. (BQR82RBBHL)',
        '443,6,500,steam_osx,com.valvesoftware.steam,Developer ID Application: Valve Corporation (MXGJJ98X76)',
        '443,6,500,step,step,',
        '443,6,500,sublime_text,com.sublimetext.4,Developer ID Application: Sublime HQ Pty Ltd (Z6D26JE4Y4)',
        '443,6,500,syft,syft,Developer ID Application: ANCHORE, INC. (9MJHKYX5AT)',
        '443,6,500,terraform-ls,terraform-ls,Developer ID Application: Hashicorp, Inc. (D38WU7D763)',
        '443,6,500,terraform,terraform,Developer ID Application: Hashicorp, Inc. (D38WU7D763)',
        '443,6,500,vegeta,a.out,',
        '443,6,500,vim,vim,',
        '443,6,500,zoom.us,us.zoom.xos,Developer ID Application: Zoom Video Communications, Inc. (BJ4HAAB9B3)',
        '443,6,500,zsh,com.apple.zsh,Software Signing',
        '53,17,500,docker-credential-gcr,a.out,',
        '53,17,500,trivy,,',
        '6000,6,500,ssh,,',
        '6000,6,500,ssh,com.apple.openssh,Software Signing',
        '6000,6,500,ssh,ssh-55554944fbf65684ab9b37c2bad3a27ef78b23f4,',
        '80,6,0,com.apple.MobileSoftwareUpdate.UpdateBrainService,com.apple.MobileSoftwareUpdate.UpdateBrainService,Software Signing',
        '80,6,500,curl,com.apple.curl,Software Signing',
        '80,6,500,ksfetch,ksfetch,Developer ID Application: Google LLC (EQHXZ8M8AV)',
        '80,6,500,steam_osx,com.valvesoftware.steam,Developer ID Application: Valve Corporation (MXGJJ98X76)',
        '80,6,500,webhook.test,a.out,'
      ) -- nix-shell infects children with open connections
      AND NOT (
        parent_cmd LIKE '%/tmp/nix-shell%'
        AND remote_port = 443
        AND protocol = 6
      ) -- These programs would normally never make an outgoing connection, but thanks to Nix, it can happen.
      AND NOT (
        (
          remote_address LIKE '151.101.%'
          OR remote_address LIKE '140.82.%'
          OR remote_address LIKE '199.232.%'
        )
        AND remote_port = 443
        AND protocol = 6
        AND (
          pp.path LIKE '/nix/store/%'
          OR p.path LIKE '/nix/store/%'
        )
      ) -- More complicated patterns go here
      AND NOT (
        p.name = 'syncthing'
        AND (
          remote_port IN (53, 80, 88, 110, 443, 587, 993)
          OR remote_port > 1024
        )
      )
      AND NOT (
        p.name IN (
          'Google Chrome Helper',
          'Brave Browser Helper',
          'Chromium Helper',
          'Opera Helper'
        )
        AND remote_port IN (
          53,
          443,
          80,
          8009,
          8080,
          8888,
          8443,
          5228,
          32211,
          53,
          10001,
          3478,
          19305,
          19306,
          5004,
          9000,
          19307,
          19308,
          19309
        )
      )
      AND NOT (
        p.name IN ('Mail', 'thunderbird', 'Spark', 'Notes')
        AND remote_port IN (53, 143, 443, 587, 465, 585, 993)
      )
      AND NOT (
        parent_path = '/Applications/Minecraft.app/Contents/MacOS/launcher'
        AND remote_port > 30000
      )
      AND NOT (
        p.name IN ('Spotify Helper', 'Spotify')
        AND remote_port IN (53, 443, 8009, 4070, 32211)
      )
      AND NOT (
        remote_port IN (53, 443)
        AND p.name LIKE 'terraform-provider-%'
      )
      AND NOT (
        remote_port IN (53, 443)
        AND p.name LIKE 'kubectl.%'
      )
      AND NOT (
        p.cmdline LIKE '%google-cloud-sdk/lib/gcloud.py%'
        AND remote_port IN (80, 443, 53)
      ) -- Slack update?
      AND NOT (
        p.path = ''
        AND pp.cmdline LIKE '%/Slack'
      ) -- Process name is sometimes empty here?
      AND NOT (
        p.cmdline = '/Applications/Craft.app/Contents/MacOS/Craft'
        AND remote_port = 443
        AND protocol = 6
      )
      AND NOT (
        remote_port IN (53, 443)
        AND p.path LIKE '/private/var/folders/%/T/GoLand/%'
      )
    GROUP BY
      s.pid
  description: Programs communicating over the network in unexpected ways (state-based)
  name: 'Detection - C2: Unexpected Talkers Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Programs which are writing an unusually large amount of data
    --
    -- Can be used to detect ransomware
    --
    -- false positives:
    --   * Package managers
    --   * Backup software
    --
    -- references:
    --   * https://attack.mitre.org/tactics/TA0009/ (Collection)
    --
    -- tags: transient process
    SELECT
      p.name,
      p.path,
      p.pid,
      p.cmdline,
      p.on_disk,
      p.parent,
      p.start_time,
      hash.sha256,
      p.disk_bytes_written,
      p.cwd,
      (strftime('%s', 'now') - start_time) AS age,
      disk_bytes_written / (strftime('%s', 'now') - start_time) AS bytes_per_second
    FROM
      processes p
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      bytes_per_second > 2500000
      AND age > 120
      AND pid > 2
      AND p.path NOT IN (
        '/bin/bash',
        '/opt/homebrew/bin/qemu-system-aarch64',
        '/usr/bin/aptd',
        '/usr/bin/bash',
        '/usr/bin/bwrap',
        '/usr/bin/curl',
        '/usr/bin/dockerd',
        '/usr/bin/fish',
        '/usr/bin/gnome-shell',
        '/usr/bin/make',
        '/usr/bin/melange',
        '/usr/bin/qemu-system-x86_64',
        '/usr/bin/yay',
        '/usr/bin/zsh',
        '/usr/lib64/thunderbird/thunderbird',
        '/usr/libexec/coreduetd',
        '/usr/libexec/flatpak-system-helper',
        '/usr/libexec/packagekitd',
        '/usr/libexec/rosetta/oahd',
        '/usr/libexec/secd',
        '/usr/libexec/sharingd',
        '/usr/lib/flatpak-system-helper',
        '/usr/lib/systemd/systemd',
        '/usr/lib/systemd/systemd-journald',
        '/usr/sbin/screencapture'
      )
      AND NOT (
        name LIKE 'jbd%/dm-%'
        AND on_disk = -1
      )
      AND NOT (
        name = 'bindfs'
        AND cmdline LIKE 'bindfs -f -o fsname=%'
      )
      AND NOT (
        name = 'btrfs-transaction'
        AND on_disk = -1
      )
      AND NOT (
        name = 'kernel_task'
        AND p.path = ''
        AND parent IN (0, 1)
        AND on_disk = -1
      )
      AND NOT (
        name = 'launchd'
        AND p.path = '/sbin/launchd'
        AND parent = 0
      )
      AND NOT (
        name = 'logd'
        AND cmdline = '/usr/libexec/logd'
        AND parent = 1
      )
      AND NOT (
        name = 'aptd'
        AND cmdline = '/usr/bin/python3 /usr/sbin/aptd'
      )
      AND NOT name IN (
        'chrome',
        'com.apple.MobileSoftwareUpdate.UpdateBrainService',
        'containerd',
        'esbuild',
        'firefox',
        'go',
        'grype',
        'goland',
        'java',
        'launcher',
        'gopls',
        'jetbrains-toolb',
        'slack',
        'slack',
        'wineserver'
      )
      AND p.path NOT LIKE '/Applications/%.app/Contents/%'
      AND p.path NOT LIKE '/home/%/.local/share/Steam'
      AND p.path NOT LIKE '/nix/store/%/bin/%sh'
      AND p.path NOT LIKE '/nix/store/%/bin/nix'
      AND p.path NOT LIKE '/System/Applications/%'
      AND p.path NOT LIKE '/System/Library/%'
      AND p.path NOT LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
      AND p.path NOT LIKE '/nix/store/%kolide-launcher-%/bin/launcher'
  description: Programs which are writing an unusually large amount of data
  name: 'Detection - Collection: High Disk Bytes Written'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find database exports. Will need tuning based on your table names.
    --
    -- false positives:
    --   * none observed
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1530/ (Data from Cloud Storage Object )
    --
    -- platform: darwin
    -- tags: persistent filesystem spotlight
    SELECT
      f.path,
      f.size,
      datetime(f.btime, 'unixepoch') AS file_created,
      magic.data
    FROM
      file f
      JOIN mdfind ON mdfind.path = f.path
      LEFT JOIN magic ON f.path = magic.path
    WHERE
      (
        (
          mdfind.query = 'kMDItemFSName == ''*enforce*'' && kMDItemTextContent == ''CREATE TABLE'''
        )
        OR (
          mdfind.query = 'kMDItemFSName == ''*iam*'' && kMDItemTextContent == ''CREATE TABLE'''
        )
        OR (
          mdfind.query = 'kMDItemFSName == ''*tenant*'' && kMDItemTextContent == ''CREATE TABLE'''
        )
      )
      AND f.path NOT LIKE '%.json'
      AND f.path NOT LIKE '%.log'
      AND f.size > 32768
  description: Find database exports. Will need tuning based on your table names.
  name: 'Detection - Collection: Spotlight Database Export Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find root-run processes which link against libpf
    --
    -- WARNING: This check consumes an unusual amount of system memory (up to 225MB)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1205/001/ (Traffic Signaling: Port Knocking)
    --
    -- platform: posix
    -- tags: persistent state process sniffer
    SELECT
      pmm.pid,
      pmm.path AS lib_path,
      p.path,
      p.name,
      p.cmdline,
      p.cwd,
      p.euid,
      p.parent,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.cwd AS parent_cwd,
      pp.euid AS parent_euid,
      hash.sha256 AS child_sha256,
      phash.sha256 AS parent_sha256
    FROM
      process_memory_map pmm
      LEFT JOIN processes p ON pmm.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN hash AS phash ON pp.path = phash.path
    WHERE
      (
        lib_path LIKE '%:bpf%'
        OR lib_path LIKE '%libbpf%'
      )
      AND p.path NOT IN (
        '/usr/bin/qemu-system-x86_64',
        '/usr/lib/systemd/systemd'
      )
      AND p.path NOT LIKE '/nix/store/%/lib/systemd/systemd'
    GROUP BY
      pmm.pid
  description: Find root-run processes which link against libpf
  name: 'Detection - Discovery: Unexpected Bpf User'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find root-run processes which link against libpcap
    --
    -- WARNING: This check consumes an unusual amount of system memory (up to 225MB)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1205/001/ (Traffic Signaling: Port Knocking)
    --
    -- platform: linux
    -- tags: persistent state process sniffer
    SELECT
      pmm.pid,
      p.uid,
      p.gid,
      pmm.path AS lib_path,
      p.path AS child_path,
      p.name AS child_name,
      p.cmdline AS child_cmd,
      p.cwd AS child_cwd,
      h.sha256 AS child_sha256,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmd,
      pp.cwd AS parent_cwd,
      pp.euid AS parent_euid,
      ph.sha256 AS parent_sha256
    FROM
      process_memory_map pmm
      LEFT JOIN processes p ON pmm.pid = p.pid
      LEFT JOIN hash h ON p.path = h.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash AS ph ON pp.path = ph.path
    WHERE
      pmm.path LIKE '%libpcap%'
      AND p.euid = 0
      AND child_path NOT LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
      AND child_path NOT LIKE '/nix/store/%-systemd-%/lib/systemd/systemd%'
      AND child_path NOT LIKE '/nix/store/%-systemd-%/bin/udevadm'
      AND child_path NOT LIKE '/System/Library/%'
      AND child_path NOT LIKE '/nix/store/%/bin/nix'
      AND child_path NOT IN (
        '/usr/libexec/UserEventAgent',
        '/usr/sbin/systemstats',
        '/usr/bin/libvirtd',
        '/usr/sbin/cupsd',
        '/run/current-system/systemd/lib/systemd/systemd'
      )
      AND child_cmd NOT IN (
        '/nix/var/nix/profiles/default/bin/nix-daemon',
        '/run/current-system/systemd/lib/systemd/systemd',
        '/usr/bin/python3 -s /usr/sbin/firewalld --nofork --nopid'
      )
    GROUP BY
      pmm.pid
  description: Find root-run processes which link against libpcap
  name: 'Detection - Discovery: Unexpected Pcap User Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find root-run processes which link against libpcap
    --
    -- WARNING: This check consumes an unusual amount of system memory (up to 225MB)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1205/001/ (Traffic Signaling: Port Knocking)
    --
    -- platform: darwin
    -- tags: persistent state process sniffer
    SELECT
      pmm.pid,
      p.uid,
      p.gid,
      pmm.path AS lib_path,
      p.path AS child_path,
      p.name AS child_name,
      p.cmdline AS child_cmd,
      p.cwd AS child_cwd,
      h.sha256 AS child_sha256,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmd,
      pp.cwd AS parent_cwd,
      pp.euid AS parent_euid,
      ph.sha256 AS parent_sha256,
      s.authority,
      s.identifier
    FROM
      process_memory_map pmm
      LEFT JOIN processes p ON pmm.pid = p.pid
      LEFT JOIN hash h ON p.path = h.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash AS ph ON pp.path = ph.path
      LEFT JOIN signature s ON p.path = s.path
    WHERE
      pmm.path LIKE '%libpcap%'
      AND p.euid = 0 -- These are all protected directories
      AND child_path NOT LIKE '/System/%'
      AND child_path NOT LIKE '/usr/libexec/%'
      AND child_path NOT LIKE '/usr/sbin/%'
      AND child_path NOT LIKE '/usr/bin/%'
      AND child_path NOT LIKE '/nix/store/%/bin/nix'
      AND child_path NOT LIKE '/opt/homebrew/Cellar/vim/%/bin/vim'
      AND child_path NOT LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
      AND NOT s.authority IN (
        'Software Signing',
        'Apple Mac OS Application Signing',
        'Developer ID Application: Kolide Inc (YZ3EM74M78)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)'
      )
    GROUP BY
      pmm.pid
  description: Find root-run processes which link against libpcap
  name: 'Detection - Discovery: Unexpected Pcap User Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Programs which are reading an unusually large amount of data
    --
    -- Can be used to detect exfiltration
    --
    -- false positives:
    --   * Virtual Machine managers
    --   * Backup software
    --
    -- references:
    --   * https://attack.mitre.org/tactics/TA0010/ (Exfiltration)
    --
    -- tags: transient process
    SELECT
      p.name,
      p.path,
      p.cmdline,
      p.on_disk,
      p.parent,
      p.start_time,
      hash.sha256,
      p.disk_bytes_read,
      p.cwd,
      (strftime('%s', 'now') - start_time) AS age,
      disk_bytes_read / (strftime('%s', 'now') - start_time) AS bytes_per_second
    FROM
      processes p
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      bytes_per_second > 2500000
      AND age > 180
      AND p.path NOT LIKE '/Applications/%.app/Contents/%'
      AND p.path NOT LIKE '/System/Library/%'
      AND p.path NOT LIKE '/System/Applications/%'
      AND p.path NOT LIKE '/Library/Apple/System/Library/%'
      AND name NOT IN (
        'bash',
        'bwrap',
        'chrome',
        'emacs',
        'firefox',
        'fish',
        'GoogleSoftwareUpdateAgent',
        'gopls',
        'java',
        'launcher',
        'LogiFacecamService',
        'nautilus',
        'systemd',
        'nessusd',
        'nix',
        'osqueryd',
        'qemu-system-aarch64',
        'qemu-system-x86',
        'qemu-system-x86-64',
        'slack',
        'wineserver',
        'ykman-gui',
        'zsh'
      )
      AND NOT p.path IN (
        '/usr/bin/dockerd',
        '/usr/bin/gnome-shell',
        '/usr/bin/udevadm',
        '/usr/libexec/aned',
        '/usr/libexec/logd',
        '/usr/libexec/packagekitd',
        '/usr/libexec/PerfPowerServices',
        '/usr/libexec/signpost_reporter',
        '/usr/libexec/syspolicyd',
        '/usr/lib/systemd/systemd',
        '/usr/sbin/spindump',
        '/usr/sbin/systemstats'
      )
      AND NOT (
        name = 'bindfs'
        AND cmdline LIKE 'bindfs%-o fsname=%'
      )
      AND NOT (
        name = 'jetbrains-toolb'
        AND p.path LIKE '/tmp/.mount_jet%/jetbrains-toolbox'
      )
      AND NOT (
        name = 'com.apple.MobileSoftwareUpdate.UpdateBrainService'
        AND p.path LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/com.apple.MobileSoftwareUpdate.UpdateBrainService.%.xpc/Contents/MacOS/com.apple.MobileSoftwareUpdate.UpdateBrainService'
      )
      AND NOT (
        name = 'FindMy'
        AND p.path = '/System/Applications/FindMy.app/Contents/MacOS/FindMy'
      )
      AND NOT (
        name = 'go'
        AND cmdline LIKE 'go run %'
      )
      AND NOT (
        name = 'kernel_task'
        AND p.path = ''
        AND parent IN (0, 1)
        AND on_disk = -1
      )
      AND NOT (
        name = 'node'
        AND cwd LIKE '%/console-ui/app'
      )
      AND NOT (
        name = 'ruby'
        AND cmdline LIKE '%brew.rb upgrade'
      )
      AND NOT (
        name = 'terraform-ls'
        AND cmdline LIKE 'terraform-ls serve%'
      )
      AND NOT (p.path LIKE '/home/%/Apps/PhpStorm%/jbr/bin/java')
  description: Programs which are reading an unusually large amount of data
  name: 'Detection - Exfil: High Disk Bytes Read'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Files where the timestamp falls along 12-hour boundaries - probably caused by 'touch <date>0000'
    --
    -- false positives:
    --   * 1 in 43200 chance per binary
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1070/006/ (Indicator Removal on Host: Timestomp)
    --
    -- tags: persistent seldom filesystem
    -- platform: linux
    SELECT
      file.path,
      DATETIME(file.mtime, 'unixepoch', 'localtime') AS mod_time,
      DATETIME(file.atime, 'unixepoch', 'localtime') AS access_time,
      file.inode,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path LIKE "/bin/%%"
        OR file.path LIKE "/etc/%%"
        OR file.path LIKE "/sbin/%%"
        OR file.path LIKE "/lib/%%"
        OR file.path LIKE "/usr/%%"
      )
      -- This timestamp is in UTC
      AND file.mtime > (strftime('%s', 'now') - (86400 * 720))
      AND file.mtime % 3600 = 0
      -- Narrow down to specific offsets in the users local timezone (there should be a better way!)
      AND (
        mod_time LIKE "% 12:00:00"
        OR mod_time LIKE "% 00:00:00"
      )
      -- false positives
      AND file.path NOT IN ('/etc/master.passwd')
      AND file.path NOT LIKE '%/lynis%'
      AND file.path NOT LIKE '%/yelp-xsl%'
  description: Files where the timestamp falls along 12-hour boundaries - probably caused by 'touch <date>0000'
  name: 'Detection - Impact: Evenly Timestomped'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unexpected /etc/hosts entries
    --
    -- false positives:
    --   * developers adding entries for their own use
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1565/001/ (Data Manipulation: Stored Data Manipulation)
    --
    -- tags: persistent seldom filesystem net
    SELECT
      *
    FROM
      etc_hosts
    WHERE
      hostnames NOT IN (
        'localhost',
        'localhost ip6-localhost ip6-loopback',
        'localhost localhost.localdomain localhost4 localhost4.localdomain4',
        'ip6-allnodes',
        'ip6-allrouters',
        'kubernetes'
      )
      AND address NOT IN (
        '127.0.1.1',
        '127.0.0.1',
        '::1',
        'ff02::1',
        'ff02::2',
        '255.255.255.255',
        'fe00::0',
        'ff00::0'
      )
      AND hostnames NOT LIKE 'localhost.%'
      AND hostnames NOT LIKE '%.svc'
      AND hostnames NOT LIKE '%.%-%.%.dev'
      AND hostnames NOT LIKE '%.wtf'
      AND hostnames NOT LIKE '%.test'
      AND hostnames NOT LIKE '%.internal'
      AND hostnames NOT LIKE '%.local'
      AND hostnames NOT LIKE 'ip6-%'
  description: Unexpected /etc/hosts entries
  name: 'Detection - Impact: Unexpected Etc Hosts'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find programs that are sniffing keyboard events on macOS
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1056/001/ (Input Capture: Keylogging)
    --
    -- platform: darwin
    -- tags: persistent state sniffer
    SELECT
      et.enabled,
      et.process_being_tapped,
      et.tapping_process,
      p.path,
      s.authority,
      s.identifier,
      h.sha256,
      CONCAT (
        REPLACE(
          p.path,
          RTRIM(p.path, REPLACE(p.path, '/', '')),
          ''
        ),
        ',',
        identifier,
        ',',
        authority
      ) AS exception_key
    FROM
      event_taps et
      LEFT JOIN processes p ON et.tapping_process = p.pid
      LEFT JOIN signature s ON s.path = p.path
      LEFT JOIN hash h ON h.path = p.path
    WHERE
      event_tapped IN ('EventKeyDown', 'EventKeyUp')
      AND authority != 'Software Signing'
      AND NOT exception_key IN (
        'BetterTouchTool,com.hegenberg.BetterTouchTool,Developer ID Application: folivora.AI GmbH (DAFVSXZ82P)',
        'iTerm2,com.googlecode.iterm2,Developer ID Application: GEORGE NACHMAN (H7V7XYVQ7D)',
        'lghub_agent,com.logi.ghub.agent,Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'logioptionsplus_agent,com.logi.cp-dev-mgr,Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'MonitorControl,me.guillaumeb.MonitorControl,Developer ID Application: Joni Van Roost (CYC8C8R4K9)',
        'skhd,skhd,'
      )
    GROUP BY
      p.path
  description: Find programs that are sniffing keyboard events on macOS
  name: 'Detection - Credentials: Macos Keyboard Sniffer'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Detects unexpected programs opening files in /dev on Linux
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1056/001/ (Input Capture: Keylogging)
    --
    -- false positives:
    --   * any program which needs access to device drivers
    --
    -- platform: linux
    -- tags: persistent state sniffer
    SELECT
      pof.pid,
      pof.path AS device,
      p.path AS program,
      p.name AS program_name,
      p.cmdline AS cmdline,
      hash.sha256,
      CONCAT (
        IIF(
          REGEX_MATCH (
            TRIM(REPLACE(pof.path, ' (deleted)', '')),
            '(/dev/.*)[\d ]+$',
            1
          ) != '',
          REGEX_MATCH (
            TRIM(REPLACE(pof.path, ' (deleted)', '')),
            '(/dev/.*)[\d ]+$',
            1
          ),
          TRIM(REPLACE(pof.path, ' (deleted)', ''))
        ),
        ',',
        REPLACE(
          p.path,
          RTRIM(p.path, REPLACE(p.path, '/', '')),
          ''
        )
      ) AS path_exception,
      CONCAT (
        TRIM(
          REPLACE(
            pof.path,
            CONCAT (
              '/',
              REPLACE(
                pof.path,
                RTRIM(pof.path, REPLACE(pof.path, '/', '')),
                ''
              )
            ),
            ''
          )
        ),
        ',',
        REPLACE(
          p.path,
          RTRIM(p.path, REPLACE(p.path, '/', '')),
          ''
        )
      ) AS dir_exception
    FROM
      process_open_files pof
      LEFT JOIN processes p ON pof.pid = p.pid
      LEFT JOIN hash ON hash.path = p.path
    WHERE
      pof.path LIKE '/dev/%'
      AND pof.path NOT IN (
        '/dev/dri/card0',
        '/dev/dri/card1',
        '/dev/dri/renderD128',
        '/dev/dri/renderD129',
        '/dev/fuse',
        '/dev/io8log',
        '/dev/io8logmt',
        '/dev/io8logtemp',
        '/dev/null',
        '/dev/nvidia-modeset',
        '/dev/nvidia-uvm',
        '/dev/nvidia0',
        '/dev/nvidiactl',
        '/dev/ptmx',
        '/dev/pts/ptmx',
        '/dev/random',
        '/dev/rfkill',
        '/dev/snd/seq',
        '/dev/urandom',
        '/dev/vga_arbiter',
        '/dev/video10' -- workaround for poor regex management (ffmpeg)
      )
      AND pof.path NOT LIKE '/dev/pts/%'
      AND pof.path NOT LIKE '/dev/snd/%'
      AND pof.path NOT LIKE '/dev/tty%'
      AND pof.path NOT LIKE '/dev/hidraw%'
      AND pof.path NOT LIKE '/dev/shm/.com.google.Chrome.%'
      AND pof.path NOT LIKE '/dev/shm/.org.chromium.Chromium.%'
      AND pof.path NOT LIKE '/dev/shm/authentik_%'
      AND NOT dir_exception IN (
        '/dev/bus/usb,pcscd',
        '/dev/input,acpid',
        '/dev/input,gnome-shell',
        '/dev/input,systemd',
        '/dev/input,systemd-logind',
        '/dev/input,thermald',
        '/dev/input,upowerd',
        '/dev/input,Xorg',
        '/dev/kmsg,systemd-coredump',
        '/dev/net,tailscaled',
        '/dev/net,.tailscaled-wrapped',
        '/dev/net/tun,qemu-system-x86_64',
        '/dev/shm,1password',
        '/dev/shm,Brackets',
        '/dev/shm,chrome',
        '/dev/shm,code',
        '/dev/shm,electron',
        '/dev/shm,firefox',
        '/dev/shm,gopls',
        '/dev/shm,java',
        '/dev/shm,jcef_helper',
        '/dev/shm,slack',
        '/dev/shm,spotify',
        '/dev/shm,steam',
        '/dev/shm,steamwebhelper',
        '/dev/shm,wine64-preloader',
        '/dev/shm,winedevice.exe',
        '/dev/snd,alsactl',
        '/dev/snd,pipewire',
        '/dev/snd,pulseaudio',
        '/dev/snd,.pulseaudio-wrapped',
        '/dev/snd,wireplumber',
        '/dev/usb,apcupsd',
        '/dev/usb,upowerd'
      )
      AND NOT path_exception IN (
        '/dev/autofs,systemd',
        '/dev/hidraw,chrome',
        '/dev/input/event,thermald',
        '/dev/input/event,Xorg',
        '/dev/kmsg,kubelet',
        '/dev/kmsg,systemd',
        '/dev/kmsg,systemd-journald',
        '/dev/kvm,qemu-system-x86_64',
        '/dev/mapper/control,dockerd',
        '/dev/mcelog,mcelog',
        '/dev/media0,pipewire',
        '/dev/media0,wireplumber',
        '/dev/media,pipewire',
        '/dev/media,wireplumber',
        '/dev/uhid,bluetoothd',
        '/dev/net/tun,slirp4netns',
        '/dev/tty,agetty',
        '/dev/tty,gdm-wayland-session',
        '/dev/tty,gdm-x-session',
        '/dev/tty,systemd-logind',
        '/dev/tty,Xorg',
        '/dev/uinput,bluetoothd',
        '/dev/usb/hiddev,apcupsd',
        '/dev/usb/hiddev,upowerd',
        '/dev/video0,chrome',
        '/dev/video,chrome',
        '/dev/video,ffmpeg',
        '/dev/video,firefox',
        '/dev/video,obs',
        '/dev/video,obs-ffmpeg-mux',
        '/dev/video,pipewire',
        '/dev/video,vlc',
        '/dev/video,wireplumber',
        '/dev/video,zoom',
        '/dev/zfs,zed',
        '/dev/zfs,zfs',
        '/dev/zfs,zpool'
      )
      AND NOT (
        device LIKE '/dev/bus/usb/%'
        AND program_name IN (
          'fwupd',
          'gphoto2',
          'gvfs-gphoto2-vo',
          'gvfs-gphoto2-volume-monitor',
          'gvfsd-gphoto2',
          'pcscd',
          'streamdeck',
          'usbmuxd'
        )
      )
    GROUP BY
      pof.pid
  description: Detects unexpected programs opening files in /dev on Linux
  name: 'Detection - Credentials: Unexpected Dev Opener Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Detects unexpected programs opening files in /dev on Linux
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1056/001/ (Input Capture: Keylogging)
    --
    -- platform: darwin
    -- tags: persistent state sniffer
    SELECT
      pof.pid,
      pof.path AS device,
      p.path AS program,
      p.name AS program_name,
      p.cmdline AS cmdline,
      hash.sha256,
      s.authority,
      s.identifier,
      CONCAT (
        IIF(
          REGEX_MATCH (pof.path, '(/dev/.*)\d+$', 1) != '',
          REGEX_MATCH (pof.path, '(/dev/.*)\d+', 1),
          pof.path
        ),
        ',',
        REPLACE(
          p.path,
          RTRIM(p.path, REPLACE(p.path, '/', '')),
          ''
        ),
        ',',
        s.authority,
        ',',
        s.identifier
      ) AS exception_key
    FROM
      process_open_files pof
      LEFT JOIN processes p ON pof.pid = p.pid
      LEFT JOIN hash ON hash.path = p.path
      LEFT JOIN signature s ON p.path = s.path
    WHERE
      pof.path LIKE '/dev/%'
      AND pof.path NOT IN (
        '/dev/null',
        '/dev/ptmx',
        '/dev/random',
        '/dev/tty',
        '/dev/urandom'
      )
      AND pof.path NOT LIKE '/dev/ttys%'
      -- Assume SIP
      AND p.path NOT LIKE '/System/%'
      AND p.path NOT LIKE '/usr/libexec/%'
      AND p.path NOT LIKE '/usr/sbin/%'
      AND exception_key NOT IN (
        '/dev/afsc_type,revisiond,Software Signing,com.apple.revisiond',
        '/dev/auditpipe,osqueryd,Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF),osqueryd',
        '/dev/auditsessions,authd,Software Signing,com.apple.authd',
        '/dev/auditsessions,GSSCred,Software Signing,com.apple.GSSCred',
        '/dev/auditsessions,securityd,Software Signing,com.apple.securityd',
        '/dev/auditsessions,TouchBarServer,Software Signing,com.apple.touchbarserver',
        '/dev/autofs,automountd,Software Signing,com.apple.automountd',
        '/dev/bpf,airportd,Software Signing,com.apple.airport.airportd',
        '/dev/console,kernelmanagerd,Software Signing,com.apple.kernelmanagerd',
        '/dev/console,launchd,Software Signing,com.apple.xpc.launchd',
        '/dev/cu.BLTH,bluetoothd,Software Signing,com.apple.bluetoothd',
        '/dev/io8log,airportd,Software Signing,com.apple.airport.airportd',
        '/dev/io8log,ControlCenter,Software Signing,com.apple.controlcenter',
        '/dev/io8logmt,airportd,Software Signing,com.apple.airport.airportd',
        '/dev/io8log,PerfPowerServices,Software Signing,com.apple.PerfPowerServices',
        '/dev/io8log,symptomsd,Software Signing,com.apple.symptomsd',
        '/dev/io8logtemp,airportd,Software Signing,com.apple.airport.airportd',
        '/dev/io8logtemp,ControlCenter,Software Signing,com.apple.controlcenter',
        '/dev/io8logtemp,PerfPowerServices,Software Signing,com.apple.PerfPowerServices',
        '/dev/io8logtemp,symptomsd,Software Signing,com.apple.symptomsd',
        '/dev/io8logtemp,WiFiAgent,Software Signing,com.apple.wifi.WiFiAgent',
        '/dev/io8logtemp,WirelessRadioManagerd,Software Signing,com.apple.WirelessRadioManagerd',
        '/dev/io8log,WiFiAgent,Software Signing,com.apple.wifi.WiFiAgent',
        '/dev/io8log,WirelessRadioManagerd,Software Signing,com.apple.WirelessRadioManagerd',
        '/dev/io,airportd,Software Signing,com.apple.airport.airportd',
        '/dev/io,ControlCenter,Software Signing,com.apple.controlcenter',
        '/dev/io,PerfPowerServices,Software Signing,com.apple.PerfPowerServices',
        '/dev/io,symptomsd,Software Signing,com.apple.symptomsd',
        '/dev/io,WiFiAgent,Software Signing,com.apple.wifi.WiFiAgent',
        '/dev/io,WirelessRadioManagerd,Software Signing,com.apple.WirelessRadioManagerd',
        '/dev/klog,syslogd,Software Signing,com.apple.syslogd',
        '/dev/oslog,logd,Software Signing,com.apple.logd',
        '/dev/xcpm,PerfPowerServices,Software Signing,com.apple.PerfPowerServices',
        '/dev/xcpm,systemstats,Software Signing,com.apple.systemstats',
        '/dev/xcpm,thermald,Software Signing,com.apple.thermald'
      )
    GROUP BY
      pof.pid
  description: Detects unexpected programs opening files in /dev on Linux
  name: 'Detection - Credentials: Unexpected Dev Opener Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unexpected programs accessing sensitive data stores (state-based)
    --
    -- This query is unfortunately of limited use, as the query is slow (250ms)
    -- and it requires catching a program at the exact moment it has
    -- the file open. An event-based version is advised.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1555/ (Credentials from Password Stores)
    --
    -- tags: transient often state file access
    SELECT
      pof.pid,
      pof.fd,
      pof.path,
      f.uid AS file_uid,
      p.cwd AS cwd,
      p.euid,
      p.uid AS process_uid,
      p.name AS program_name,
      p.cmdline AS cmdline,
      pp.name AS parent_name,
      pp.cwd AS parent_cwd,
      pp.path AS parent_path,
      hp.sha256 AS parent_sha256,
      pf.filename AS program_base,
      hash.sha256,
      REPLACE(f.directory, u.directory, '~') AS dir,
      CONCAT (
        pf.filename,
        ',',
        p.name,
        ',',
        IIF(
          REGEX_MATCH (
            REPLACE(f.directory, u.directory, '~'),
            '([/~].*?/.*?/.*?)/',
            1
          ) != '',
          REGEX_MATCH (
            REPLACE(f.directory, u.directory, '~'),
            '([/~].*?/.*?/.*?)/',
            1
          ),
          REPLACE(f.directory, u.directory, '~')
        )
      ) AS exception_key
    FROM
      process_open_files pof
      LEFT JOIN processes p ON pof.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN file f ON pof.path = f.path
      LEFT JOIN file pf ON p.path = pf.path
      LEFT JOIN users u ON p.uid = u.uid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN hash hp ON pp.path = hp.path
    WHERE
      f.uid != ''
      AND pf.filename != ''
      AND (
        pof.path IN ('/var/run/docker.sock')
        OR pof.path LIKE '/home/%/.ssh/%'
        OR pof.path LIKE '/home/%/.mozilla/firefox/%'
        OR pof.path LIKE '/home/%/.config/google-chrome/%'
        OR pof.path LIKE '/root/.ssh/%'
        OR pof.path LIKE '/root/.bash_history'
        OR pof.path LIKE '/home/%/.config/gcloud/%'
        OR pof.path LIKE '/home/%/.config/Slack/%'
        OR pof.path LIKE '/home/%/.bash_history'
        OR pof.path LIKE '/home/%/.cache/mozilla/firefox%'
        OR pof.path LIKE '/home/%/.config/mozilla/firefox%'
        OR pof.path LIKE '/home/%/.aws%'
      )
      AND NOT (
        file_uid == process_uid
        AND exception_key IN (
          'aws,aws,~/.aws',
          'python3,python3,~/.config/gcloud',
          'chrome_crashpad_handler,chrome_crashpad,',
          'chrome_crashpad_handler,chrome_crashpad,~/.config/google-chrome',
          'chrome,chrome,~/.config/google-chrome',
          'firefox,.firefox-wrappe,~/.cache/mozilla',
          'firefox,.firefox-wrappe,~/.mozilla/firefox',
          'firefox,file:// Content,~/.mozilla/firefox',
          'firefox,firefox,~/.cache/mozilla',
          'firefox,firefox,~/.mozilla/firefox',
          'firefox,file:// Content,~/.cache/mozilla',
          'firefox,firefox,~/snap/firefox',
          'firefox,Isolated Servic,~/.cache/mozilla',
          'firefox,Isolated Servic,~/snap/firefox',
          'firefox,Isolated Web Co,~/.cache/mozilla',
          'firefox,Isolated Web Co,~/.mozilla/firefox',
          'firefox,Isolated Web Co,~/snap/firefox',
          'firefox,Privileged Cont,~/.cache/mozilla',
          'firefox,Privileged Cont,~/.mozilla/firefox',
          'firefox,Privileged Cont,~/snap/firefox',
          'firefox,Web Content,~/.cache/mozilla',
          'firefox,Web Content,~/snap/firefox',
          'firefox,WebExtensions,~/.cache/mozilla',
          'firefox,WebExtensions,~/.mozilla/firefox',
          'firefox,WebExtensions,~/snap/firefox',
          'plugin-container,MainThread,~/.mozilla/firefox',
          'slack,slack,~/.config/Slack',
          'slack,slack,~/snap/slack'
        )
      )
    GROUP BY
      pof.pid,
      pof.path
  description: Unexpected programs accessing sensitive data stores (state-based)
  name: 'Detection - Credentials: Unexpected Sensitive File Access Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Detect the execution of a Docker containing mounting the root filesystem
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1611/
    --   * https://github.com/liamg/traitor/blob/main/pkg/exploits/dockersock/exploit.go
    --
    -- This attack is very quick, so the likelihood of finding a culprit is entirely
    -- dependent on the polling time.
    --
    -- platform: linux
    -- tags: transient rapid container escalation
    SELECT
      command,
      image_id,
      path,
      source,
      destination,
      security_options,
      started_at,
      image
    FROM
      docker_container_mounts AS dcm
      LEFT JOIN docker_containers dc ON dcm.id = dc.id
    WHERE
      dcm.source = "/"
  description: Detect the execution of a Docker containing mounting the root filesystem
  name: 'Detection - Privesc: Docker Container Mounting Root'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Detect the execution of a Docker containing mounting the root filesystem
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1611/
    --   * https://github.com/liamg/traitor/blob/main/pkg/exploits/dockersock/exploit.go
    --
    -- This attack is very quick, so the likelihood of finding a culprit is entirely
    -- dependent on the polling time. The number of "tags" you see associated to an image
    -- may reflect the number of times the attack has been attempted.
    --
    -- platform: linux
    -- tags: transient often
    SELECT
      *
    FROM
      docker_image_history
    WHERE
      created > (strftime('%s', 'now') -86400)
      -- This signature is used by Traitor: https://github.com/liamg/traitor/
      AND created_by LIKE '%/bin/sh%/lol%';
  description: Detect the execution of a Docker containing mounting the root filesystem
  name: 'Detection - Privesc: Sketchy Docker Image Creator'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find processes that run with a lower effective UID than their parent (event-based)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1548/001/ (Setuid and Setgid)
    --   * https://cybersecurity.att.com/blogs/labs-research/shikitega-new-stealthy-malware-targeting-linux
    --
    -- related:
    --   * unexpected-privilege-escalation.sql
    --
    -- tags: events process escalation
    -- platform: posix
    -- interval: 30
    SELECT
      p.pid AS child_pid,
      p.path AS child_path,
      REGEX_MATCH (RTRIM(file.path, '/'), '.*/(.*?)$', 1) AS child_name,
      p.cmdline AS child_cmdline,
      p.euid AS child_euid,
      file.mode AS child_mode,
      hash.sha256 AS child_hash,
      p.parent AS parent_pid,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.euid AS parent_euid,
      pfile.mode AS parent_mode,
      hash.sha256 AS parent_hash
    FROM
      process_events p
      JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN file ON p.path = file.path
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN file AS pfile ON pp.path = pfile.path
      LEFT JOIN hash AS phash ON pp.path = phash.path
    WHERE
      p.time > (strftime('%s', 'now') -30)
      AND p.euid < pp.euid
      AND p.path NOT IN (
        '/usr/bin/fusermount',
        '/usr/bin/fusermount3',
        '/usr/bin/login',
        '/usr/bin/sudo',
        '/usr/bin/doas',
        '/bin/ps',
        '/usr/bin/top'
      )
      AND p.path NOT LIKE '/nix/store/%/bin/sudo'
      AND p.path NOT LIKE '/nix/store/%/bin/dhcpcd'
      AND NOT (
        child_name = 'polkit-agent-helper-1'
        AND parent_path = '/usr/bin/gnome-shell'
      )
      AND NOT (
        child_name = 'fusermount3'
        AND parent_path = '/usr/lib/xdg-document-portal'
      )
  description: Find processes that run with a lower effective UID than their parent (event-based)
  name: 'Detection - Privesc: Unexpected Privilege Escalation Events'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find processes that run with a lower effective UID than their parent (state-based)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1548/001/ (Setuid and Setgid)
    --   * https://cybersecurity.att.com/blogs/labs-research/shikitega-new-stealthy-malware-targeting-linux
    --
    -- related:
    --   * unexpected-privilege-escalation-events.sql
    --
    -- tags: transient rapid state process escalation
    -- platform: posix
    SELECT
      p.pid AS child_pid,
      p.path AS child_path,
      p.name AS child_name,
      p.cmdline AS child_cmdline,
      p.euid AS child_euid,
      p.state AS child_state,
      file.mode AS child_mode,
      hash.sha256 AS child_hash,
      p.parent AS parent_pid,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.euid AS parent_euid,
      pfile.mode AS parent_mode,
      hash.sha256 AS parent_hash
    FROM
      processes p
      JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN file ON p.path = file.path
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN file AS pfile ON pp.path = pfile.path
      LEFT JOIN hash AS phash ON pp.path = phash.path
    WHERE
      p.euid < pp.euid
      AND p.path NOT IN (
        '/usr/bin/fusermount',
        '/usr/bin/fusermount3',
        '/usr/bin/login',
        '/usr/bin/sudo',
        '/usr/bin/doas',
        '/bin/ps',
        '/usr/bin/top'
      )
      AND p.path NOT LIKE '/nix/store/%/bin/sudo'
      AND p.path NOT LIKE '/nix/store/%/bin/dhcpcd'
      AND NOT (
        p.name = 'polkit-agent-he'
        AND parent_path = '/usr/bin/gnome-shell'
      )
      AND NOT (
        p.name = 'fusermount3'
        AND parent_path = '/usr/lib/xdg-document-portal'
      )
  description: Find processes that run with a lower effective UID than their parent (state-based)
  name: 'Detection - Privesc: Unexpected Privilege Escalation'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Detect the execution of priveleged Docker containers which can be used to escape to the host.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1611/
    --
    -- false-positives:
    --   * Nested Kubernetes Environments
    --   * Containerized builds
    --
    -- This query works on macOS as well, but is only an in-the-wild security problem on Linux,
    -- where the kernel namespaces can be shared. These kind of attacks tend to be
    --
    -- platform: linux
    -- tags: transient state container escalation
    SELECT
      command,
      image_id,
      path,
      security_options,
      started_at,
      image
    FROM
      docker_containers
    WHERE
      privileged = 1
      AND image NOT LIKE 'kindest/node:%'
      AND image NOT LIKE 'ghcr.io/k3d-io/k3d-%'
      AND image NOT LIKE 'docker.io/rancher/k3s:%'
      -- this one makes me sad. It's due to limitations running bubblewrap in a container
      AND image NOT IN ('cgr.dev/chainguard/melange', 'wolfi:test');
  description: Detect the execution of priveleged Docker containers which can be used to escape to the host.
  name: 'Detection - Privesc: Unexpected Privileged Containers'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Processes running that originate from setuid/setgid programs
    --
    -- false-positives:
    --   * an unlisted setuid binary
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1548/001/ (Setuid and Setgid)
    --
    -- tags: persistent state process escalation
    -- platform: posix
    SELECT
      p.pid,
      p.name,
      p.path,
      p.cmdline,
      f.ctime,
      p.cwd,
      p.uid,
      f.mode,
      hash.sha256
    FROM
      processes p
      JOIN file f ON p.path = f.path
      JOIN hash ON p.path = hash.path
    WHERE
      f.mode NOT LIKE '0%'
      AND f.path NOT IN (
        '/bin/ps',
        '/Library/DropboxHelperTools/Dropbox_u501/dbkextd',
        '/opt/1Password/1Password-BrowserSupport',
        '/opt/1Password/1Password-KeyringHelper',
        '/usr/bin/doas',
        '/usr/lib/xf86-video-intel-backlight-helper',
        '/usr/bin/mount',
        '/usr/bin/fusermount',
        '/usr/bin/fusermount3',
        '/usr/sbin/traceroute',
        '/usr/bin/login',
        '/usr/bin/ssh-agent',
        '/usr/bin/su',
        '/Applications/Parallels Desktop.app/Contents/MacOS/Parallels Service',
        '/usr/bin/sudo',
        '/usr/bin/top',
        '/usr/lib/Xorg.wrap'
      );
  description: Processes running that originate from setuid/setgid programs
  name: 'Detection - Privesc: Unexpected Setxid Process'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Surface ISO/DMG disk images that were downloaded from unexpected places
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1566/001/ (Phishing: Spearphishing Attachment)
    --   * https://attack.mitre.org/techniques/T1204/002/ (User Execution: Malicious File)
    --   * https://unit42.paloaltonetworks.com/chromeloader-malware/
    --
    -- false positives:
    --   * disk images downloaded from a location not in the exception list
    --
    -- platform: darwin
    -- tags: persistent filesystem spotlight
    SELECT
      file.path,
      file.size,
      datetime(file.btime, 'unixepoch') AS file_created,
      magic.data,
      ea.value AS url,
      REGEX_MATCH (ea.value, '/[\w_-]+\.([\w\._-]+)[:/]', 1) AS domain,
      REGEX_MATCH (ea.value, '/([\w_-]+\.[\w\._-]+)[:/]', 1) AS host
    FROM
      mdfind
      LEFT JOIN file ON mdfind.path = file.path
      LEFT JOIN extended_attributes ea ON mdfind.path = ea.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        mdfind.query = "kMDItemWhereFroms != '' && kMDItemFSName == '*.iso'"
        OR mdfind.query = "kMDItemWhereFroms != '' && kMDItemFSName == '*.dmg'"
      )
      AND ea.key = 'where_from'
      AND file.btime > (strftime('%s', 'now') -86400)
      AND domain NOT IN (
        'adobe.com',
        'alfredapp.com',
        'android.com',
        'apple.com',
        'download.prss.microsoft.com',
        'arc.net',
        'balsamiq.com',
        'brave.com',
        'digidesign.com',
        'digidesign.com',
        'gaomon.net',
        'epson.com',
        'fcix.net',
        'xtom.com',
        'gaomon.net',
        'oracle.com',
        'akmedia.digidesign.com',
        'canon.co.uk',
        'cdn.mozilla.net',
        'charlesproxy.com',
        'csclub.uwaterloo.ca',
        'docker.com',
        'duckduckgo.com',
        'eclipse.org',
        'gimp.org',
        'github.io',
        'githubusercontent.com',
        'grammarly.com',
        'integodownload.com',
        'jetbrains.com',
        'libreoffice.org',
        'loom.com',
        'microsoft.com',
        'minecraft.net',
        'mirrorservice.org',
        'mojang.com',
        'mozilla.org',
        'mysql.com',
        'ocf.berkeley.edu',
        'oobesaas.adobe.com',
        'osuosl.org',
        'pqrs.org',
        'steampowered.com',
        'c-wss.com',
        'irccloud.com',
        'discordapp.net',
        'getutm.app',
        'dogado.de',
        'vc.logitech.com',
        'steampowered.com',
        'discord.com',
        'logitech.com',
        'skype.com',
        'remarkable.com',
        'balena.io',
        'signal.org',
        'prusa3d.com',
        'google.ca',
        'zsa.io',
        'slack-edge.com',
        'tableplus.com',
        'ubuntu.com',
        'umd.edu',
        'virtualbox.org',
        'warp.dev',
        'webex.com'
      )
      AND host NOT IN (
        'dl.google.com',
        'www.google.com',
        'warp-releases.storage.googleapis.com',
        'mail.google.com',
        'github.com',
        'ubuntu.com',
        'balsamiq.com',
        'tableplus.com',
        'discord.com',
        'dl.discordapp.net',
        'obsproject.com',
        'www.messenger.com',
        'brave.com',
        'emacsformacosx.com',
        'store.steampowered.com',
        'wavebox.io',
        'manual.canon',
        'dygma.com',
        'duckduckgo.com',
        'obsidian.md'
      )
      -- Yes, these are meant to be fairly broad.
      AND host NOT LIKE 'download%'
      AND host NOT LIKE 'cdn%'
      AND host NOT LIKE '%.edu'
      AND host NOT LIKE 'github-production-release-asset-%.s3.amazonaws.com'
      AND host NOT LIKE '%.org'
      AND host NOT LIKE 'dl.%'
      AND host NOT LIKE 'dl-%'
      AND host NOT LIKE 'mirror%'
      AND host NOT LIKE 'driver.%'
      AND host NOT LIKE 'support%'
      AND host NOT LIKE 'software%'
      AND host NOT LIKE 'www.google.%'
      AND host NOT LIKE '%release%.storage.googleapis.com'
      AND NOT (
        host LIKE '%.fbcdn.net'
        AND file.filename LIKE 'Messenger.%.dmg'
      )
    GROUP BY
      ea.value
  description: Surface ISO/DMG disk images that were downloaded from unexpected places
  name: 'Detection - Initial_Access: Unexpected Diskimage Source Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unexpected process that spawns shell processes
    --
    -- false positives:
    --   * IDE's
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1059/ (Command and Scripting Interpreter)
    --   * https://attack.mitre.org/techniques/T1204/002/ (User Execution: Malicious File)
    --
    -- tags: transient process state
    -- platform: posix
    SELECT
      p.name,
      p.path AS path,
      p.cmdline AS cmd,
      p.pid,
      p.parent,
      pp.name AS parent_name,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmd,
      hash.sha256 AS parent_sha256
    FROM
      processes p
      LEFT JOIN processes pp ON pp.pid = p.parent
      LEFT JOIN hash ON pp.path = hash.path
    WHERE
      p.name IN ('sh', 'fish', 'zsh', 'bash', 'dash', 'osascript')
      -- Ignore partial table joins
      AND parent_path != ''
      -- Editors & terminals mostly.
      -- I know it's tempting to list "electron" here but please find a more specific exclusion.
      AND pp.name NOT IN (
        'abrt-handle-eve',
        'alacritty',
        'bash',
        'build-script-build',
        'chezmoi',
        'clang-11',
        'Code Helper (Renderer)',
        'Code - Insiders Helper (Renderer)',
        'collect2',
        'conmon',
        'containerd-shim',
        'dash',
        'demoit',
        'direnv',
        'doas',
        'find',
        'FinderSyncExtension',
        'fish',
        'go',
        'goland',
        'helm',
        'java',
        'ko',
        'kubectl',
        'make',
        'monorail',
        'nix',
        'nix-build',
        'nix-daemon',
        'node',
        'nvim',
        'package_script_service',
        'perl',
        'PK-Backend',
        'python',
        'roxterm',
        'sdzoomplugin',
        'sh',
        'skhd',
        'sshd',
        'swift',
        'systemd',
        'terminator',
        'test2json',
        'tmux',
        'tmux:server',
        'vi',
        'vim',
        'watch',
        'wezterm-gui',
        'xargs',
        'xcrun',
        'xfce4-terminal',
        'yum',
        'zsh'
      )
      AND parent_path NOT IN (
        '/Applications/Docker.app/Contents/MacOS/Docker',
        '/bin/dash',
        '/bin/sh',
        '/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers/GoogleSoftwareUpdateDaemon',
        '/opt/X11/libexec/launchd_startx',
        '/sbin/launchd',
        '/usr/lib/xorg/Xorg',
        '/usr/bin/alacritty',
        '/usr/bin/apt-get',
        '/usr/bin/bash',
        '/usr/bin/bwrap',
        '/usr/bin/sysdiagnose',
        '/usr/bin/crond',
        '/usr/bin/login',
        '/Applications/IntelliJ IDEA.app/Contents/MacOS/idea',
        '/Applications/Docker.app/Contents/Resources/bin/com.docker.cli',
        '/usr/bin/man',
        '/usr/bin/sudo',
        '/usr/bin/xargs',
        '/usr/bin/zsh',
        '/usr/libexec/gnome-terminal-server',
        '/usr/libexec/periodic-wrapper',
        '/usr/bin/su'
      )
      -- npm run server
      AND NOT p.cmdline IN (
        'sh -c -- exec-bin node_modules/.bin/hugo/hugo server',
        'sh -c xcode-select --print-path >/dev/null 2>&1 && xcrun --sdk macosx --show-sdk-path 2>/dev/null'
      )
      AND NOT (
        pp.name = 'sshd'
        AND p.cmdline LIKE '%askpass%'
      )
      AND NOT (
        pp.name = 'bash'
        AND p.cmdline LIKE 'sh -s _hostname %'
      )
      AND NOT (
        pp.cmdline LIKE 'perl%/help2man%'
        AND p.cmdline LIKE 'sh -c man/%'
      )
      AND NOT p.cmdline LIKE '%/Library/Apple/System/Library/InstallerSandboxes%'
      AND NOT p.cmdline LIKE '%gcloud config config-helper%'
      AND NOT pp.cmdline LIKE '/Applications/Warp.app/%'
      AND NOT pp.cmdline LIKE '%brew.rb%'
      AND NOT pp.cmdline LIKE '%/Homebrew/build.rb%'
      AND NOT pp.cmdline LIKE '%Code Helper%'
      AND NOT pp.cmdline LIKE '%gcloud.py config config-helper%'
      AND NOT pp.cmdline LIKE '/usr/lib/electron19/electron /usr/lib/code/out/bootstrap-fork --type=ptyHost --logsPath /home/%/.config/Code - OSS/logs/%'
      AND NOT pp.name LIKE '%term%'
      AND NOT pp.name LIKE '%Term%'
      AND NOT pp.name LIKE 'Emacs%'
      AND NOT pp.name LIKE 'terraform-provider-%'
      AND NOT pp.path LIKE '/Users/%/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers/GoogleSoftwareUpdateAgent.app/Contents/MacOS/GoogleSoftwareUpdateAgent'
      -- Oh, NixOS.
      AND NOT pp.name LIKE '%/bin/bash'
      AND NOT pp.name LIKE '%/bin/direnv'
      AND NOT parent_path LIKE '/nix/store/%sh'
      AND NOT parent_path LIKE '/opt/homebrew/%'
  description: Unexpected process that spawns shell processes
  name: 'Detection - Initial_Access: Unexpected Shell Parents'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Scan removable volumes for sketchy files
    --
    -- false positives:
    --   * Installer packages with hidden files
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1566/001/ (Phishing: Spearphishing Attachment)
    --   * https://attack.mitre.org/techniques/T1204/002/ (User Execution: Malicious File)
    --   * https://www.crowdstrike.com/blog/how-crowdstrike-uncovered-a-new-macos-browser-hijacking-campaign/
    --
    -- tags: transient volume filesystem seldom
    -- platform: darwin
    SELECT
      RTRIM(file.path, '/') AS trimpath,
      uid,
      filename,
      gid,
      mode,
      REGEX_MATCH (file.path, '(.*)/', 1) AS dirname,
      REGEX_MATCH (RTRIM(file.path, '/'), '.*/(.*?)$', 1) AS basename,
      REGEX_MATCH (RTRIM(file.path, '/'), '.*\.(.*?)$', 1) AS extension,
      mtime,
      ctime,
      symlink,
      type,
      size,
      hash.sha256,
      magic.data,
      signature.identifier,
      signature.authority
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN signature ON file.path = signature.path
    WHERE
      (
        file.path LIKE '/Volumes/%/%'
        OR file.path LIKE '/Volumes/%/.%'
      )
      AND file.path NOT LIKE '/Volumes/Macintosh HD%'
      AND file.path NOT LIKE '/Volumes/%/.com.apple.timemachine%'
      AND (
        extension IN (
          'command',
          'lnk',
          'mpkg',
          -- Enable later once we know this query works well
          --             'pkg',
          'scpt',
          'dmg',
          'iso',
          'gz',
          'sh',
          'sql'
        )
        OR file.symlink != 0
        OR basename LIKE '.%'
        OR basename LIKE '%.sql%'
        OR basename LIKE '%Chrome%'
        OR basename LIKE '%Extension%'
        OR basename LIKE '%enforce%'
        OR basename LIKE '%hidden%'
        OR basename LIKE '%Installer%'
        OR basename LIKE '%mono%'
        OR basename LIKE '%secret%'
        OR basename LIKE '%sql%'
        OR basename LIKE '%guard%'
        OR basename LIKE 'cg%'
      ) -- exceptions go here
      AND basename NOT IN (
        '..',
        '.',
        '.background',
        '.disk_label_2x',
        '.disk_label',
        '.DS_Store',
        '.iotest',
        '.file-revisions-by-id',
        '.file',
        '.metadata_never_index_unless_rootfs',
        '.shortcut-targets-by-id',
        '.TemporaryItems',
        '.Trashes',
        '._Id.txt',
        '.vol',
        '.apdisk',
        '._.Trashes',
        '._.TemporaryItems',
        '._.apdisk',
        '.VolumeIcon.icns'
      )
      AND authority NOT IN (
        'Developer ID Application: Google LLC (EQHXZ8M8AV)'
      ) -- Unsigned programs here
      AND trimpath NOT IN (
        '/Volumes/Google Chrome/.keystone_install',
        '/Volumes/Google Chrome Canary/.keystone_install',
        '/Volumes/Jabra Direct Setup/JabraDirectSetup.pkg'
      )
  description: Scan removable volumes for sketchy files
  name: 'Detection - Initial_Access: Unexpected Volume Contents'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Surface webmail downloads of an unexpected sort
    --
    -- false positives:
    --   * Files without an extension or extensions not explicitly added to the allow list
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1566/001/ (Phishing: Spearphishing Attachment)
    --
    -- platform: darwin
    -- tags: persistent filesystem spotlight
    SELECT
      file.path,
      file.size,
      datetime(file.btime, 'unixepoch') AS file_created,
      magic.data,
      hash.sha256,
      LOWER(
        REGEX_MATCH (RTRIM(file.path, '/'), '.*\.(.*?)$', 1)
      ) AS extension
    FROM
      mdfind
      LEFT JOIN file ON mdfind.path = file.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN hash ON file.path = hash.path
    WHERE
      mdfind.query = 'kMDItemWhereFroms == ''*https://mail.google.com/*'''
      AND file.btime > (strftime('%s', 'now') -86400)
      -- Extensions that would not normally raise suspicion if sent by e-mail (excludes dmg, iso, lnk, exe)
      AND extension NOT IN (
        'bz2',
        'cer',
        'csv',
        'doc',
        'docx',
        'eml',
        'gif',
        'gz',
        'htm',
        'html',
        'icloud',
        'jpeg',
        'jpg',
        'mov',
        'mp3',
        'mp4',
        'mpeg',
        'mpg',
        'ods',
        'odt',
        'pdf',
        'pem',
        'pgp',
        'png',
        'ppt',
        'pptx',
        'pub',
        'tar',
        'tif',
        'tiff',
        'txt',
        'wav',
        'xls',
        'xlsm',
        'xlsx',
        'zip',
        'zstd'
      )
  description: Surface webmail downloads of an unexpected sort
  name: 'Detection - Initial_Access: Unexpected Webmail Downloads'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find programs which have cleared their environment
    --
    -- references:
    --   * https://www.sandflysecurity.com/blog/bpfdoor-an-evasive-linux-backdoor-technical-analysis/
    --
    -- tags: persistent state daemon process
    SELECT
      COUNT(*) AS count,
      p.pid,
      p.path,
      p.cmdline
    FROM
      process_envs pe
      JOIN processes p ON pe.pid = p.pid
    GROUP BY
      p.pid
    HAVING
      count == 0;
  description: Find programs which have cleared their environment
  name: 'Detection - Evasion: Empty Environ'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Programs which claim to be from the future, based on (btime,ctime,mtime)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1070/006/ (Indicator Removal on Host: Timestomp)
    --
    -- false positives:
    --   * None observed
    --
    -- tags: persistent state process
    SELECT
      p.pid,
      p.path,
      p.name,
      p.cmdline,
      p.cwd,
      p.euid,
      p.parent,
      f.ctime,
      f.btime,
      f.mtime,
      p.start_time,
      f.mtime > strftime('%s', 'now') AS mtime_newer,
      f.ctime > strftime('%s', 'now') AS ctime_newer,
      f.btime > strftime('%s', 'now') AS btime_newer,
      hash.sha256 AS child_hash256,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmd,
      pp.cwd AS parent_cwd,
      hash.sha256 AS parent_sha256
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      mtime_newer == 1
      OR ctime_newer == 1
      OR btime_newer == 1
  description: Programs which claim to be from the future, based on (btime,ctime,mtime)
  name: 'Detection - Evasion: Executables From The Future'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Programs running with a hidden current working directory
    --
    -- false positives:
    --   * Users rummaging through their configuration files
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1564/001/ (Hide Artifacts: Hidden Files and Directories)
    --
    -- tags: transient often
    -- platform: posix
    SELECT
      p.pid,
      p.path,
      p.name,
      p.cmdline,
      p.cwd,
      p.euid,
      p.parent,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.cwd AS parent_cwd,
      pp.euid AS parent_euid,
      hash.sha256,
      REPLACE(p.cwd, u.directory, '~') AS dir,
      CONCAT (
        p.name,
        ',',
        IIF(
          REGEX_MATCH (
            REPLACE(p.cwd, u.directory, '~'),
            '([/~].*?/.*?/.*?)/',
            1
          ) != '',
          REGEX_MATCH (
            REPLACE(p.cwd, u.directory, '~'),
            '([/~].*?/.*?/.*?)/',
            1
          ),
          REPLACE(p.cwd, u.directory, '~')
        )
      ) AS exception_key
    FROM
      processes p
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN users u ON p.uid = u.uid
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      dir LIKE '%/.%'
      AND NOT (
        exception_key IN (
          'bash,~/.local/share',
          'bash,~/go/src',
          'Electron,~/.vscode/extensions',
          'fish,~/.local/share',
          'git,~/.local/share',
          'makepkg,~/.cache/yay',
          'zsh,~/.Trash',
          'bash,~/.Trash',
          'fish,~/.Trash',
          'make,~/.cache/yay',
          'java,~/.gradle/daemon',
          'java,~/.local/share',
          'rust-analyzer-p,~/.cargo/registry',
          'as,~/.cache/yay',
          'c++,~/.cache/yay',
          'cc1plus,~/.cache/yay',
          'npm install,~/.npm/_cacache',
          'mysqld,~/.local/share'
        )
        OR dir IN (
          '~/.vim',
          '~/.cache/yay',
          '~/.local/share/chezmoi',
          '~/.local/share/nvim',
          '~/.gmailctl'
        )
        OR p.name IN (
          'bindfs',
          'vim',
          'nvim',
          'code',
          'updatedb',
          'git',
          'gitsign',
          'Code Helper'
        )
        OR dir LIKE '~/.dotfiles/%'
        OR dir LIKE '~/.gradle/%'
        OR dir LIKE "~/%/.terraform%"
        OR dir LIKE '~/.local/share/kotlin/%'
        OR dir LIKE '~/go/src/%'
        OR dir LIKE '~/.local/share/nvim/%'
        OR dir LIKE '~/.vscode/extensions/%'
        OR dir LIKE '~/.local/share/fish/%'
        OR dir LIKE '~/.cache/yay/%'
        OR dir LIKE '/Library/Apple/System/Library/InstallerSandboxes/.PKInstallSandboxManager-SystemSoftware/%'
        OR dir LIKE '~/src/%'
        OR dir LIKE '~/%/.github%'
        OR dir LIKE '~/.cargo/%'
        OR dir LIKE '~/.provisio%'
        OR dir LIKE '~/.local/share/JetBrains/%'
        OR dir LIKE '~/code/%'
      )
  description: Programs running with a hidden current working directory
  name: 'Detection - Evasion: Hidden Cwd'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Reveal launchd services which are located in a hidden directory.
    --
    -- This query was written because osquery can't see these entries currently.
    -- See https://github.com/osquery/osquery/issues/7703
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1543/004/ (Create or Modify System Process: Launch Daemon)
    --   * https://attack.mitre.org/techniques/T1564/001/ (Hide Artifacts: Hidden Files and Directories)
    --
    -- platform: darwin
    -- tags: persistent daemon
    SELECT
      file.path,
      file.type,
      file.filename,
      file.size,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      signature.identifier,
      signature.authority
    FROM
      file
      LEFT JOIN signature ON file.path = signature.path
      LEFT JOIN hash ON file.path = hash.path
    WHERE
      (
        file.path LIKE '/Library/LaunchAgents/.%'
        OR file.path LIKE '/Users/%/Library/LaunchAgents/.%'
        OR file.path LIKE '/Users/%/Library/LaunchDaemons/.%'
      )
      AND file.filename NOT IN ('.', '..', '.DS_Store')
      AND NOT (
        file.filename = '.DS_Store'
        AND hash.sha256 = 'd65165279105ca6773180500688df4bdc69a2c7b771752f0a46ef120b7fd8ec3'
      )
  description: Reveal launchd services which are located in a hidden directory.
  name: 'Detection - Evasion: Hidden Launchd Files Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Works well for revealing boopkit, so long as boopkit has a child process.
    --
    -- references:
    --   * https://github.com/krisnova/boopkit
    --   * https://attack.mitre.org/techniques/T1014/ (Rootkit)
    --
    -- false positives:
    --   * None observed
    --
    -- tags: persistent daemon
    SELECT
      pp.*
    FROM
      processes
      JOIN processes pp ON processes.parent = pp.pid
    WHERE
      processes.parent NOT IN (
        SELECT
          pid
        FROM
          processes
      )
      AND processes.parent != 0;
  description: Works well for revealing boopkit, so long as boopkit has a child process.
  name: 'Detection - Evasion: Hidden Parent Pid'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Processes that do not exist on disk, running in osquery's namespace
    --
    -- false positives:
    --   * none observed
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1070/004/ (Indicator Removal on Host: File Deletion)
    --
    -- tags: persistent process state
    -- platform: linux
    SELECT
      p.pid,
      p.euid,
      p.cmdline,
      p.path,
      mnt_namespace,
      p.cwd,
      p.on_disk,
      p.state,
      file.inode,
      pp.on_disk AS parent_on_disk,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmdline,
      pp.cwd AS parent_cwd,
      ph.sha256 AS parent_sha256
    FROM
      processes p
      LEFT JOIN file ON p.path = file.path
      LEFT JOIN process_namespaces ON p.pid = process_namespaces.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ph ON pp.path = ph.path
    WHERE
      p.on_disk != 1
      AND p.path != ''
      -- use osquery as the reference mount namespace
      AND mnt_namespace IN (
        SELECT DISTINCT
          (mnt_namespace)
        FROM
          process_namespaces
          JOIN processes ON processes.pid = process_namespaces.pid
        WHERE
          processes.name IN ('osqueryi', 'osqueryd')
      )
      -- This is truly a missing program, not just one that has been updated with a new binary.
      AND file.inode IS NULL
      -- Snap packages?
      AND p.path NOT LIKE '/tmp/.mount_%'
  description: Processes that do not exist on disk, running in osquery's namespace
  name: 'Detection - Evasion: Missing From Disk Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Processes that do not exist on disk
    --
    -- false positives:
    --   * Self-updating programs that remain running
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1070/004/ (Indicator Removal on Host: File Deletion)
    --
    -- platform: darwin
    -- tags: persistent process state
    SELECT
      p.pid,
      p.path,
      p.name,
      p.parent,
      p.state,
      p.cwd,
      p.gid,
      p.uid,
      p.euid,
      p.cmdline AS cmd,
      p.cwd,
      p.on_disk,
      p.state,
      pp.on_disk AS parent_on_disk,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmd,
      pp.cwd AS parent_cwd,
      hash.sha256 AS parent_sha256
    FROM
      processes p
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON pp.path = hash.path
    WHERE
      p.on_disk != 1 -- false positives from recently spawned processes
      AND (strftime('%s', 'now') - p.start_time) > 15
      AND p.pid > 0
      AND p.parent != 2 -- kthreadd
      AND p.state != 'Z' -- The kernel no longer has enough tracking information for this alert to be useful
      AND NOT (
        p.parent = 1
        AND p.path = ''
      )
      AND NOT (
        p.gid = 20
        AND (
          -- NOTE: p.path is typically empty when on_disk != 1, so don't depend on it.
          cmd LIKE '/Library/Apple/System/%'
          OR cmd LIKE '/Applications/%/Contents/%'
          OR cmd LIKE '/Library/Apple/System/%'
          OR cmd LIKE '/Library/Application Support/Logitech.localized/%'
          OR cmd LIKE '/Library/Developer/CommandLineTools/%'
          OR p.path IN (
            '/Applications/Slack.app/Contents/Frameworks/Slack Helper.app/Contents/MacOS/Slack Helper'
          )
          OR cmd LIKE '/opt/homebrew/Cellar/%'
          OR p.path LIKE '/opt/homebrew/Cellar/%/bin/%'
          OR cmd LIKE '/opt/homebrew/opt/%'
          OR cmd LIKE '/private/var/folders/%/Visual Studio Code.app/Contents/%'
          OR cmd LIKE '/Users/%/homebrew/opt/mysql/bin/%' -- Sometimes cmd is empty also :(
          OR parent_cmd LIKE '/Applications/Google Chrome.app/%'
        )
      )
      AND NOT (
        p.name = ''
        AND parent_cmd = '/Applications/Firefox Developer Edition.app/Contents/MacOS/firefox -foreground'
      )
  description: Processes that do not exist on disk
  name: 'Detection - Evasion: Missing From Disk Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Processes that have an unrelated name in the process tree than the program on disk.
    --
    -- false positives:
    --   * new software, particularly those using interpreted languages
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1036/004/ (Masquerade Task or Service)
    --
    -- tags: persistent daemon high
    SELECT
      p.name,
      TRIM(SUBSTR(SPLIT (p.name, ':./ ', 0), 0, 15)) AS short_name,
      TRIM(SUBSTR(SPLIT (f.filename, ':./ ', 0), 0, 15)) AS short_filename,
      f.filename,
      p.path,
      p.cwd,
      p.cmdline AS cmd,
      p.parent AS parent_pid,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmd,
      pp.cwd AS parent_cwd,
      pp.euid AS parent_euid,
      hash.sha256 AS child_sha256,
      phash.sha256 AS parent_sha256,
      CONCAT (
        'name=',
        TRIM(SUBSTR(SPLIT (p.name, ':./ ', 0), 0, 15)),
        ',file=',
        TRIM(SUBSTR(SPLIT (f.filename, ':./ ', 0), 0, 15)),
        ',',
        MIN(p.uid, 500)
      ) AS exception_key
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN hash AS phash ON pp.path = phash.path
    WHERE
      short_filename != short_name
      AND NOT cmd LIKE '/nix/store/%/bin/bash%' -- Serial masqueraders
      AND NOT short_filename IN ('bash', 'ruby', 'python', 'python3')
      AND exception_key NOT IN (
        'name=blueman-applet,file=python3,500',
        'name=blueman-tray,file=python3,500',
        'name=cat,file=coreutils,500',
        'name=chrome-gnome-s,file=python3,500',
        'name=Chroot,file=firefox,500',
        'name=code-oss,file=electron,500',
        'name=exe,file=rootlessport,500',
        'name=file,file=firefox,500',
        'name=firefox-wrappe,file=firefox,500',
        'name=firewalld,file=python3,0',
        'name=gjs,file=gjs-console,120',
        'name=gjs,file=gjs-console,500',
        'name=sh,file=busybox,0',
        'name=cc,file=gcc,0',
        'name=gnome-characte,file=gjs-console,500',
        'name=gnome-character,file=gjs-console,500',
        'name=gnome-tweak-to,file=python3,500',
        'name=gsettings-hel,file=gsettings-help,500',
        'name=Isolated,file=firefox,500',
        'name=Isolated,file=thunderbird,500',
        'name=MainThread,file=plugin-contain,500',
        'name=mysqld,file=mariadbd,500',
        'name=networkd-dispa,file=python3,0',
        'name=nix-daemon,file=nix,0',
        'name=npm,file=node,500',
        'name=osqueryi,file=osqueryd,0',
        'name=osqueryi,file=osqueryd,500',
        'name=phpstorm,file=dash,500',
        'name=pidof,file=killall5,0',
        'name=pipewire-pulse,file=pipewire,500',
        'name=Privileged,file=firefox,500',
        'name=RDD,file=firefox,500',
        'name=sd_espeak-ng-m,file=sd_espeak-ng,500',
        'name=sessionclean,file=dash,0',
        'name=sh,file=dash,0',
        'name=sh,file=dash,500',
        'name=slic3r_main,file=prusa-slicer,500',
        'name=Socket,file=firefox,500',
        'name=streamdeck,file=python3,500',
        'name=systemd-udevd,file=udevadm,0',
        'name=terminator,file=python3,500',
        'name=Thunar,file=thunar,500',
        'name=unattended-upg,file=python3,0',
        'name=Utility,file=firefox,500',
        'name=vi,file=nvim,500',
        'name=vi,file=vim,500',
        'name=WebExtensions,file=firefox,500',
        'name=Web,file=firefox,500',
        'name=Web,file=thunderbird,500',
        'name=X,file=Xorg,0',
        'name=zfs-auto-snaps,file=ruby,0',
        'name=zoom,file=ZoomLauncher,500'
      )
      AND NOT (
        short_filename = 'systemd'
        AND short_name LIKE '(sd%'
      )
      AND NOT (
        short_filename LIKE 'emacs%'
        AND short_name = 'emacs'
      )
      AND NOT (p.path LIKE '/nix/store/%/bin/coreutils')
    GROUP by
      short_name,
      short_filename
  description: Processes that have an unrelated name in the process tree than the program on disk.
  name: 'Detection - Evasion: Name Path Mismatch'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Alert on programs running that are unusually old (poor timestomping)
    --
    -- false positive:
    --   * legimitely ancient programs. For instance, printer drivers.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1070/006/ (Indicator Removal on Host: Timestomp)
    --
    -- tags: transient process state
    SELECT
      p.path,
      p.cmdline,
      p.cwd,
      ((strftime('%s', 'now') - f.ctime) / 86400) AS ctime_age_days,
      ((strftime('%s', 'now') - f.ctime) / 86400) AS mtime_age_days,
      ((strftime('%s', 'now') - f.btime) / 86400) AS btime_age_days,
      h.sha256,
      f.uid,
      f.gid
    FROM
      processes p
      JOIN file f ON p.path = f.path
      JOIN hash h ON p.path = h.path
    WHERE
      (
        ctime_age_days > 1050
        OR mtime_age_days > 1050
      )
      AND p.path NOT LIKE '%/opt/brackets/Brackets%'
      AND h.sha256 NOT IN (
        'f61dcfce6f0c04263780700e0e9a8ff2363edefc344c08bd792fd401ddaa160f' -- jp.co.canon.MSU.app.Installer
      )
  description: Alert on programs running that are unusually old (poor timestomping)
  name: 'Detection - Evasion: Old Binaries Running'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- A program where the parent PID is not on disk
    --
    -- Reveals boopkit if a child is spawned
    -- TODO: Make mount namespace aware
    --
    -- false positives:
    --   * none observed
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1070/004/ (Indicator Removal on Host: File Deletion)
    --
    -- false positives:
    --   * none observed
    --
    -- tags: persistent daemon
    SELECT
      p.name AS child_name,
      p.pid AS child_pid,
      p.path AS child_path,
      p.cmdline AS child_cmd,
      p.euid AS child_euid,
      p.gid AS child_gid,
      hash.path,
      p.on_disk AS child_on_disk,
      pp.pid AS parent_pid,
      pp.name AS parent_name,
      pp.path AS parent_path,
      pp.cmdline AS cmd,
      pp.on_disk AS parent_on_disk,
      pp.uid AS parent_uid,
      pp.gid AS parent_gid
    FROM
      processes p
      JOIN processes pp ON pp.pid = p.parent
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      parent_on_disk != 1
      AND child_on_disk = 1
      AND NOT child_pid IN (1, 2)
      AND NOT parent_pid IN (1, 2) -- launchd, kthreadd
      AND NOT parent_path IN (
        '/opt/google/chrome/chrome',
        '/usr/lib/systemd/systemd',
        '/usr/bin/gnome-shell'
      ) -- long-running launchers
      AND NOT parent_name IN (
        'lightdm',
        'nvim',
        'gnome-shell',
        'slack',
        'kube-proxy',
        'kubelet'
      ) -- These alerts were unfortunately useless - lots of spam on macOS
      AND NOT (
        parent_path = ''
        AND p.uid > 500
      )
      AND parent_path NOT LIKE '/app/extra/%'
      AND parent_path NOT LIKE '/opt/homebrew/Cellar/%'
      AND NOT (
        parent_name LIKE 'kworker/%+events_unbound'
        AND child_name IN ('modprobe')
      )
  description: A program where the parent PID is not on disk
  name: 'Detection - Evasion: Parent Missing From Disk'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find ssh sessions that are hiding from 'w'/'who'
    --
    -- false positives:
    --   * ssh-driven automation which disables the terminal, such as Znapzend
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1021/004/ (Remote Services: SSH)
    --   * https://attack.mitre.org/techniques/T1564/ (Hide Artifacts)
    --
    -- tags: transient process state
    -- platform: posix
    SELECT
      *
    FROM
      (
        SELECT
          p.pid,
          p.name,
          p.cmdline AS cmd,
          cp.name AS child_name,
          cp.cmdline AS child_cmd,
          gcp.name AS grandchild_name,
          gcp.cmdline AS grandchild_cmd,
          GROUP_CONCAT(DISTINCT pof.path) AS open_files
        FROM
          processes p
          LEFT JOIN process_open_files pof ON p.pid = pof.pid
          LEFT JOIN processes cp ON p.pid = cp.parent
          LEFT JOIN processes gcp ON cp.pid = gcp.parent
        WHERE
          p.name = 'sshd'
        GROUP BY
          p.pid
      )
    WHERE
      (
        INSTR(cmd, '@notty') > 0
        OR (
          open_files != '/dev/null'
          AND INSTR(open_files, '/dev/ptmx') = 0
        )
      )
      -- You must specifically check for NULL here, or risk inadvertently filtering everything out.
      AND (
        grandchild_name IS NULL
        OR grandchild_name != 'zfs'
      )
  description: Find ssh sessions that are hiding from 'w'/'who'
  name: 'Detection - Evasion: Ssh Notty'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Programs which were spawned by an executable containing a matching ctime & mtime, which
    -- on Linux only generally occurs occurs if you run 'touch <bin>'
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1070/006/ (Timestomping)
    --
    -- tags: transient process state
    -- platform: linux
    SELECT
      p.pid,
      p.path,
      p.name,
      p.cmdline,
      p.cwd,
      p.euid,
      p.parent,
      f.ctime,
      f.btime,
      f.mtime,
      p.start_time,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmd,
      pp.cwd AS parent_cwd,
      hash.sha256 AS sha256
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      f.ctime = f.mtime
      AND p.path != '/'
      AND f.path NOT LIKE '/usr/local/kolide-k2/bin/%-updates/%'
      AND f.path NOT LIKE '/snap/%'
      AND f.path NOT LIKE '/home/%'
    GROUP by
      p.pid
  description: Programs which were spawned by an executable containing a matching ctime & mtime, which
  name: 'Detection - Evasion: Touched Executable Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Programs which appear to have been touched on macOS
    --
    -- This check is probably not very useful as there are plenty of legit reasons why
    -- the dates (in particular, 'btime'), gets doctored.
    --
    -- false positives:
    --   * Programs which are packaged weirdly and don't follow the typical Apple app layout
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1070/006/ (Timestomping)
    --
    -- tags: transient seldom filesystem state
    -- platform: darwin
    SELECT
      p.path,
      p.name,
      p.cmdline,
      p.euid,
      DATETIME(p.start_time, 'unixepoch') AS started,
      DATETIME(f.ctime, 'unixepoch') AS changed,
      DATETIME(f.btime, 'unixepoch') AS birthed,
      DATETIME(f.mtime, 'unixepoch') AS modified,
      DATETIME(f.atime, 'unixepoch') AS accessed,
      (f.btime - f.ctime) / 86400 AS btime_ctime_days_diff,
      (p.start_time - f.atime) / 86400 AS start_atime_days_diff,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmd,
      pp.cwd AS parent_cwd,
      hash.sha256 AS sha256,
      signature.identifier,
      signature.authority
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN signature ON p.path = signature.path
    WHERE
      f.btime == f.mtime
      AND (
        -- change time is older than birth time
        btime_ctime_days_diff > 0 -- change time is older than birth time, but not 1970
        OR (
          (btime_ctime_days_diff < -365)
          AND (btime_ctime_days_diff < -1000)
        ) -- access time is older than start time
        OR start_atime_days_diff > 90 -- access time is newer than start time
        OR start_atime_days_diff < -10
      ) -- Vendors that create software packages that look like a touched file.
      AND NOT signature.authority IN (
        'Apple Mac OS Application Signing',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Brave Software, Inc. (KL8N8XSYF4)',
        'Developer ID Application: Brother Industries, LTD. (5HCL85FLGW)',
        'Developer ID Application: Bryan Jones (49EYHPJ4Q3)',
        'Developer ID Application: CodeWeavers Inc. (9C6B7X7Z8E)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Emmanouil Konstantinidis (3YP8SXP3BF)',
        'Developer ID Application: Galvanix (5BRAQAFB8B)',
        'Developer ID Application: General Arcade (Pte. Ltd.) (S8JLSG5ES7)',
        'Developer ID Application: GEORGE NACHMAN (H7V7XYVQ7D)',
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        'Developer ID Application: GitHub (VEKTX9H2N7)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Michael Jones (YD6LEYT6WZ)',
        'Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        'Developer ID Application: RescueTime, Inc (FSY4RB8H39)',
        'Developer ID Application: Seiko Epson Corporation (TXAEAV5RN4)',
        'Developer ID Application: Yubico Limited (LQA3CS5MM7)',
        'Software Signing'
      )
      AND NOT (
        p.euid > 500
        AND (
          p.path IN (
            '/Applications/Divvy.app/Contents/MacOS/Divvy',
            '/Applications/Sourcetree.app/Contents/MacOS/Sourcetree',
            '/Library/CoreMediaIO/Plug-Ins/DAL/LogiCapture.plugin/Contents/MacOS/Assistant',
            '/Applications/Canon Utilities/IJ Scan Utility/Canon IJ Scan Utility Lite.app/Contents/Library/LoginItems/CIJSULAgent.app/Contents/MacOS/CIJSULAgent',
            '/Applications/Canon Utilities/Inkjet Extended Survey Program/Inkjet Extended Survey Program.app/Contents/MacOS/ESPController.app/Contents/Library/LoginItems/CanonIJExtendedSurveyLaunchAgent.app/Contents/MacOS/CanonIJExtendedSurveyLaunchAgent'
          )
          OR p.path LIKE '/Users/%/Library/Application Support/com.elgato.StreamDeck/Plugins/%'
          OR p.path LIKE '/Applications/%.app/Contents/MacOS/%'
          OR p.path LIKE '/opt/homebrew/Cellar/%/bin/%'
          OR p.path LIKE '/opt/homebrew/Caskroom/%/bin/%'
          OR p.path LIKE '/Users/%/google-cloud-sdk/bin/kubectl'
        )
      )
      AND NOT (
        p.euid > 300
        AND p.path LIKE '/nix/store/%'
      )
      AND NOT (
        p.euid = 0
        AND (
          p.path LIKE '/nix/store/%/bin/nix'
          OR p.path LIKE '/nix/store/%/bin/nix-daemon'
        )
      )
    GROUP by
      p.pid
  description: Programs which appear to have been touched on macOS
  name: 'Detection - Evasion: Touched Executable Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- macOS application layer firewall (ALF) service exceptions.
    --
    -- false positives:
    --   * locally built software
    --
    -- tags: persistent state filesystem
    -- platform: darwin
    SELECT
      ae.path,
      ae.state,
      file.mtime,
      file.ctime,
      file.uid,
      file.directory,
      file.size,
      file.type,
      hash.sha256,
      signature.identifier,
      signature.authority,
      CONCAT (
        signature.authority,
        ',',
        signature.identifier,
        ',',
        ae.path,
        ',',
        MIN(file.uid, 501)
      ) AS exception_key
    FROM
      alf_exceptions ae
      LEFT JOIN file ON ae.path = file.path
      LEFT JOIN hash ON ae.path = hash.path
      LEFT JOIN signature ON ae.path = signature.path
    WHERE -- NOTE:We intentionally want to preserve missing files
      -- Unfortunately, there is no column for when an exception was granted, so
      -- we're currently unable to filter out old entries.
      exception_key NOT IN (
        ',,/Applications/Google%20Chrome.app/,',
        ',,/Applications/IntelliJ%20IDEA.app/,',
        ',,/Applications/ProtonMail%20Bridge.app/,',
        ',,/Applications/Visual%20Studio%20Code.app/,',
        ',,/Applications/Visual%20Studio%20Code.app/Contents/Frameworks/Code%20Helper.app/,',
        ',,/System/Library/PrivateFrameworks/Admin.framework/Versions/A/Resources/readconfig,',
        ',,/usr/bin/nmblookup,',
        ',,/usr/libexec/discoveryd,',
        ',iodined-55554944d1ffcb236a84363d9b667be6a1742a17,/usr/local/sbin/iodined,501', -- thanks Jed!
        ',java,/opt/homebrew/Cellar/openjdk/19/libexec/openjdk.jdk/Contents/Home/bin/java,501',
        'Apple Mac OS Application Signing,com.apple.garageband10,/Applications/GarageBand.app/,0',
        'Apple Mac OS Application Signing,com.utmapp.QEMULauncher,/Applications/UTM.app/Contents/XPCServices/QEMUHelper.xpc/Contents/MacOS/QEMULauncher.app/,0',
        'Apple Mac OS Application Signing,io.tailscale.ipn.macos.network-extension,/Applications/Tailscale.app/Contents/PlugIns/IPNExtension.appex/,0',
        'Developer ID Application: Bohemian Coding (WUGMZZ5K46),com.bohemiancoding.sketch3,/Applications/Sketch.app/,501',
        'Developer ID Application: Bohemian Coding (WUGMZZ5K46),com.bohemiancoding.SketchMirrorHelper,/Applications/Sketch.app/Contents/XPCServices/SketchMirrorHelper.xpc/,501',
        'Developer ID Application: Brother Industries, LTD. (5HCL85FLGW),com.brother.utility.WorkflowAppControlServer,/Library/Printers/Brother/Utilities/Server/WorkflowAppControl.app/,0',
        'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK),com.getdropbox.dropbox,/Applications/Dropbox.app/,501',
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3),com.jetbrains.goland,/Applications/GoLand.app/,501',
        'Developer ID Application: Opentest, Inc. (QGD2ZPXZZG),com.loom.desktop,/Applications/Loom.app/,501',
        'Developer ID Application: RescueTime, Inc (FSY4RB8H39),com.rescuetime.RescueTime,/Applications/RescueTime.app/,0',
        'Developer ID Application: Sonos, Inc. (2G4LW83Q3E),com.sonos.macController,/Applications/Sonos.app/,501',
        'Developer ID Application: Spotify (2FNC3A47ZF),com.spotify.client,/Applications/Spotify.app/,501',
        'Developer ID Application: VNG ONLINE CO.,LTD (CVB6BX97VM),com.vng.zalo,/Applications/Zalo.app/,501',
        'Software Signing,com.apple.bootpd,/usr/libexec/bootpd,0',
        'Software Signing,com.apple.configd,/usr/libexec/configd,0',
        'Software Signing,com.apple.controlcenter,/System/Library/CoreServices/ControlCenter.app/,0',
        'Software Signing,com.apple.EmbeddedOSInstallService,/System/Library/PrivateFrameworks/EmbeddedOSInstall.framework/Versions/A/XPCServices/EmbeddedOSInstallService.xpc/,0',
        'Software Signing,com.apple.mDNSResponder,/usr/sbin/mDNSResponder,0',
        'Software Signing,com.apple.Music,/System/Applications/Music.app/,0',
        'Software Signing,com.apple.nc,/usr/bin/nc,0',
        'Software Signing,com.apple.racoon,/usr/sbin/racoon,0',
        'Software Signing,com.apple.universalcontrol,/System/Library/CoreServices/UniversalControl.app/,0',
        'Software Signing,com.apple.WebKit.Networking,/System/Library/Frameworks/WebKit.framework/Versions/A/XPCServices/com.apple.WebKit.Networking.xpc/,0',
        'Software Signing,com.apple.xartstorageremoted,/usr/libexec/xartstorageremoted,0'
      )
      AND NOT (
        signature.identifier LIKE 'cargo-%'
        AND ae.path LIKE '/Users/%/.rustup/%'
      )
      AND NOT (
        signature.identifier LIKE 'fake-%'
        AND ae.path LIKE '%/exe/fake'
      )
      AND NOT (
        signature.identifier LIKE 'mariadbd-%'
        AND ae.path LIKE '/opt/homebrew/%/mariadbd'
      )
      AND NOT (
        signature.identifier = 'netcat'
        AND ae.path LIKE '/Users/%/homebrew/Cellar/netcat/%/bin/netcat'
      )
      AND NOT (
        signature.identifier = 'syncthing'
        AND ae.path LIKE '/nix/store/%-syncthing-%/bin/syncthing'
      )
      AND NOT (
        ae.path LIKE '/Users/%/Library/Application%20Support/Steam/Steam.AppBundle/Steam/'
      )
      AND NOT (
        (
          signature.identifier = 'a.out'
          OR signature.identifier LIKE '%-%'
        )
        AND file.uid > 500
        AND (
          file.directory LIKE '/opt/homebrew/Cellar/%/bin'
          OR file.directory LIKE '/Users/%/bin'
          OR file.directory LIKE '/Users/%/code/%'
          OR file.directory LIKE '/Users/%/src/%'
          OR file.directory LIKE '/Users/%/node_modules/.bin/%'
          OR file.directory LIKE '/Users/%/git/%'
          OR file.directory LIKE '/Users/%/%-cli'
          OR file.directory LIKE '/private/var/folders/%/T/go-build%/exe'
        )
      )
    GROUP BY
      exception_key
  description: macOS application layer firewall (ALF) service exceptions.
  name: 'Detection - Evasion: Unexpected Alf Exceptions Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find unexpected files in /dev
    --
    -- references:
    --   * https://www.sandflysecurity.com/blog/bpfdoor-an-evasive-linux-backdoor-technical-analysis/
    --
    -- false positives:
    --   * programs which have legimate uses for /dev/shm (Chrome, etc)
    --
    -- tags: persistent state filesystem
    -- platform: posix
    SELECT
      file.path,
      file.type,
      file.size,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path LIKE '/dev/shm/%%'
        OR file.path LIKE '/dev/%/.%'
        OR file.path LIKE '/dev/.%'
        OR file.path LIKE '/dev/.%/%'
        OR file.path LIKE '/dev/%%/.%/%'
        OR file.path LIKE '/dev/mqueue/%%'
      ) -- We should also use uid for making decisions here
      AND NOT (
        file.uid > 499
        AND (
          file.path NOT LIKE '/dev/shm/.com.google.%'
          OR file.path LIKE '/dev/shm/.org.chromium.%'
          OR file.path LIKE '/dev/shm/wayland.mozilla.%'
          OR file.path LIKE '/dev/shm/shm-%-%-%'
          OR file.path LIKE 'pulse-shm-%'
          OR file.path LIKE 'u1000-Shm%'
          OR file.path LIKE 'u1000-Valve%'
          OR file.path LIKE '/dev/shm/jack_db%'
        )
      )
      AND file.path NOT LIKE '/dev/shm/lttng-ust-wait-%'
      AND file.path NOT LIKE '/dev/shm/flatpak-%'
      AND file.path NOT LIKE '/dev/shm/libpod_rootless_lock_%'
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
      AND file.path NOT IN ('/dev/.mdadm/')
  description: Find unexpected files in /dev
  name: 'Detection - Evasion: Unexpected Dev Entries'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find unexpected executables in /dev
    --
    -- references:
    --   * https://www.sandflysecurity.com/blog/bpfdoor-an-evasive-linux-backdoor-technical-analysis/
    --
    -- tags: persistent state filesystem
    SELECT
      file.path,
      file.directory,
      uid,
      gid,
      mode,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        -- This list is the result of multiple queries combined and can likely be minimized
        file.path LIKE '/dev/%%'
        OR file.path LIKE '/dev/%%/%%'
        OR file.path LIKE '/dev/mqueue/%%'
        OR file.path LIKE '/dev/mqueue/.%/%%'
        OR file.path LIKE '/dev/mqueue/%/%%'
        OR file.path LIKE '/dev/mqueue/%/%/.%'
        OR file.path LIKE '/dev/mqueue/%/.%/%%'
        OR file.path LIKE '/dev/shm/%%'
        OR file.path LIKE '/dev/shm/.%/%%'
        OR file.path LIKE '/dev/shm/%/%%'
        OR file.path LIKE '/dev/shm/%/%/.%'
        OR file.path LIKE '/dev/shm/%/.%/%%'
      )
      AND file.type = 'regular'
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
      AND (
        file.mode LIKE '%7%'
        or file.mode LIKE '%5%'
        or file.mode LIKE '%1%'
      )
  description: Find unexpected executables in /dev
  name: 'Detection - Evasion: Unexpected Dev Executables Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find unexpected executables in /etc
    --
    -- references:
    --   * https://blog.lumen.com/chaos-is-a-go-based-swiss-army-knife-of-malware/
    --
    -- tags: persistent
    -- platform: posix
    SELECT
      file.path,
      file.directory,
      uid,
      gid,
      mode,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (file.path LIKE '/etc/%%')
      AND file.type = 'regular'
      AND (
        file.mode LIKE '%7%'
        or file.mode LIKE '%5%'
        or file.mode LIKE '%1%'
      )
      AND file.directory NOT IN (
        '/etc/acpi',
        '/etc/alternatives',
        '/etc/apcupsd',
        '/etc/kde/shutdown',
        '/etc/apm/resume.d',
        '/etc/apm/scripts.d',
        '/etc/nix/result',
        '/etc/apm/suspend.d',
        '/etc/avahi',
        '/etc/nix/result/sw/bin',
        '/etc/bash_completion.d',
        '/etc/brltty/Contraction',
        '/etc/chromium/native-messaging-hosts',
        '/etc/cifs-utils',
        '/etc/console-setup',
        '/etc/cron.daily',
        '/etc/cron.hourly',
        '/etc/cron.monthly',
        '/etc/cron.weekly',
        '/etc/dhcp/dhclient.d',
        '/etc/dhcp/dhclient-enter-hooks.d',
        '/etc/dhcp/dhclient-exit-hooks.d',
        '/etc/dkms',
        '/etc/flatpak/remotes.d',
        '/etc/gdm',
        '/etc/gdm3',
        '/etc/gdm3/Init',
        '/etc/gdm3/PostLogin',
        '/etc/gdm3/PostSession',
        '/etc/gdm3/PreSession',
        '/etc/gdm3/Prime',
        '/etc/gdm3/PrimeOff',
        '/etc/gdm/Init',
        '/etc/gdm/PostLogin',
        '/etc/gdm/PostSession',
        '/etc/gdm/PreSession',
        '/etc/grub.d',
        '/etc/httpd/modules',
        '/etc/ifplugd',
        '/etc/ifplugd/action.d',
        '/etc/init.d',
        '/etc/kernel/header_postinst.d',
        '/etc/kernel/install.d',
        '/etc/kernel/postinst.d',
        '/etc/kernel/postrm.d',
        '/etc/kernel/preinst.d',
        '/etc/kernel/prerm.d',
        '/etc/lightdm',
        '/etc/mcelog/triggers',
        '/etc/menu-methods',
        '/etc/network/if-down.d',
        '/etc/network/if-post-down.d',
        '/etc/network/if-pre-up.d',
        '/etc/network/if-up.d',
        '/etc/NetworkManager/dispatcher.d',
        '/etc/openvpn',
        '/etc/periodic/daily',
        '/etc/periodic/monthly',
        '/etc/periodic/weekly',
        '/etc/pinentry',
        '/etc/pm/sleep.d',
        '/etc/ppp',
        '/etc/ppp/ip-down.d',
        '/etc/ppp/ip-up.d',
        '/etc/ppp/ipv6-up.d',
        '/etc/profile.d',
        '/etc/qemu-ga',
        '/etc/rc0.d',
        '/etc/rc1.d',
        '/etc/rc2.d',
        '/etc/rc3.d',
        '/etc/rc4.d',
        '/etc/rc5.d',
        '/etc/rc6.d',
        '/etc/rc.d/init.d',
        '/etc/rc.d/rc0.d',
        '/etc/rc.d/rc1.d',
        '/etc/rc.d/rc2.d',
        '/etc/rc.d/rc3.d',
        '/etc/rc.d/rc4.d',
        '/etc/rc.d/rc5.d',
        '/etc/rc.d/rc6.d',
        '/etc/rcS.d',
        '/etc/rdnssd',
        '/etc/security',
        '/etc/skel',
        '/etc/ssl/certs',
        '/etc/ssl/misc',
        '/etc/ssl/trust-source',
        '/etc/systemd/system',
        '/etc/systemd/system/graphical.target.wants',
        '/etc/systemd/system-shutdown',
        '/etc/update-motd.d',
        '/etc/vmware-tools',
        '/etc/vpnc',
        '/etc/wpa_supplicant',
        '/etc/X11',
        '/etc/X11/xinit',
        '/etc/X11/xinit/xinitrc.d',
        '/etc/xdg/Xwayland-session.d',
        '/etc/zfs-fuse',
        '/etc/zfs/zed.d',
        '/etc/zfs/zpool.d'
      )
      AND file.path NOT IN (
        '/etc/nftables.conf',
        '/etc/rmt',
        '/etc/paths.d/100-rvictl',
        '/etc/profile',
        '/etc/qemu-ifdown',
        '/etc/qemu-ifup',
        '/etc/opt/chrome/native-messaging-hosts/com.google.endpoint_verification.api_helper.json'
      )
      -- Nix (on macOS) -- actually a symbolic link
      AND file.path NOT LIKE '/etc/profiles/per-user/%/bin/%'
  description: Find unexpected executables in /etc
  name: 'Detection - Evasion: Unexpected Etc Executables'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find unexpected hidden directories in operating-system folders
    --
    -- references:
    --   * https://themittenmac.com/what-does-apt-activity-look-like-on-macos/
    --
    -- false positives:
    --   * unusual installers
    --
    -- platform: posix
    -- tags: persistent filesystem state
    SELECT
      file.path,
      file.directory,
      uid,
      gid,
      mode,
      mtime,
      ctime,
      type,
      size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path LIKE '/lib/.%'
        OR file.path LIKE '/.%'
        OR file.path LIKE '/bin/%/.%'
        OR file.path LIKE '/dev/.%'
        OR file.path LIKE '/etc/.%'
        OR file.path LIKE '/etc/%/.%'
        OR file.path LIKE '/lib/%/.%'
        OR file.path LIKE '/libexec/.%'
        OR file.path LIKE '/Library/.%'
        OR file.path LIKE '/sbin/.%'
        OR file.path LIKE '/sbin/%/.%'
        OR file.path LIKE '/tmp/.%'
        OR file.path LIKE '/usr/bin/.%'
        OR file.path LIKE '/usr/lib/.%'
        OR file.path LIKE '/usr/lib/%/.%'
        OR file.path LIKE '/usr/libexec/.%'
        OR file.path LIKE '/usr/local/bin/.%'
        OR file.path LIKE '/usr/local/lib/.%'
        OR file.path LIKE '/usr/local/lib/.%'
        OR file.path LIKE '/usr/local/libexec/.%'
        OR file.path LIKE '/usr/local/sbin/.%'
        OR file.path LIKE '/usr/sbin/.%'
        OR file.path LIKE '/var/.%'
        OR file.path LIKE '/var/lib/.%'
        OR file.path LIKE '/var/tmp/.%'
      ) -- Avoid mentioning extremely temporary files
      AND strftime('%s', 'now') - file.ctime > 20
      AND file.path NOT IN (
        '/.autorelabel',
        '/dev/.mdadm/',
        '/etc/.clean',
        '/etc/.java/',
        '/etc/selinux/.config_backup',
        '/etc/skel/.mozilla/',
        '/.file',
        '/tmp/../',
        '/tmp/./',
        '/tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress',
        '/tmp/._contentbarrier_installed',
        '/tmp/.dotnet/',
        '/tmp/.dracula-tmux-data',
        '/tmp/.dracula-tmux-weather.lock',
        '/tmp/.font-unix/',
        '/tmp/.ICE-unix/',
        '/tmp/.%.lock',
        '/tmp/.Test-unix/',
        '/tmp/.vbox-t-ipc/',
        '/tmp/.X0-lock',
        '/tmp/.X11-unix/',
        '/tmp/.X1-lock',
        '/tmp/.XIM-unix/',
        '/var/.ntw_cache',
        '/var/.Parallels_swap/',
        '/var/.pwd_cache',
        '/.vol/',
        '/.VolumeIcon.icns'
      )
      AND file.directory NOT IN ('/etc/skel', '/etc/skel/.config')
      AND file.path NOT LIKE '/%bin/bootstrapping/.default_components'
      AND file.path NOT LIKE '/tmp/.#%'
      AND file.path NOT LIKE '/tmp/.%.gcode'
      AND file.path NOT LIKE '/tmp/.vbox-%-ipc/'
      AND file.path NOT LIKE '/tmp/.com.google.Chrome.%'
      AND file.path NOT LIKE '/tmp/.org.chromium.Chromium%'
      AND file.path NOT LIKE '/tmp/.X1%-lock'
      AND file.path NOT LIKE '/usr/local/%/.keepme'
      AND file.path NOT LIKE '%/../'
      AND file.path NOT LIKE '%/./'
      AND file.path NOT LIKE '%/.build-id/'
      AND file.path NOT LIKE '%/.dwz/'
      AND file.path NOT LIKE '%/.updated'
      AND file.path NOT LIKE '%/google-cloud-sdk/.install/'
      AND NOT (
        type = 'regular'
        AND (
          filename LIKE '%.swp'
          OR size < 2
        )
      )
      AND NOT (
        type = 'regular'
        AND filename = '.placeholder'
      ) -- A curious addition seen on a NixOS machine
      AND NOT (
        file.path = '/.cache/'
        AND file.uid = 0
        AND file.gid = 0
        AND file.mode = '0755'
        AND file.size = 3
      )
      AND NOT (
        file.path = '/.config/'
        AND file.uid = 0
        AND file.gid = 0
        AND file.mode IN ('0755', '0700')
        AND file.size = 4
      )
  description: Find unexpected hidden directories in operating-system folders
  name: 'Detection - Evasion: Unexpected Hidden System Folders'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find unexpected 3rd-party kernel extensions
    --
    -- false positives:
    --   * none known
    --
    -- platform: darwin
    -- tags: persistent seldom kernel
    SELECT
      *
    FROM
      kernel_extensions
    WHERE
      path NOT LIKE '/System/Library/Extensions/%'
      AND NOT (
        idx = 0
        AND name = '__kernel__'
      );
  description: Find unexpected 3rd-party kernel extensions
  name: 'Detection - Evasion: Unexpected Kernel Extensions Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find kernel modules that are not part of the expected list
    --
    -- false positives:
    --   * operating-system updates
    --
    -- platform: linux
    -- tags: latent seldom kernel
    SELECT
      *
    FROM
      kernel_modules
    WHERE
      name NOT IN (
        '8021q',
        'ac97_bus',
        'acpi_cpufreq',
        'acpi_pad',
        'acpi_tad',
        'acpi_thermal_rel',
        'aesni_intel',
        'af_alg',
        'af_packet',
        'agpgart',
        'ahci',
        'algif_aead',
        'algif_hash',
        'algif_skcipher',
        'amdgpu',
        'amd_pmc',
        'apple_mfi_fastcharge',
        'asn1_encoder',
        'asus_ec_sensors',
        'asus_wmi',
        'ath',
        'ath10k_core',
        'ath10k_pci',
        'atkbd',
        'authenc',
        'autofs4',
        'backlight',
        'battery',
        'binfmt_misc',
        'bluetooth',
        'bnep',
        'bpf_preload',
        'bridge',
        'br_netfilter',
        'btbcm',
        'btintel',
        'btmtk',
        'btrtl',
        'btusb',
        'button',
        'cbc',
        'ccm',
        'ccp',
        'cdc_ether',
        'cec',
        'cfg80211',
        'cmac',
        'configfs',
        'coretemp',
        'cqhci',
        'crc16',
        'crc32c_generic',
        'crc32c_intel',
        'crc32_pclmul',
        'crc_t10dif',
        'crct10dif_common',
        'crct10dif_generic',
        'crct10dif_pclmul',
        'cros_ec',
        'cros_ec_chardev',
        'cros_ec_debugfs',
        'cros_ec_dev',
        'cros_ec_ishtp',
        'cros_ec_lpcs',
        'cros_ec_sysfs',
        'cros_usbpd_charger',
        'cros_usbpd_logger',
        'cros_usbpd_notify',
        'cryptd',
        'crypto_simd',
        'crypto_user',
        'ctr',
        'dca',
        'dcdbas',
        'deflate',
        'dell_laptop',
        'dell_smbios',
        'dell_smm_hwmon',
        'dell_wmi',
        'dell_wmi_descriptor',
        'des_generic',
        'dm_bio_prison',
        'dm_bufio',
        'dm_crypt',
        'dm_mod',
        'dm_multipath',
        'dm_persistent_data',
        'dm_thin_pool',
        'drm',
        'drm_buddy',
        'drm_display_helper',
        'drm_dp_helper',
        'drm_kms_helper',
        'drm_ttm_helper',
        'ecb',
        'ecc',
        'ecdh_generic',
        'edac_core',
        'edac_mce_amd',
        'ee1004',
        'eeepc_wmi',
        'efi_pstore',
        'efivarfs',
        'encrypted_keys',
        'essiv',
        'evdev',
        'ext4',
        'fat',
        'fb_sys_fops',
        'firmware_attributes_class',
        'fuse',
        'gf128mul',
        'ghash_clmulni_intel',
        'gigabyte_wmi',
        'gpio_amdpt',
        'gpio_generic',
        'gpu_sched',
        'hid',
        'hid_apple',
        'hid_generic',
        'hid_jabra',
        'hid_logitech_dj',
        'hid_logitech_hidpp',
        'hid_multitouch',
        'hid_sensor_als',
        'hid_sensor_custom',
        'hid_sensor_hub',
        'hid_sensor_iio_common',
        'hid_sensor_trigger',
        'hwmon_vid',
        'i2c_algo_bit',
        'i2c_core',
        'i2c_designware_core',
        'i2c_designware_platform',
        'i2c_hid',
        'i2c_hid_acpi',
        'i2c_i801',
        'i2c_piix4',
        'i2c_scmi',
        'i2c_smbus',
        'i8042',
        'i915',
        'icp',
        'idma64',
        'igb',
        'igc',
        'igen6_edac',
        'industrialio',
        'industrialio_triggered_buffer',
        'input_leds',
        'int3400_thermal',
        'int3403_thermal',
        'int340x_thermal_zone',
        'intel_cstate',
        'intel_gtt',
        'intel_hid',
        'intel_ish_ipc',
        'intel_ishtp',
        'intel_ishtp_hid',
        'intel_ishtp_loader',
        'intel_lpss',
        'intel_lpss_pci',
        'intel_pch_thermal',
        'intel_pmc_bxt',
        'intel_pmt',
        'intel_powerclamp',
        'intel_rapl_common',
        'intel_rapl_msr',
        'intel_soc_dts_iosf',
        'intel_spi',
        'intel_spi_pci',
        'intel_tcc_cooling',
        'intel_uncore',
        'intel_vsec',
        'intel_wmi_thunderbolt',
        'intel_xhci_usb_role_switch',
        'iommu_v2',
        'ip6table_filter',
        'ip6table_mangle',
        'ip6table_nat',
        'ip6table_raw',
        'ip6_tables',
        'ip6t_REJECT',
        'ip6t_rpfilter',
        'ip6t_rt',
        'ipheth',
        'ipmi_devintf',
        'ipmi_msghandler',
        'ip_set',
        'iptable_filter',
        'iptable_mangle',
        'iptable_nat',
        'iptable_raw',
        'ip_tables',
        'iptable_security',
        'ipt_REJECT',
        'ipt_rpfilter',
        'ip_vs',
        'ip_vs_rr',
        'ip_vs_sh',
        'ip_vs_wrr',
        'irqbypass',
        'isofs',
        'iTCO_vendor_support',
        'iTCO_wdt',
        'iwlmei',
        'iwlmvm',
        'iwlwifi',
        'jbd2',
        'jc42',
        'joydev',
        'k10temp',
        'kfifo_buf',
        'kvm',
        'kvm_amd',
        'kvm_intel',
        'led_class',
        'ledtrig_audio',
        'libaes',
        'libahci',
        'libarc4',
        'libata',
        'libcrc32c',
        'libdes',
        'libphy',
        'libps2',
        'llc',
        'loop',
        'lp',
        'mac80211',
        'mac_hid',
        'macvlan',
        'mbcache',
        'mc',
        'md4',
        'mdio_devres',
        'md_mod',
        'mei',
        'mei_hdcp',
        'mei_me',
        'mei_pxp',
        'mei_wdt',
        'mii',
        'mmc_block',
        'mmc_core',
        'mousedev',
        'msr',
        'mtd',
        'mxm_wmi',
        'nct6775',
        'nct6775_core',
        'netlink_diag',
        'nf_conntrack',
        'nf_conntrack_broadcast',
        'nf_conntrack_netbios_ns',
        'nf_conntrack_netlink',
        'nf_defrag_ipv4',
        'nf_defrag_ipv6',
        'nf_log_syslog',
        'nf_nat',
        'nfnetlink',
        'nfnetlink_log',
        'nfnetlink_queue',
        'nf_reject_ipv4',
        'nf_reject_ipv6',
        'nf_tables',
        'nft_chain_nat',
        'nft_compat',
        'nft_counter',
        'nft_ct',
        'nft_fib',
        'nft_fib_inet',
        'nft_fib_ipv4',
        'nft_fib_ipv6',
        'nft_limit',
        'nft_objref',
        'nft_reject',
        'nft_reject_inet',
        'nls_cp437',
        'nls_iso8859_1',
        'nvidia',
        'nvidia_drm',
        'nvidia_modeset',
        'nvidia_uvm',
        'nvme',
        'nvme_common',
        'nvme_core',
        'nvram',
        'overlay',
        'parport',
        'parport_pc',
        'pcspkr',
        'pinctrl_amd',
        'pinctrl_sunrisepoint',
        'pinctrl_tigerlake',
        'pkcs8_key_parser',
        'platform_profile',
        'pmt_class',
        'pmt_telemetry',
        'polyval_clmulni',
        'polyval_generic',
        'ppdev',
        'pps_core',
        'processor_thermal_device',
        'processor_thermal_device_pci',
        'processor_thermal_device_pci_legacy',
        'processor_thermal_mbox',
        'processor_thermal_rapl',
        'processor_thermal_rfim',
        'psmouse',
        'pstore',
        'pstore_blk',
        'pstore_zone',
        'ptp',
        'qrtr',
        'r8152',
        'r8153_ecm',
        'r8169',
        'raid0',
        'ramoops',
        'rapl',
        'raydium_i2c_ts',
        'rc_core',
        'realtek',
        'reed_solomon',
        'rfcomm',
        'rfkill',
        'rndis_host',
        'rndis_wlan',
        'rng_core',
        'roles',
        'rtc_cmos',
        'rtsx_pci',
        'rtsx_pci_sdmmc',
        'rtw89_8852a',
        'rtw89_8852ae',
        'rtw89_core',
        'rtw89_pci',
        'sch_fq_codel',
        'scsi_common',
        'scsi_mod',
        'sdhci',
        'sdhci_pci',
        'serio',
        'serio_raw',
        'sg',
        'snd',
        'snd_acp3x_pdm_dma',
        'snd_acp3x_rn',
        'snd_acp_config',
        'snd_compress',
        'snd_ctl_led',
        'snd_hda_codec',
        'snd_hda_codec_generic',
        'snd_hda_codec_hdmi',
        'snd_hda_codec_idt',
        'snd_hda_codec_realtek',
        'snd_hda_core',
        'snd_hda_ext_core',
        'snd_hda_intel',
        'snd_hrtimer',
        'snd_hwdep',
        'snd_intel_dspcfg',
        'snd_intel_sdw_acpi',
        'snd_pci_acp3x',
        'snd_pci_acp5x',
        'snd_pci_acp6x',
        'snd_pcm',
        'snd_pcm_dmaengine',
        'snd_rawmidi',
        'snd_rn_pci_acp3x',
        'snd_seq',
        'snd_seq_device',
        'snd_seq_dummy',
        'snd_seq_midi',
        'snd_seq_midi_event',
        'snd_soc_acpi',
        'snd_soc_acpi_intel_match',
        'snd_soc_avs',
        'snd_soc_core',
        'snd_soc_dmic',
        'snd_soc_hdac_hda',
        'snd_soc_hdac_hdmi',
        'snd_soc_intel_hda_dsp_common',
        'snd_soc_skl',
        'snd_soc_skl_hda_dsp',
        'snd_soc_sst_dsp',
        'snd_soc_sst_ipc',
        'snd_sof',
        'snd_sof_amd_acp',
        'snd_sof_amd_renoir',
        'snd_sof_intel_hda',
        'snd_sof_intel_hda_common',
        'snd_sof_pci',
        'snd_sof_pci_intel_tgl',
        'snd_sof_utils',
        'snd_sof_xtensa_dsp',
        'snd_timer',
        'snd_usb_audio',
        'snd_usbmidi_lib',
        'soundcore',
        'soundwire_bus',
        'soundwire_cadence',
        'soundwire_generic_allocation',
        'soundwire_intel',
        'sp5100_tco',
        'sparse_keymap',
        'spi_intel',
        'spi_intel_pci',
        'spi_nor',
        'spl',
        'squashfs',
        'stp',
        'sunrpc',
        'syscopyarea',
        'sysfillrect',
        'sysimgblt',
        't10_pi',
        'tap',
        'tee',
        'thermal',
        'think_lmi',
        'thinkpad_acpi',
        'thunderbolt',
        'tiny_power_button',
        'tls',
        'tpm',
        'tpm_crb',
        'tpm_tis',
        'tpm_tis_core',
        'trusted',
        'ttm',
        'tun',
        'typec',
        'typec_ucsi',
        'uas',
        'ucsi_acpi',
        'uhid',
        'uinput',
        'usb_common',
        'usbcore',
        'usbhid',
        'usbnet',
        'usb_storage',
        'uvcvideo',
        'v4l2loopback',
        'veth',
        'vfat',
        'video',
        'videobuf2_common',
        'videobuf2_memops',
        'videobuf2_v4l2',
        'videobuf2_vmalloc',
        'videodev',
        'vivaldi_fmap',
        'watchdog',
        'wmi',
        'wmi_bmof',
        'x86_pkg_temp_thermal',
        'xfrm_algo',
        'xfrm_user',
        'xfs',
        'xhci_hcd',
        'xhci_pci',
        'xhci_pci_renesas',
        'x_tables',
        'xt_addrtype',
        'xt_comment',
        'xt_conntrack',
        'xt_hl',
        'xt_limit',
        'xt_LOG',
        'xt_mark',
        'xt_MASQUERADE',
        'xt_nat',
        'xt_pkttype',
        'xt_statistic',
        'xt_tcpudp',
        'zavl',
        'zcommon',
        'zfs',
        'zlua',
        'znvpair',
        'zram',
        'zunicode',
        'zzstd'
      )
  description: Find kernel modules that are not part of the expected list
  name: 'Detection - Evasion: Unexpected Kernel Modules Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find unexpected ld.so.conf files
    --
    -- If you have Augeas available, you may want to use that in conjunction with this more limited check.
    --
    -- false positives:
    --   * none known
    --
    -- tags: persistent seldom
    -- platform: linux
    SELECT
      file.path,
      uid,
      gid,
      mode,
      file.mtime,
      file.size,
      hash.sha256,
      CONCAT (file.path, ',', mode, ',', size, ',', sha256) AS exception_key
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path IN ('/etc/ld.so.conf', '/etc/ld.so.preload')
        OR file.path LIKE '/etc/ld.so.conf.d/%'
        OR file.path LIKE '/etc/ld.so.conf.d/.%'
      )
      AND file.filename NOT IN ('.', '..')
      AND exception_key NOT IN (
        '/etc/ld.so.conf,0644,117,dad04a370e488aa85fb0a813a5c83cf6fd981ce01883fc59685447b092de84b5',
        '/etc/ld.so.conf,0644,28,239c865e4c0746a01f82b03d38d620853bab2a2ba8e81d6f5606c503e0ea379f',
        '/etc/ld.so.conf,0644,34,d4b198c463418b493208485def26a6f4c57279467b9dfa491b70433cedb602e8',
        '/etc/ld.so.conf.d/cuda.conf,0644,66,a65f7d96e2447eb40b1be9586b90eb0bd776a8938c93d21f9606d2880b548b28',
        '/etc/ld.so.conf.d/dyninst-x86_64.conf,0644,19,a4c740c1f59176d816ba18d429ba823317d3db416accf6d79a9cb0ac845d9d50',
        '/etc/ld.so.conf.d/fakeroot.conf,0644,21,564c4c4d369d005702d825d34edc5e5568cb1ab6ee1b19fa03d0d672fb8b3aee',
        '/etc/ld.so.conf.d/fakeroot-x86_64-linux-gnu.conf,0644,38,af7edc777dd224bade078ba540538444db69856533c02e18a7f9fbbdd23bd181',
        '/etc/ld.so.conf.d/i386-linux-gnu.conf,0644,168,023231b8d6d21a7f4b1a59b875576604395041c814c0fd640d4a1d3d29455e6a',
        '/etc/ld.so.conf.d/lib32-glibc.conf,0644,11,c27424154a6096ae32c0824b785e05de6acef33d9224fd6147d1936be9b4962b',
        '/etc/ld.so.conf.d/libc.conf,0644,44,90d4c7e43e7661cd116010eb9f50ad5817e43162df344bd1ad10898851b15d41',
        '/etc/ld.so.conf.d/libiscsi-x86_64.conf,0644,17,fa3839c3cb893d3a589a020a0a9a010de1332b8385ee8139660e2da8bcc932a3',
        '/etc/ld.so.conf.d/llvm13-x86_64.conf,0644,22,4da62e9ec76b030c527e2ea87ccfab1baeff7d0f9092f980231e49961bb97de0',
        '/etc/ld.so.conf.d/opencollada.conf,0644,21,2fc9656a2b881ca4528416daa91fc525adaa97d73e96a18b41aa7856270eba1f',
        '/etc/ld.so.conf.d/perf.conf,0644,14,c67f871bdc72182dc75c160b16ca3b5371fdab76a27199a29f14b52a5aed1d3f',
        '/etc/ld.so.conf.d/pipewire-jack-x86_64.conf,0644,30,cf4cb69feaa8ec8b99558c4e1123518831b3c56488981cbc34a662fe218ef221',
        '/etc/ld.so.conf.d/tix-x86_64.conf,0644,18,b2ef4843990ded5fd96e417fc08027a785fac59bd70eca6a26dd7b057542273a',
        '/etc/ld.so.conf.d/x86_64-linux-gnu.conf,0644,100,f03e4740e6922b4f4a1181cd696b52f62f9f10d003740a8940f7121795c59c98'
      )
  description: Find unexpected ld.so.conf files
  name: 'Detection - Evasion: Unexpected Ld So Files Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find unexpected files in /Library
    --
    -- references:
    --   * https://www.intezer.com/blog/incident-response/new-backdoor-sysjoker/
    --
    -- false positives:
    --   * programs which create new Library directories
    --
    -- tags: persistent state filesystem seldom
    -- platform: darwin
    SELECT
      file.path,
      file.type,
      file.size,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path LIKE '/Library/%'
        OR file.path LIKE '/Library/.%'
        OR file.path LIKE '/Library/%/.%'
        OR file.path LIKE '/Library/WebServer/%'
        OR file.path LIKE '/Library/WebServer/Documents/%%'
        OR file.path LIKE '/Library/WebServer/CGI-Executables/%%'
      )
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
      AND file.size > 1
      AND file.path NOT IN (
        '/Library/Apple/',
        '/Library/Application Support/',
        '/Library/Audio/',
        '/Library/AutoBugCapture/',
        '/Library/Automator/',
        '/Library/Bluetooth/',
        '/Library/Caches/',
        '/Library/Catacomb/',
        '/Library/ColorPickers/',
        '/Library/ColorSync/',
        '/Library/Components/',
        '/Library/Compositions/',
        '/Library/DropboxHelperTools/',
        '/Library/Compositions/.localized',
        '/Library/Contextual Menu Items/',
        '/Library/CoreAnalytics/',
        '/Library/CoreMediaIO/',
        '/Library/Desktop Pictures/',
        '/Library/Desktop Pictures/.localizations/',
        '/Library/Desktop Pictures/.thumbnails/',
        '/Library/Developer/',
        '/Library/DirectoryServices/',
        '/Library/Documentation/',
        '/Library/DriverExtensions/',
        '/Library/DropboxHelperTools/',
        '/Library/Extensions/',
        '/Library/Filesystems/',
        '/Library/Fonts/',
        '/Library/Fonts/.uuid',
        '/Library/Frameworks/',
        '/Library/Google/',
        '/Library/GPUBundles/',
        '/Library/Graphics/',
        '/Library/Image Capture/',
        '/Library/Input Methods/',
        '/Library/InstallerSandboxes/',
        '/Library/InstallerSandboxes/.metadata_never_index',
        '/Library/InstallerSandboxes/.PKInstallSandboxManager/',
        '/Library/Internet Plug-Ins/',
        '/Library/Java/',
        '/Library/KernelCollections/',
        '/Library/KernelCollections/.file',
        '/Library/Keyboard Layouts/',
        '/Library/Keychains/',
        '/Library/LaunchAgents/',
        '/Library/LaunchDaemons/',
        '/Library/.localized',
        '/Library/Logs/',
        '/Library/Mail/',
        '/Library/Managed Preferences/',
        '/Library/Modem Scripts/',
        '/Library/Nessus/',
        '/Library/Objective-See/',
        '/Library/OpenDirectory/',
        '/Library/OSAnalytics/',
        '/Library/OSAnalytics/.DS_Store',
        '/Library/PDF Services/',
        '/Library/Perl/',
        '/Library/Plug-Ins/',
        '/Library/PreferencePanes/',
        '/Library/Preferences/',
        '/Library/Preferences/.GlobalPreferences.plist',
        '/Library/Printers/',
        '/Library/PrivilegedHelperTools/',
        '/Library/Python/',
        '/Library/QuickLook/',
        '/Library/Receipts/',
        '/Library/Ruby/',
        '/Library/Sandbox/',
        '/Library/Screen Savers/',
        '/Library/ScriptingAdditions/',
        '/Library/Scripts/',
        '/Library/Security/',
        '/Library/Services/',
        '/Library/Speech/',
        '/Library/Spotlight/',
        '/Library/StagedDriverExtensions/',
        '/Library/StagedExtensions/',
        '/Library/StartupItems/',
        '/Library/SystemExtensions/',
        '/Library/SystemExtensions/.staging/',
        '/Library/SystemMigration/',
        '/Library/SystemProfiler/',
        '/Library/TeX/',
        '/Library/Updates/',
        '/Library/User Pictures/',
        '/Library/User Template/',
        '/Library/Video/',
        '/Library/WebServer/',
        '/Library/WebServer/CGI-Executables/',
        '/Library/WebServer/Documents/',
        '/Library/WebServer/Documents/index.html.en',
        '/Library/WebServer/share/'
      )
      AND NOT file.path LIKE '/Library/Caches/.0%'
  description: Find unexpected files in /Library
  name: 'Detection - Evasion: Unexpected Library Entries Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find unexpected executables in temp directories, often used by malware droppers
    --
    -- false positives:
    --   * developers building code out of /tmp
    --
    -- tags: persistent
    -- platform: posix
    SELECT
      file.path,
      uid,
      gid,
      mode,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        -- Recursive queries don't seem to work well with hidden directories :(
        file.path LIKE '/tmp/%%'
        OR file.path LIKE '/tmp/.%/%%'
        OR file.path LIKE '/tmp/%/%%'
        OR file.path LIKE '/tmp/%/%/.%'
        OR file.path LIKE '/tmp/%/.%/%%'
      )
      AND file.type = 'regular'
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
      AND (
        file.mode LIKE '%7%'
        or file.mode LIKE '%5%'
        or file.mode LIKE '%1%'
      )
      AND NOT (
        uid > 500
        AND (
          file.path LIKE '%/go-build%'
          OR file.path LIKE '/tmp/checkout/%'
          OR file.path LIKE '/tmp/com.apple.installer%'
          OR file.path LIKE '/tmp/flow/%.npmzS_cacachezStmpzSgit-clone%'
          OR file.path LIKE '/tmp/%/site-packages/markupsafe/_speedups.cpython-%'
          OR file.path LIKE '/tmp/go.%.sum'
          OR file.path LIKE '/tmp/guile-%/guile-%'
          OR file.path LIKE '/tmp/terraformer/%'
          OR file.path LIKE '/tmp/tmp.%'
          OR file.path LIKE '%/bin/%-gen'
          OR file.path LIKE '%/bin/%'
          OR file.path LIKE '%/CCLBS/%'
          OR file.path LIKE '%/ko/%'
          OR file.path LIKE '%/pdf-tools/%'
          OR file.path LIKE '%/tmp/epdf%'
          OR -- These regular expressions can be narrowed down
          (
            file.size < 8000
            AND file.path LIKE '/tmp/%.sh'
            AND file.uid > 500
          )
          OR (
            file.size < 8000
            AND file.path LIKE '/tmp/%.py'
            AND file.uid > 500
          )
        )
      ) -- Nix
      AND NOT (
        file.directory LIKE '/tmp/tmp%'
        AND gid = 0
        AND uid > 300
        AND uid < 350
      ) -- Babel
      AND NOT (
        file.directory LIKE '/tmp/babel-%/sh-script-%'
        AND gid > 900
        AND uid = 1000
        AND size < 1024
      ) -- Random Testdata
      AND NOT (
        gid > 900
        AND uid = 1000
        AND (
          file.directory LIKE '/tmp/%/test'
          OR file.directory LIKE '/tmp/%/testdata'
        )
      ) -- Don't alert if the file is only on disk for a moment
      AND NOT (
        file.directory LIKE '/tmp/%'
        AND (strftime('%s', 'now') - ctime) < 30
      ) -- macOS updates
      AND NOT file.directory LIKE '/tmp/msu-target-%' -- I don't know man. I don't work here.
      AND NOT (
        file.path LIKE('/tmp/%compressed')
        AND size < 4000
        AND uid > 500
      ) -- Executables too small to even hold '#!/bin/sh\nuid'
      AND NOT (
        file.type = 'regular'
        AND size < 10
      )
  description: Find unexpected executables in temp directories, often used by malware droppers
  name: 'Detection - Evasion: Unexpected Tmp Executables'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find unexpected executables in /var
    --
    -- false positives:
    --   * none known
    --
    -- tags: persistent
    -- platform: linux
    SELECT
      file.path,
      file.directory,
      uid,
      gid,
      mode,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        -- This list is the result of multiple queries combined and can likely be minimized
        file.path LIKE '/var/%%'
        OR file.path LIKE '/var/tmp/%%'
        OR file.path LIKE '/var/tmp/.%/%%'
        OR file.path LIKE '/var/tmp/%/%%'
        OR file.path LIKE '/var/tmp/%/%/.%'
        OR file.path LIKE '/var/tmp/%/.%/%%'
        OR file.path LIKE '/var/spool/%%'
        OR file.path LIKE '/var/spool/.%/%%'
        OR file.path LIKE '/var/spool/%/%%'
        OR file.path LIKE '/var/spool/%/%/.%'
        OR file.path LIKE '/var/spool/%/.%/%%'
      )
      AND file.type = 'regular'
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
      AND (
        file.mode LIKE '%7%'
        or file.mode LIKE '%5%'
        or file.mode LIKE '%1%'
      )
      AND file.directory NOT IN (
        '/var/lib/colord',
        '/var/ossec/agentless',
        '/var/ossec/bin',
        '/var/ossec/wodles',
        '/var/run/booted-system',
        '/var/run/current-system'
      )
      AND file.size > 10
  description: Find unexpected executables in /var
  name: 'Detection - Evasion: Unexpected Var Executables Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find unexpected executables in /var
    --
    -- false positives:
    --   * none known
    --
    -- tags: persistent
    -- platform: darwin
    SELECT
      file.path,
      file.directory,
      uid,
      gid,
      mode,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        -- This list is the result of multiple queries combined and can likely be minimized
        file.path LIKE '/var/%%'
        OR file.path LIKE '/var/tmp/%%'
        OR file.path LIKE '/var/tmp/.%/%%'
        OR file.path LIKE '/var/tmp/%/%%'
        OR file.path LIKE '/var/tmp/%/%/.%'
        OR file.path LIKE '/var/tmp/%/.%/%%'
        OR file.path LIKE '/var/spool/%%'
        OR file.path LIKE '/var/spool/.%/%%'
        OR file.path LIKE '/var/spool/%/%%'
        OR file.path LIKE '/var/spool/%/%/.%'
        OR file.path LIKE '/var/spool/%/.%/%%'
      )
      AND file.type = 'regular'
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
      -- Rosetta cache, SIP protected
      AND file.path NOT LIKE '/var/db/oah/%'
      AND file.path NOT LIKE '/var/tmp/IN_PROGRESS_sysdiagnose_%.tmp/mddiagnose.mdsdiagnostic/diagnostic.log'
      AND file.path NOT LIKE '/var/tmp/epdfinfo%'
      AND file.path NOT LIKE '/var/folders%/T/sp_relauncher'
      AND (
        file.mode LIKE '%7%'
        or file.mode LIKE '%5%'
        or file.mode LIKE '%1%'
      )
      AND file.directory NOT IN (
        '/var/ossec/agentless',
        '/var/ossec/bin',
        '/var/ossec/wodles',
        '/var/run/booted-system',
        '/var/run/current-system',
        '/var/run/current-system/sw/bin',
        '/var/select',
        '/var/db/xcode_select_link/usr/bin',
        '/var/db/xcode_select_link/usr/lib',
        '/var/db/xcode_select_link/usr/libexec',
        '/var/select/X11/bin',
        '/var/select/X11/lib/dri',
        '/var/select/X11/lib/flat_namespace',
        '/var/select/X11/lib',
        '/var/select/X11/libexec'
      )
      AND file.path NOT IN (
        '/var/log/acroUpdaterTools.log',
        '/var/vm/sleepimage'
      )
      AND file.size > 10
      AND hash.sha256 NOT IN (
        'fd53abe096b3617c32d46db34fad58770f697a3bf4aef3d8861f37d8471f6c98', -- sp_relauncher (Spotify)
        '65afd3fad04973e83d3cd3be56a310d11ed2c096319f1e2b20c4d153446f1b9f' -- sp_relauncher (Spotify)
      )
  description: Find unexpected executables in /var
  name: 'Detection - Evasion: Unexpected Var Executables Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find launchd entries which purport to be by Apple, but are not signed by Apple.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1543/004/ (Create or Modify System Process: Launch Daemon)
    --   * https://posts.specterops.io/hunting-for-bad-apples-part-1-22ef2b44c0aa
    --
    -- false positives:
    --   * none have been observed
    --
    -- platform: darwin
    -- tags: persistent launchd state
    select
      *
    FROM
      signature s
      JOIN launchd d ON d.program_arguments = s.path
    WHERE
      d.name LIKE 'com.apple.%'
      AND (
        signed = 0
        OR authority != 'Software Signing'
      )
      AND d.run_at_load = 1;
  description: Find launchd entries which purport to be by Apple, but are not signed by Apple.
  name: 'Detection - Persistence: Fake Apple Launchd'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unexpected systemd units, may be evidence of persistence
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1543/002/ (Create or Modify System Process: Systemd Service)
    --
    -- false positives:
    --   * System updates
    --
    -- tags: persistent seldom filesystem systemd
    SELECT
      description AS 'desc',
      fragment_path AS path,
      hash.sha256,
      file.ctime,
      file.size,
      CONCAT (
        id,
        ',',
        description,
        ',',
        user,
        ',',
        (file.size / 100) * 100
      ) AS exception_key
    FROM
      systemd_units
      LEFT JOIN hash ON systemd_units.fragment_path = hash.path
      LEFT JOIN file ON systemd_units.fragment_path = file.path
    WHERE
      active_state != 'inactive'
      AND sub_state != 'plugged'
      AND sub_state != 'mounted'
      AND fragment_path != ''
      AND NOT (
        (
          -- Only allow fragment paths in known good directories
          fragment_path LIKE '/lib/systemd/system/%'
          OR fragment_path LIKE '/usr/lib/systemd/system/%'
          OR fragment_path LIKE '/etc/systemd/system/%'
          OR fragment_path LIKE '/run/systemd/generator/%'
          OR fragment_path LIKE '/run/systemd/generator.late/%.service'
          OR fragment_path LIKE '/run/systemd/transient/%'
        )
        AND (
          exception_key IN (
            'abrtd.service,ABRT Automated Bug Reporting Tool,,400',
            'abrt-journal-core.service,Creates ABRT problems from coredumpctl messages,,200',
            'abrt-oops.service,ABRT kernel log watcher,,200',
            'abrt-xorg.service,ABRT Xorg log watcher,,200',
            'accounts-daemon.service,Accounts Service,,1900',
            'accounts-daemon.service,Accounts Service,,2100',
            'accounts-daemon.service,Accounts Service,,700',
            'acpid.path,ACPI Events Check,,100',
            'acpid.service,ACPI Daemon,,1100',
            'acpid.service,ACPI event daemon,,200',
            'acpid.socket,ACPID Listen Socket,,100',
            'akmods-keygen.target,akmods-keygen.target,,0',
            'akmods.service,Builds and install new kmods from akmod packages,,300',
            'alsa-restore.service,Save/Restore Sound Card State,,400',
            'alsa-restore.service,Save/Restore Sound Card State,,600',
            'alsa-state.service,Manage Sound Card State (restore and store),,400',
            'alsa-store.service,Store Sound Card State,,1200',
            'anacron.service,Run anacron jobs,,700',
            'anacron.timer,Trigger anacron every hour,,100',
            'apcupsd.service,APC UPS Power Control Daemon for Linux,,300',
            'apparmor.service,Load AppArmor profiles,,1100',
            'apport.service,LSB: automatic crash report generation,,500',
            'apt-daily.timer,Daily apt download activities,,100',
            'apt-daily-upgrade.timer,Daily apt upgrade and clean activities,,100',
            'archlinux-keyring-wkd-sync.service,Refresh existing keys of archlinux-keyring,,900',
            'archlinux-keyring-wkd-sync.timer,Refresh existing PGP keys of archlinux-keyring regularly,,100',
            'auditd.service,Security Auditing Service,,1700',
            'audit.service,Kernel Auditing,,1200',
            'avahi-daemon.service,Avahi mDNS/DNS-SD Stack,,1000',
            'avahi-daemon.socket,Avahi mDNS/DNS-SD Stack Activation Socket,,800',
            'basic.target,Basic System,,900',
            'blk-availability.service,Availability of block devices,,300',
            'blockdev@dev-mapper-cryptoswap.target,Block Device Preparation for /dev/mapper/cryptoswap,,400',
            'bluetooth.service,Bluetooth service,,700',
            'bluetooth.target,Bluetooth Support,,400',
            'bolt.service,Thunderbolt system service,,600',
            'chronyd.service,NTP client/server,,1500',
            'colord.service,Manage, Install and Generate Color Profiles,colord,200',
            'console-setup.service,Set console font and keymap,,300',
            'containerd.service,containerd container runtime,,1200',
            'cronie.service,Periodic Command Scheduler,,100',
            'cron.service,Regular background program processing daemon,,300',
            'cryptsetup.target,Local Encrypted Volumes,,400',
            'cups-browsed.service,Make remote CUPS printers available locally,,200',
            'cups.path,CUPS Scheduler,,100',
            'cups.service,CUPS Scheduler,,200',
            'cups.service,CUPS Scheduler,,300',
            'cups.socket,CUPS Scheduler,,100',
            'dbus-broker.service,D-Bus System Message Bus,,500',
            'dbus.service,D-Bus System Message Bus,,400',
            'dbus.service,D-Bus System Message Bus,,500',
            'dbus.socket,D-Bus System Message Bus Socket,,100',
            'dhcpcd.service,DHCP Client,,1700',
            'display-manager.service,X11 Server,,1700',
            'dkms.service,Builds and install new kernel modules through DKMS,,200',
            'dm-event.socket,Device-mapper event daemon FIFOs,,200',
            'dnf-makecache.service,dnf makecache,,400',
            'dnf-makecache.timer,dnf makecache --timer,,300',
            'docker.service,Docker Application Container Engine,,1100',
            'docker.service,Docker Application Container Engine,,1200',
            'docker.service,Docker Application Container Engine,,1300',
            'docker.service,Docker Application Container Engine,,1700',
            'docker.socket,Docker Socket for the API,,100',
            'docker.socket,Docker Socket for the API,,200',
            'dpkg-db-backup.timer,Daily dpkg database backup timer,,100',
            'dracut-shutdown.service,Restore /run/initramfs on shutdown,,400',
            'dracut-shutdown.service,Restore /run/initramfs on shutdown,,500',
            'e2scrub_all.timer,Periodic ext4 Online Metadata Check for All Filesystems,,200',
            'firewalld.service,firewalld - dynamic firewall daemon,,600',
            'firewall.service,Firewall,,1500',
            'flatpak-system-helper.service,flatpak system helper,,200',
            'fprintd.service,Fingerprint Authentication Daemon,,800',
            'fprintd.service,Fingerprint Authentication Daemon,,900',
            'fstrim.service,Discard unused blocks on filesystems from /etc/fstab,,400',
            'fstrim.timer,Discard unused blocks once a week,,200',
            'fwupd-refresh.service,Refresh fwupd metadata and update motd,fwupd-refresh,400',
            'fwupd-refresh.timer,Refresh fwupd metadata regularly,,100',
            'fwupd.service,Firmware update daemon,,600',
            'gdm.service,GNOME Display Manager,,800',
            'gdm.service,GNOME Display Manager,,900',
            'geoclue.service,Location Lookup Service,geoclue,400',
            'getty-pre.target,Preparation for Logins,,500',
            'getty.target,Login Prompts,,500',
            'graphical.target,Graphical Interface,,600',
            'gssproxy.service,GSSAPI Proxy Daemon,,400',
            'iio-sensor-proxy.service,IIO Sensor Proxy service,,400',
            'import-state.service,Import network configuration from initramfs,,400',
            'integritysetup.target,Local Integrity Protected Volumes,,400',
            'irqbalance.service,irqbalance daemon,,500',
            'iscsid.socket,Open-iSCSI iscsid Socket,,100',
            'iscsiuio.socket,Open-iSCSI iscsiuio Socket,,100',
            'iwd.service,Wireless service,,500',
            'kerneloops.service,Tool to automatically collect and submit kernel crash signatures,kernoops,300',
            'keyboard-setup.service,Set the console keyboard layout,,200',
            'kmod-static-nodes.service,Create List of Static Device Nodes,,700',
            'kolide-launcher.service,Kolide launcher,,1800',
            'kolide-launcher.service,Kolide launcher,,1900',
            'launcher.kolide-k2.service,The Kolide Launcher,,200',
            'ldconfig.service,Rebuild Dynamic Linker Cache,,600',
            'ldconfig.service,Rebuild Dynamic Linker Cache,,700',
            'libvirtd-admin.socket,Libvirt admin socket,,200',
            'libvirtd-ro.socket,Libvirt local read-only socket,,200',
            'libvirtd.service,Virtualization daemon,,1900',
            'libvirtd.socket,Libvirt local socket,,200',
            'lightdm.service,Light Display Manager,,300',
            'livesys-late.service,SYSV: Late init script for live image.,,500',
            'livesys.service,LSB: Init script for live image.,,500',
            'lm_sensors.service,Initialize hardware monitoring sensors,,300',
            'local-fs-pre.target,Preparation for Local File Systems,,400',
            'local-fs.target,Local File Systems,,500',
            'logrotate-checkconf.service,Logrotate configuration check,,1100',
            'logrotate.timer,Daily rotation of log files,,100',
            'logrotate.timer,logrotate.timer,,0',
            'low-memory-monitor.service,Low Memory Monitor,,600',
            'lvm2-lvmpolld.socket,LVM2 poll daemon socket,,200',
            'lvm2-monitor.service,Monitoring of LVM2 mirrors, snapshots etc. using dmeventd or progress polling,,500',
            'lvm2-monitor.service,Monitoring of LVM2 mirrors, snapshots etc. using dmeventd or progress polling,,600',
            'machine-qemu\\x2d2\\x2dwin10.scope,Virtual Machine qemu-2-win10,,300',
            'machine.slice,Virtual Machine and Container Slice,,400',
            'machines.target,Containers,,400',
            'man-db.service,Daily man-db regeneration,root,700',
            'man-db.timer,Daily man-db regeneration,,100',
            'mcelog.service,Machine Check Exception Logging Daemon,,200',
            'ModemManager.service,Modem Manager,root,400',
            'ModemManager.service,Modem Manager,root,500',
            'modprobe@efi_pstore.service,Load Kernel Module efi_pstore,,500',
            'modprobe@pstore_blk.service,Load Kernel Module pstore_blk,,500',
            'modprobe@pstore_zone.service,Load Kernel Module pstore_zone,,500',
            'modprobe@ramoops.service,Load Kernel Module ramoops,,500',
            'motd-news.timer,Message of the Day,,100',
            'mount-pstore.service,mount-pstore.service,,1100',
            'multi-user.target,Multi-User System,,500',
            'networkd-dispatcher.service,Dispatcher daemon for systemd-networkd,,200',
            'network-interfaces.target,All Network Interfaces (deprecated),,100',
            'network-local-commands.service,Extra networking commands.,,1300',
            'NetworkManager-dispatcher.service,Network Manager Script Dispatcher Service,,300',
            'NetworkManager-dispatcher.service,Network Manager Script Dispatcher Service,,600',
            'NetworkManager-dispatcher.service,Network Manager Script Dispatcher Service,,700',
            'NetworkManager.service,Network Manager,,1300',
            'NetworkManager.service,Network Manager,,1400',
            'NetworkManager-wait-online.service,Network Manager Wait Online,,1100',
            'NetworkManager-wait-online.service,Network Manager Wait Online,,1200',
            'network-online.target,Network is Online,,500',
            'network-pre.target,Preparation for Network,,500',
            'network-setup.service,Networking Setup,,1300',
            'network.target,Network,,500',
            'nfs-client.target,NFS client services,,400',
            'nginx.service,Nginx Web Server,nginx,2400',
            'nix-daemon.service,Nix Daemon,,400',
            'nix-daemon.socket,Nix Daemon Socket,,200',
            'nix-gc.timer,nix-gc.timer,,0',
            'nscd.service,Name Service Cache Daemon,nscd,1700',
            'nscd.service,Name Service Cache Daemon,nscd,1800',
            'nss-lookup.target,Host and Network Name Lookups,,500',
            'nss-user-lookup.target,User and Group Name Lookups,,500',
            'nvidia-persistenced.service,NVIDIA Persistence Daemon,,300',
            'openvpn.service,OpenVPN service,,200',
            'packagekit.service,PackageKit Daemon,root,300',
            'paths.target,Path Units,,400',
            'pcscd.service,PC/SC Smart Card Daemon,,200',
            'pcscd.socket,PC/SC Smart Card Daemon Activation Socket,,100',
            'phpsessionclean.timer,Clean PHP session files every 30 mins,,100',
            'plocate-updatedb.service,Update the plocate database,,200',
            'plocate-updatedb.timer,Update the plocate database daily,,100',
            'plymouth-quit-wait.service,Hold until boot process finishes up,,200',
            'plymouth-read-write.service,Tell Plymouth To Write Out Runtime Data,,200',
            'plymouth-start.service,Show Plymouth Boot Screen,,500',
            'plymouth-start.service,Show Plymouth Boot Screen,,600',
            'polkit.service,Authorization Manager,,100',
            'polkit.service,Authorization Manager,,200',
            'power-profiles-daemon.service,Power Profiles daemon,,600',
            'power-profiles-daemon.service,Power Profiles daemon,,700',
            'proc-sys-fs-binfmt_misc.automount,Arbitrary Executable File Formats File System Automount Point,,700',
            'qemu-kvm.service,QEMU KVM preparation - module, ksm, hugepages,,300',
            'raid-check.timer,Weekly RAID setup health check,,100',
            'reflector.service,Refresh Pacman mirrorlist with Reflector.,,1500',
            'reflector.timer,Refresh Pacman mirrorlist weekly with Reflector.,,100',
            'reload-systemd-vconsole-setup.service,Reset console on configuration changes,,1200',
            'remote-fs-pre.target,Preparation for Remote File Systems,,400',
            'remote-fs.target,Remote File Systems,,500',
            'resolvconf.service,resolvconf update,,1100',
            'rpc_pipefs.target,rpc_pipefs.target,,0',
            'rpc-statd-notify.service,Notify NFS peers of a restart,,300',
            'rsyslog.service,System Logging Service,,400',
            'rtkit-daemon.service,RealtimeKit Scheduling Policy Service,,1000',
            'setvtrgb.service,Set console scheme,,300',
            'shadow.service,Verify integrity of password and group files,,300',
            'shadow.timer,Daily verification of password and group files,,100',
            'sleep.target,Sleep,,400',
            '-.slice,Root Slice,,0',
            'slices.target,Slice Units,,400',
            'smartcard.target,Smart Card,,400',
            'snapd.apparmor.service,Load AppArmor profiles managed internally by snapd,,800',
            'snapd.seeded.service,Wait until snapd is fully seeded,,300',
            'snapd.service,Snap Daemon,,400',
            'snapd.service,Snap Daemon,,500',
            'snapd.socket,Socket activation for snappy daemon,,200',
            'sockets.target,Socket Units,,400',
            'sound.target,Sound Card,,400',
            'sshd.service,OpenSSH Daemon,,200',
            'sshd.service,SSH Daemon,,1600',
            'sssd-kcm.service,SSSD Kerberos Cache Manager,,400',
            'sssd-kcm.socket,SSSD Kerberos Cache Manager responder socket,,100',
            'swap.target,Swaps,,400',
            'switcheroo-control.service,Switcheroo Control Proxy service,,400',
            'sysinit.target,System Initialization,,500',
            'syslog.socket,Syslog Socket,,1400',
            'sysstat-collect.timer,Run system activity accounting tool every 10 minutes,,300',
            'sysstat.service,Resets System Activity Logs,root,400',
            'sysstat-summary.timer,Generate summary of yesterday''s process accounting,,300',
            'systemd-ask-password-console.path,Dispatch Password Requests to Console Directory Watch,,700',
            'systemd-ask-password-plymouth.path,Forward Password Requests to Plymouth Directory Watch,,400',
            'systemd-ask-password-plymouth.path,Forward Password Requests to Plymouth Directory Watch,,500',
            'systemd-ask-password-wall.path,Forward Password Requests to Wall Directory Watch,,600',
            'systemd-binfmt.service,Set Up Additional Binary Formats,,1200',
            'systemd-boot-update.service,Automatic Boot Loader Update,,600',
            'systemd-coredump.socket,Process Core Dump Socket,,500',
            'systemd-cryptsetup@cryptoswap.service,Cryptography Setup for cryptoswap,,900',
            'systemd-fsckd.socket,fsck to fsckd communication Socket,,500',
            'systemd-homed-activate.service,Home Area Activation,,600',
            'systemd-homed.service,Home Area Manager,,1300',
            'systemd-hostnamed.service,Hostname Service,,1100',
            'systemd-hostnamed.service,Hostname Service,,1200',
            'systemd-initctl.socket,initctl Compatibility Named Pipe,,500',
            'systemd-journal-catalog-update.service,Rebuild Journal Catalog,,700',
            'systemd-journald-audit.socket,Journal Audit Socket,,600',
            'systemd-journald-dev-log.socket,Journal Socket (/dev/log),,1100',
            'systemd-journald.service,Journal Service,,1800',
            'systemd-journald.socket,Journal Socket,,900',
            'systemd-journal-flush.service,Flush Journal to Persistent Storage,,800',
            'systemd-localed.service,Locale Service,,1200',
            'systemd-logind.service,User Login Management,,2000',
            'systemd-logind.service,User Login Management,,2100',
            'systemd-machined.service,Virtual Machine and Container Registration Service,,1200',
            'systemd-machined.service,Virtual Machine and Container Registration Service,,1300',
            'systemd-modules-load.service,Load Kernel Modules,,1000',
            'systemd-network-generator.service,Generate network units from Kernel command line,,600',
            'systemd-oomd.service,Userspace Out-Of-Memory (OOM) Killer,systemd-oom,1600',
            'systemd-oomd.service,Userspace Out-Of-Memory (OOM) Killer,systemd-oom,1700',
            'systemd-oomd.socket,Userspace Out-Of-Memory (OOM) Killer Socket,,600',
            'systemd-random-seed.service,Load/Save Random Seed,,1100',
            'systemd-random-seed.service,Load/Save Random Seed,,1200',
            'systemd-remount-fs.service,Remount Root and Kernel File Systems,,700',
            'systemd-remount-fs.service,Remount Root and Kernel File Systems,,800',
            'systemd-resolved.service,Network Name Resolution,systemd-resolve,1700',
            'systemd-rfkill.socket,Load/Save RF Kill Switch Status /dev/rfkill Watch,,700',
            'systemd-suspend.service,System Suspend,,500',
            'systemd-sysctl.service,Apply Kernel Variables,,700',
            'systemd-sysusers.service,Create System Users,,1000',
            'systemd-timedated.service,Time & Date Service,,1100',
            'systemd-timesyncd.service,Network Time Synchronization,systemd-timesync,1700',
            'systemd-timesyncd.service,Network Time Synchronization,systemd-timesync,1800',
            'systemd-tmpfiles-clean.timer,Daily Cleanup of Temporary Directories,,500',
            'systemd-tmpfiles-setup-dev.service,Create Static Device Nodes in /dev,,700',
            'systemd-tmpfiles-setup-dev.service,Create Static Device Nodes in /dev,,800',
            'systemd-tmpfiles-setup.service,Create Volatile Files and Directories,,700',
            'systemd-tmpfiles-setup.service,Create Volatile Files and Directories,,800',
            'systemd-udevd-control.socket,udev Control Socket,,600',
            'systemd-udevd-kernel.socket,udev Kernel Socket,,600',
            'systemd-udevd.service,Rule-based Manager for Device Events and Files,,1200',
            'systemd-udevd.service,Rule-based Manager for Device Events and Files,,1300',
            'systemd-udev-settle.service,Wait for udev To Complete Device Initialization,,800',
            'systemd-udev-trigger.service,Coldplug All udev Devices,,700',
            'systemd-update-done.service,Update is Completed,,600',
            'systemd-update-done.service,Update is Completed,,700',
            'systemd-update-utmp.service,Record System Boot/Shutdown in UTMP,,700',
            'systemd-update-utmp.service,Record System Boot/Shutdown in UTMP,,800',
            'systemd-update-utmp.service,Record System Boot/Shutdown in UTMP,,900',
            'systemd-userdbd.service,User Database Manager,,1100',
            'systemd-userdbd.socket,User Database Manager Socket,,600',
            'systemd-user-sessions.service,Permit User Sessions,,600',
            'systemd-user-sessions.service,Permit User Sessions,,700',
            'systemd-vconsole-setup.service,Setup Virtual Console,,600',
            'systemd-vconsole-setup.service,Setup Virtual Console,,700',
            'system.slice,System Slice,,0',
            'tailscaled.service,Tailscale node agent,,600',
            'tailscaled.service,Tailscale node agent,,700',
            'thermald.service,Thermal Daemon Service,,300',
            'timers.target,Timer Units,,400',
            'time-set.target,System Time Set,,400',
            'tlp.service,TLP system startup/shutdown,,500',
            'ua-timer.timer,Ubuntu Advantage Timer for running repeated jobs,,100',
            'udisks2.service,Disk Manager,,200',
            'ufw.service,Uncomplicated firewall,,300',
            'unattended-upgrades.service,Unattended Upgrades Shutdown,,300',
            'unbound-anchor.timer,daily update of the root trust anchor for DNSSEC,,300',
            'updatedb.timer,Daily locate database update,,100',
            'update-notifier-download.timer,Download data for packages that failed at package install time,,200',
            'update-notifier-motd.timer,Check to see whether there is a new version of Ubuntu available,,300',
            'upower.service,Daemon for power management,,900',
            'usbmuxd.service,Socket daemon for the usbmux protocol used by Apple devices,,200',
            'uresourced.service,User resource assignment daemon,,300',
            'user.slice,User and Session Slice,,400',
            'uuidd.socket,UUID daemon activation socket,,100',
            'veritysetup.target,Local Verity Protected Volumes,,400',
            'virtinterfaced.socket,Libvirt interface local socket,,200',
            'virtlockd.socket,Virtual machine lock manager socket,,100',
            'virtlogd-admin.socket,Virtual machine log manager socket,,200',
            'virtlogd.service,Virtual machine log manager,,800',
            'virtlogd.socket,Virtual machine log manager socket,,100',
            'virtnetworkd.socket,Libvirt network local socket,,200',
            'virtnodedevd.socket,Libvirt nodedev local socket,,200',
            'virtnwfilterd.socket,Libvirt nwfilter local socket,,200',
            'virtproxyd.socket,Libvirt proxy local socket,,300',
            'virtqemud-admin.socket,Libvirt qemu admin socket,,200',
            'virtqemud-ro.socket,Libvirt qemu local read-only socket,,200',
            'virtqemud.socket,Libvirt qemu local socket,,200',
            'virtsecretd.socket,Libvirt secret local socket,,200',
            'virtstoraged.socket,Libvirt storage local socket,,200',
            'whoopsie.path,Start whoopsie on modification of the /var/crash directory,,100',
            'wpa_supplicant.service,WPA supplicant,,300',
            'zfs-import-cache.service,Import ZFS pools by cache file,,500',
            'zfs-import.target,ZFS pool import target,,100',
            'zfs-load-key-rpool.service,Load ZFS key for rpool,,700',
            'zfs-load-module.service,Install ZFS kernel module,,300',
            'zfs-mount.service,Mount ZFS filesystems,,300',
            'zfs-mount.service,Mount ZFS filesystems,,400',
            'zfs-scrub.service,ZFS pools scrubbing,,1000',
            'zfs-scrub.timer,zfs-scrub.timer,,0',
            'zfs-share.service,ZFS file system shares,,400',
            'zfs-snapshot-daily.service,ZFS auto-snapshotting every day,,1000',
            'zfs-snapshot-daily.timer,zfs-snapshot-daily.timer,,0',
            'zfs-snapshot-frequent.service,ZFS auto-snapshotting every 15 mins,,1000',
            'zfs-snapshot-frequent.timer,zfs-snapshot-frequent.timer,,0',
            'zfs-snapshot-hourly.service,ZFS auto-snapshotting every hour,,1000',
            'zfs-snapshot-hourly.timer,zfs-snapshot-hourly.timer,,0',
            'zfs-snapshot-monthly.timer,zfs-snapshot-monthly.timer,,0',
            'zfs-snapshot-weekly.service,ZFS auto-snapshotting every week,,1000',
            'zfs-snapshot-weekly.timer,zfs-snapshot-weekly.timer,,0',
            'zfs.target,ZFS startup target,,0',
            'zfs-volumes.target,ZFS volumes are ready,,100',
            'zfs-volume-wait.service,Wait for ZFS Volume (zvol) links in /dev,,200',
            'zfs-zed.service,ZFS Event Daemon (zed),,200',
            'znapzend.service,ZnapZend - ZFS Backup System,root,1700',
            'zpool-trim.service,ZFS pools trim,,1200',
            'zpool-trim.timer,zpool-trim.timer,,0'
          )
          OR exception_key LIKE 'machine-qemu%,Virtual Machine qemu%,,300'
          OR id LIKE 'blockdev@dev-mapper-luks%.target'
          OR id LIKE 'blockdev@dev-mapper-nvme%.target'
          OR id LIKE 'dbus-:%-org.freedesktop.problems@0.service'
          OR id LIKE 'dev-disk-by%.swap'
          OR id LIKE 'dev-mapper-%.swap'
          OR id LIKE 'dev-zram%.swap'
          OR id LIKE 'docker-%.scope'
          OR id LIKE 'getty@tty%.service'
          OR id LIKE 'home-manager-%.service'
          OR id LIKE 'lvm2-pvscan@%.service'
          OR id LIKE 'session-%.scope'
          OR id LIKE 'system-systemd%cryptsetup.slice'
          OR id LIKE 'systemd-backlight@%.service'
          OR id LIKE 'systemd-cryptsetup@luks%.service'
          OR id LIKE 'systemd-cryptsetup@nvme%.service'
          OR id LIKE 'systemd-fsck@dev-disk-by%service'
          OR id LIKE 'systemd-zram-setup@zram%.service'
          OR id LIKE 'user-runtime-dir@%.service'
          OR id LIKE 'user@%.service'
          OR id LIKE 'akmods@%64.service'
        )
      )
  description: Unexpected systemd units, may be evidence of persistence
  name: 'Detection - Persistence: Unexpected Active Systemd Units'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Highlight chrome extensions with wide-ranging permissions that are not part of your whitelist
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1176/ (Browser Extensions)
    --
    -- false positives:
    --   * Almost unlimited: any extension that isn't on your whitelist
    --
    -- tags: persistent seldom browser
    SELECT
      name,
      profile,
      chrome_extensions.description AS 'descr',
      persistent AS persists,
      author,
      chrome_extensions.path,
      referenced AS in_config,
      file.ctime,
      from_webstore AS in_store,
      TRIM(CAST(permissions AS text)) AS perms,
      state AS 'enabled',
      CONCAT (
        from_webstore,
        ',',
        author,
        ',',
        name,
        ',',
        identifier,
        ',',
        TRIM(CAST(permissions AS text))
      ) AS exception_key,
      hash.sha256
    FROM
      users
      CROSS JOIN chrome_extensions USING (uid)
      LEFT JOIN file ON chrome_extensions.path = file.path
      LEFT JOIN hash ON chrome_extensions.path = hash.path
    WHERE
      (
        from_webstore != 'true'
        OR perms LIKE '%google.com%'
        OR perms LIKE '%chainguard%'
        OR perms LIKE '%github.com%'
        OR perms LIKE '%clipboardWrite%'
        OR perms LIKE '%<all_urls>%'
        OR perms LIKE '%tabs%'
        OR perms LIKE '%cookies%'
        OR perms LIKE '%://*/%'
      )
      AND enabled = 1
      AND exception_key NOT IN (
        'false,Anthony Feddersen - Chainguard, Inc.,Chainguard On-Call Chrome Extension,,background', -- TODO: Move to local exceptions list once osqtool supports them
        'false,,Google Chat,chfbpgnooceecdoohagngmjnndbbaeip,', -- Deprecated Google Extension
        'false,,Google Chat,mdpkiolbdkhdjpekfbkbmhigcaggjagi,', -- Deprecated Google Extension
        'false,,Google Cloud,gmdcbpephenfeelhagpbceidhdbobfpk,', -- Deprecated Google Extension
        'false,,Google Drive,aghbiahbpaijignceidepookljebhfak,', -- Deprecated Google Extension
        'false,,Google Photos,ncmjhecbjeaamljdfahankockkkdmedg,', -- Deprecated Google Extension
        'false,,YouTube,agimnkijcaahngcdmfeangaknmldooml,', -- Deprecated Google Extension
        'true,Adaware,Safe Torrent Scanner,aegnopegbbhjeeiganiajffnalhlkkjb,storage, tabs',
        'true,,Adblock for Youtube,cmedhionkhpnakcndndgjdbohmhepckk,storage, unlimitedStorage, webRequest, webRequestBlocking, <all_urls>',
        'true,,Add to Amazon Wish List,ciagpekplgpbepdgggflgmahnjgiaced,tabs, http://*/*, https://*/*',
        'true,,Adobe Acrobat: PDF edit, convert, sign tools,efaidnbmnnnibpcajpcglclefindmkaj,contextMenus, <all_urls>, tabs, downloads, nativeMessaging, webRequest, webRequestBlocking',
        'true,AgileBits,1Password extension (desktop app required),aomjjhallfgjeglblehebfpbcfeobpgk,contextMenus, nativeMessaging, storage, tabs, webRequest, webRequestBlocking, http://*/*, https://*/*',
        'true,AgileBits,1Password  Password Manager,aeblfdkhhhdcdjpifhhbdiojplfjncoa,<all_urls>, contextMenus, downloads, idle, management, nativeMessaging, notifications, privacy, tabs, webNavigation, webRequest, webRequestBlocking',
        'true,Alexander Shutau,Dark Reader,eimadpbcbfnmbkopoojfekhnkhdbieeh,alarms, fontSettings, storage, tabs, <all_urls>',
        'true,All uBlock contributors,uBlock - free ad blocker,epcnnfbjfcgphgdmggkamkmgojdagdnn,contextMenus, storage, tabs, unlimitedStorage, webNavigation, webRequest, webRequestBlocking, <all_urls>',
        'true,,Bardeen - automate workflows with one click,ihhkmalpkhkoedlmcnilbbhhbhnicjga,<all_urls>, webNavigation, unlimitedStorage, notifications, activeTab, tabs, storage, *://*/*, history, bookmarks, contextMenus',
        'true,BetaFish,AdBlock  best ad blocker,gighmmpiobklfepjocnamgkkbiglidom,tabs, <all_urls>, contextMenus, webRequest, webRequestBlocking, webNavigation, storage, unlimitedStorage, notifications, idle, alarms',
        'true,Bitwarden Inc.,Bitwarden - Free Password Manager,nngceckbapebfimnlniiiahkandclblb,tabs, contextMenus, storage, unlimitedStorage, clipboardRead, clipboardWrite, idle, http://*/*, https://*/*, webRequest, webRequestBlocking',
        'true,,BrowserStack Local,mfiddfehmfdojjfdpfngagldgaaafcfo,https://*.bsstag.com/*, https://*.browserstack.com/*, , clipboardWrite, app.window, storage',
        'true,,Capital One Shopping: Add to Chrome for Free,nenlahapcbofgnanklpelkaejcehkggg,tabs, contextMenus, storage, cookies, webRequest, webRequestBlocking, <all_urls>',
        'true,,Caret,fljalecfjciodhpcledpamjachpmelml,clipboardRead, clipboardWrite, contextMenus, storage, notifications, syncFileSystem, app.window.fullscreen.overrideEsc,',
        'true,chromeos-recovery-tool-admin@google.com,Chromebook Recovery Utility,jndclpdbaamdhonoechobihbbiimdgai,https://dl.google.com/dl/edgedl/chromeos/recovery/recovery2.json, https://dl.google.com/dl/edgedl/chromeos/recovery/cloudready_recovery2.json, https://www.google-analytics.com/, chromeosInfoPrivate, feedbackPrivate, fileSystem, imageWriterPrivate, metricsPrivate, storage',
        'true,,Chrome RDP for Google Cloud Platform,mpbbnannobiobpnfblimoapbephgifkm,clipboardRead, clipboardWrite, unlimitedStorage, storage, notifications, overrideEscFullscreen,',
        'true,,Chrome Remote Desktop,inomeogfingihgjfjlpeplalcfajhgai,clipboardRead, clipboardWrite, nativeMessaging, downloads, downloads.open',
        'true,,Chrome Web Store Payments,nmmhkkegccagdldgiimedpiccmgmieda,identity, webview, https://www.google.com/, https://www.googleapis.com/*, https://payments.google.com/payments/v4/js/integrator.js, https://sandbox.google.com/payments/v4/js/integrator.js',
        'true,,Clear Cache,cppjkneekbjaeellbfkmgnhonkkjfpdn,browsingData, cookies, <all_urls>',
        'true,,ClickUp: Tasks, Screenshots, Email, Time,pliibjocnfmkagafnbkfcimonlnlpghj,alarms, identity, storage, unlimitedStorage, tabs, activeTab, notifications, contextMenus, downloads, <all_urls>, http://*/*, https://*/*',
        'true,,Clockify Time Tracker,pmjeegjhjdlccodhacdgbgfagbpmccpe,background, contextMenus, storage, tabs, activeTab, identity, idle, notifications, scripting, alarms',
        'true,Clockwise Inc.,Clockwise: Team Time & Calendar Management,hjcneejoopafkkibfbcaeoldpjjiamog,activeTab, https://calendar.google.com/calendar/*',
        'true,,Cloud9,nbdmccoknlfggadpfkmcpnamfnbkmkcp,clipboardRead, clipboardWrite',
        'true,,Cloud Vision,nblmokgbialjjgfhfofbgfcghhbkejac,clipboardWrite, contextMenus, notifications, file://*, <all_urls>',
        'true,,coLaboratory Notebook,pianggobfjcgeihlmfhfgkfalopndooo,identity, , webview, , unlimitedStorage, storage, clipboardRead, clipboardWrite,',
        'true,,ColorPick Eyedropper,ohcpnigalekghcmgcdcenkpelffpdolg,activeTab, tabs, <all_urls>, storage, alarms',
        'true,,Copper CRM for Gmail,hpfmedbkgaakgagknibnonpkimkibkla,https://app.copper.com/, *://*.googleusercontent.com/proxy/*, *://calendar.google.com/*, *://mail.google.com/*, notifications, storage, tabs, webRequest, webRequestBlocking',
        'true,,Copper CRM for Gmail,hpfmedbkgaakgagknibnonpkimkibkla,https://app.copper.com/, webRequest, webRequestBlocking, *://mail.google.com/*, tabs, storage, notifications, *://calendar.google.com/*',
        'true,,CSS Scan,gieabiemggnpnminflinemaickipbebg,storage, activeTab, <all_urls>, contextMenus, clipboardWrite',
        'true,,DEPRECATED Secure Shell App,pnhechapfaindjhompbnflcldabbghjo,clipboardRead, clipboardWrite, idle, notifications, storage, terminalPrivate, unlimitedStorage, fileSystemProvider, accessibilityFeatures.read, crashReportPrivate, metricsPrivate',
        'true,,DuckDuckGo Privacy Essentials,bkdgflcldnnnapblkhphbgpggdiikppg,contextMenus, webRequest, webRequestBlocking, *://*/*, webNavigation, activeTab, tabs, storage, <all_urls>, alarms',
        'true,,DuckDuckGo Privacy Essentials,bkdgflcldnnnapblkhphbgpggdiikppg,contextMenus, webRequest, webRequestBlocking, :///*, webNavigation, activeTab, tabs, storage, <all_urls>, alarms',
        'true,,EditThisCookie,fngmhnnpilhplaeedifhccceomclgfbg,tabs, <all_urls>, cookies, contextMenus, notifications, clipboardWrite, webRequest, webRequestBlocking',
        'true,,Endpoint Verification,callobklhcbilhphinckomhgkigmfocg,cookies, idle, nativeMessaging, storage, *://*.google.com/*, download, enterprise.reportingPrivate, browsingData, enterprise.deviceAttributes, enterprise.platformKeys, gcm, identity, identity.email, platformKeys',
        'true,,Eno from Capital One,clmkdohmabikagpnhjmgacbclihgmdje,activeTab, tabs, storage, cookies, webRequest, webRequestBlocking, https://*.capitalone.com/*, http://*.capitalone.com/*',
        'true,,Espruino Web IDE,bleoifhkdalbjfbobjackfdifdneehpo,serial, audioCapture, videoCapture, , storage, http://*/, https://*/',
        'true,,Event Merge for Google Calendar,idehaflielbgpaokehlhidbjlehlfcep,https://www.google.com/calendar/*, https://calendar.google.com/*, storage',
        'true,ExpressVPN,ExpressVPN: VPN proxy for a better internet,fgddmllnllkalaagkghckoinaemmogpe,cookies, nativeMessaging, privacy, storage, webRequest, webRequestBlocking, tabs, unlimitedStorage, notifications, <all_urls>',
        'true,eyeo GmbH,Adblock Plus - free ad blocker,cfhdojbkjhnklbpkdaibdccddilifddb,<all_urls>, contextMenus, notifications, storage, tabs, unlimitedStorage, webNavigation, webRequest, webRequestBlocking',
        'true,,Facebook Pixel Helper,fdgfkebogiimcoedlicjlajpkdmockpc,tabs, webNavigation, webRequest, webRequestBlocking, storage, identity, *://*/*, clipboardWrite',
        'true,,Google Analytics Parameter Stripper,jbgedkkfkohoehhkknnmlodlobbhafge,webNavigation, <all_urls>',
        'true,,Google Docs Offline,ghbmnnjooekpmoecnnnilnnbdlolhkhi,alarms, storage, unlimitedStorage, https://docs.google.com/*, https://drive.google.com/*',
        'true,,Google Drive,apdfllckaahabafndbhieahigkjlhalf,clipboardRead, clipboardWrite, notifications',
        'true,,Google Hangouts,nckgahadagoaajjgafhacjanaoiihapd,alarms, background, cookies, idle, notifications, storage, system.display, tabs, *://*.google.com/*',
        'true,,Google Keep Chrome Extension,lpcaedmchfhocbbapmcbpinfpgnhiddi,activeTab, identity, identity.email, contextMenus, file://*/*, http://*/, https://*/, storage, tabs, unlimitedStorage',
        'true,,Google Keep - Notes and Lists,hmjkmjkepdijhoojdojkdfohbdgmmhki,fileSystem, identity, identity.email, storage, unlimitedStorage, https://*.googleapis.com/, https://keep.google.com/media/, https://*.googleusercontent.com/, https://*.client-channel.google.com/client-channel, https://clients4.google.com/client-channel/client, https://www.google-analytics.com/, https://www.google.com/, https://play.google.com/log, geolocation, management, notifications',
        'true,,Google Mail Checker,mihcahmgecmbnbcchbopgniflfhgnkff,alarms, tabs, webNavigation, *://*.google.com/',
        'true,,Google Optimize,bhdplaindhdkiflmbfbciehdccfhegci,storage, debugger, webRequest, webRequestBlocking, tabs, http://*/, https://*/',
        'true,,Google Play Books,mmimngoggfoobjdlefbcabngfnmieonb,clipboardWrite, unlimitedStorage',
        'true,,Grammarly: Grammar Checker and Writing App,kbfnbcaeplbcioakkpcpgfkobkghlhen,http://*/*, https://*/*, tabs, notifications, cookies, storage',
        'true,,GSConnect,jfnifeihccihocjbfcfhicmmgpjicaec,nativeMessaging, tabs, contextMenus',
        'true,Guilherme Nascimento,Prevent Duplicate Tabs,eednccpckdkpojaiemedoejdngappaag,tabs',
        'true,,Honey: Automatic Coupons & Cash Back,bmnlcjabgnpnenekpadlanbbkooimhnj,cookies, storage, unlimitedStorage, webRequest, webRequestBlocking, http://*/*, https://*/*',
        'true,,HTTPS Everywhere,gcbommkclmclpchllfjekcdonpmejbdp,webNavigation, webRequest, webRequestBlocking, tabs, cookies, storage, *://*/*, ftp://*/*',
        'true,https://metamask.io,MetaMask,nkbihfbeogaeaoehlefnkodbefgpgknn,storage, unlimitedStorage, clipboardWrite, http://localhost:8545/, https://*.infura.io/, https://chainid.network/chains.json, https://lattice.gridplus.io/*, activeTab, webRequest, *://*.eth/, notifications',
        'true,James Anderson,LeechBlock NG,blaaajhemilngeeffpbfkdjjoefldkok,downloads, contextMenus, storage, tabs, unlimitedStorage, webNavigation',
        'true,,Jitsi Meetings,kglhbbefdnlheedjiejgomgmfplipfeb,https://calendar.google.com/*',
        'true,,JSON Formatter,bcjindcccaagfpapjjmafapmmgkkhgoa,*://*/*, <all_urls>',
        'true,Kas Elvirov,GitHub Gloc,kaodcnpebhdbpaeeemkiobcokcnegdki,storage, *://*.github.com/*',
        'true,Keepa GmbH,Keepa - Amazon Price Tracker,neebplgakaahbhdphmkckjjcegoiijjo,storage, cookies, contextMenus, *://*.keepa.com/*, *://*.amazon.com/*, *://*.amzn.com/*, *://*.amazon.co.uk/*, *://*.amazon.de/*, *://*.amazon.fr/*, *://*.amazon.it/*, *://*.amazon.ca/*, *://*.amazon.com.mx/*, *://*.amazon.es/*, *://*.amazon.co.jp/*, *://*.amazon.in/*, *://*.amazon.com.br/*, *://*.amazon.nl/*, *://*.amazon.com.au/*',
        'true,LastPass,LastPass: Free Password Manager,hdokiejnpimakedhajhdlcegeplioahd,tabs, idle, notifications, contextMenus, unlimitedStorage, webRequest, webNavigation, webRequestBlocking, http://*/*, https://*/*, chrome://favicon/*',
        'true,Leadjet,Leadjet - Make your CRM work on LinkedIn,kojhcdejfimplnokhhhekhiapceggamn,storage, tabs, cookies',
        'true,,Lolli: Earn Bitcoin When You Shop,fleenceagaplaefnklabikkmocalkcpo,<all_urls>, tabs, webNavigation, webRequest',
        'true,,Loom  Free Screen Recorder & Screen Capture,liecbddmkiiihnedobmlmillhodjkdmb,<all_urls>, tabCapture, webNavigation, activeTab, contextMenus, storage, tabs, desktopCapture, notifications, cookies, *://*.useloom.com/, *://*.loom.com/, http://localhost/*',
        'true,,Loom  Free Screen Recorder & Screen Capture,liecbddmkiiihnedobmlmillhodjkdmb,tabCapture, webNavigation, activeTab, contextMenus, storage, tabs, desktopCapture, notifications, cookies, *://*.useloom.com/, *://*.loom.com/, http://localhost/*',
        'true,,Lucidchart Diagrams,apboafhkiegglekeafbckfjldecefkhn,unlimitedStorage, notifications, clipboardRead, clipboardWrite',
        'true,,Markdown Preview Plus,febilkbfcbhebfnokafefeacimjdckgl,storage, clipboardWrite, <all_urls>',
        'true,NortonLifeLock Inc,Norton Safe Web,fnpbeacklnhmkkilekogeiekaglbmmka,tabs, background, webNavigation, storage, <all_urls>, webRequest, webRequestBlocking, downloads, notifications',
        'true,,Notion Web Clipper,knheggckgoiihginacbkhaalnibhilkk,activeTab, storage, cookies',
        'true,,Office Editing for Docs, Sheets & Slides,gbkeegbaiigmenfmjfclcdgdpimamgkj,clipboardRead, clipboardWrite, cookies, downloads, *://*.google.com/*, fileSystem, fileSystem.write, https://www.google-analytics.com/, https://www.googleapis.com/, identity, identity.email, metricsPrivate, storage, unlimitedStorage',
        'true,,Okta Browser Plugin,glnpjglilkicbckjpbgcfkogebgllemb,tabs, cookies, https://*/, http://*/, storage, unlimitedStorage, webRequest, webRequestBlocking, webNavigation',
        'true,,OneTab,chphlpgkkbolifaimnlloiipkdnihall,chrome://favicon/, unlimitedStorage, storage, tabs, contextMenus, activeTab',
        'true,Opera Software AS,Rich Hints Agent,enegjkbbakeegngfapepobipndnebkdk,boosterPrivate, cashbackPrivate, browserSidebarPrivate, downloads, history, limitersPrivate, management, operaBrowserPrivate, powerSavePrivate, richHintsAgentPrivate, settingsPrivate, speeddialPrivate, storage, tabs, uiTrackerPrivate, windows, http://*/, https://*/',
        'true,,Page Analytics (by Google),fnbdnhhicmebfgdgglcdacdapkcihcoh,storage, https://www.googleapis.com/, tabs, *://*/*, background, cookies, *://*.google.com/*, webNavigation, webRequest, *://*.google-analytics.com/*, *://stats.g.doubleclick.net/*',
        'true,,Password Alert,noondiphcddnnabmjcihcjfbhfklnnep,identity, identity.email, notifications, storage, tabs, <all_urls>',
        'true,Pawel Psztyc,Advanced REST client,hgmloofddffdnphfgcellkdfbfbjeloo,<all_urls>, storage, unlimitedStorage, identity, syncFileSystem,',
        'true,,Picture-in-Picture Extension (by Google),hkgfoiooedgoejojocmhlaklaeopbecg,<all_urls>, storage',
        'true,,Postman,fhbjgbiflinjbdggehcddcbncdddomop,webview, system.display, http://*/*, https://*/*, contextMenus, unlimitedStorage, storage, fileSystem, fileSystem.write, notifications, identity,',
        'true,,Privacy Badger,pkehgijcmpdhfbdbbnkijodmdjhbjlgp,tabs, http://*/*, https://*/*, webNavigation, webRequest, webRequestBlocking, storage, privacy',
        'true,,Private Internet Access,jplnlifepflhkbkgonidnobkakhmpnmh,activeTab, storage, unlimitedStorage, cookies, webRequest, webRequestBlocking, proxy, privacy, contentSettings, alarms, background, downloads, <all_urls>',
        'true,,QuillBot for Chrome,iidnbdjijdkbmajdffnidomddglmieko,alarms, cookies, storage, activeTab, contextMenus, notifications, scripting',
        'true,Raymond Hill & contributors,uBlock Origin,cjpalhdlnbpafiamejdnhcphjbkeiagm,contextMenus, privacy, storage, tabs, unlimitedStorage, webNavigation, webRequest, webRequestBlocking, <all_urls>',
        'true,,React Developer Tools,fmkadmapgofadopljbjfkapdkoienihi,file:///*, http://*/*, https://*/*',
        'true,,Reader Mode,llimhhconnjiflfimocjggfjdlmlhblm,tabs, activeTab, contextMenus, http://*/*, https://*/*, storage',
        'true,Reddit Enhancement Suite contributors,Reddit Enhancement Suite,kbmfpngjjgdllneeigpgjifpgocmfgmb,https://*.reddit.com/*, tabs, history, storage, unlimitedStorage, webRequest',
        'true,,RSS Subscription Extension (by Google),nlbjncdgjeocebhnmkbbbdekmmmcbfjd,tabs, http://*/*, https://*/*, storage',
        'true,,Save to Google Drive,gmbmikajjgmnabiglmofipeabaddhgne,contextMenus, identity, printerProvider, notifications, pageCapture, storage, tabs, webRequest, <all_urls>',
        'true,,Save to Pocket,niloccemoadcdkdjlinkgdfekeahmflj,tabs, contextMenus, cookies, storage',
        'true,,Secure Shell,iodihamcpbpeioajjeobimgagajmlibd,clipboardRead, clipboardWrite, contextMenus, idle, notifications, storage, terminalPrivate, unlimitedStorage, fileSystemProvider, accessibilityFeatures.read',
        'true,,Secure Shell,iodihamcpbpeioajjeobimgagajmlibd,clipboardRead, clipboardWrite, contextMenus, idle, notifications, storage, terminalPrivate, unlimitedStorage, fileSystemProvider, accessibilityFeatures.read, crashReportPrivate, metricsPrivate',
        'true,,Send to Kindle for Google Chrome,cgdjpilhipecahhcilnafpblkieebhea,tabs, <all_urls>, storage, unlimitedStorage',
        'true,,Session Buddy,edacconmaakjimmfgnblocblbcdcpbko,tabs, unlimitedStorage',
        'true,,Slack,jeogkiiogjbmhklcnbgkdcjoioegiknm,unlimitedStorage, notifications, clipboardRead, clipboardWrite',
        'true,,SSH for Google Cloud Platform,ojilllmhjhibplnppnamldakhpmdnibd,clipboardRead, clipboardWrite',
        'true,,Super Dark Mode,nlgphodeccebbcnkgmokeegopgpnjfkc,storage, <all_urls>, contextMenus',
        'true,,Superhuman,dcgcnpooblobhncpnddnhoendgbnglpn,background, gcm, notifications, storage, system.cpu, system.display, system.memory, tabs, unlimitedStorage, <all_urls>',
        'true,,Tabli,igeehkedfibbnhbfponhjjplpkeomghi,storage, tabs, bookmarks, chrome://favicon/*',
        'true,,Tab Wrangler,egnjhciaieeiiohknchakcodbpgjnchh,contextMenus, sessions, storage, tabs',
        'true,,Tag Assistant Legacy (by Google),kejbdjndbnbjgmefkgdddjlbokphdefk,identity, storage, tabs, webNavigation, webRequestBlocking, webRequest, http://*/, https://*/',
        'true,,Todoist for Chrome,jldhpllghnbhlbpcmnajkpdmadaolakh,storage, tabs, contextMenus, webRequest, webRequestBlocking, http://*.todoist.com/*, https://*.todoist.com/*, background, declarativeNetRequestWithHostAccess',
        'true,Tulio Ornelas <ornelas.tulio@gmail.com>,JSON Viewer,gbmdgpbipfallnflgajpaliibnhdgobh,*://*/*, <all_urls>',
        'true,,Ubiquiti Device Discovery Tool,hmpigflbjeapnknladcfphgkemopofig,system.network, clipboardRead, clipboardWrite, notifications, storage, unlimitedStorage,',
        'true,,uBlock,epcnnfbjfcgphgdmggkamkmgojdagdnn,tabs, <all_urls>, webRequest, webRequestBlocking, webNavigation, storage, unlimitedStorage',
        'true,,UET Tag Helper (by Microsoft Advertising),naijndjklgmffmpembnkfbcjbognokbf,activeTab, downloads, tabs, webNavigation, webRequest, http://*/, https://*/',
        'true,,Utime,kpcibgnngaaabebmcabmkocdokepdaki,clipboardWrite, contextMenus, notifications',
        'true,,Vimium,dbepggeogbaibhgnhhndojpepiihcmeb,tabs, bookmarks, history, clipboardRead, storage, sessions, notifications, webNavigation, <all_urls>',
        'true,,Vue.js devtools,nhdogjmejiglipccpnnnanhbledajbpd,<all_urls>, storage',
        'true,Wappalyzer,Wappalyzer - Technology profiler,gppongmhjkpfnbhagpmjfkannfbllamg,cookies, storage, tabs, webNavigation, webRequest',
        'true,Wappalyzer,Wappalyzer - Technology profiler,gppongmhjkpfnbhagpmjfkannfbllamg,cookies, storage, tabs, webRequest, webNavigation, http://*/*, https://*/*',
        'true,,Windscribe - Free Proxy and Ad Blocker,hnmpcagpplmpfojmgmnngilcnanddlhb,<all_urls>, proxy, management, tabs, webRequest, webRequestBlocking, activeTab, storage, unlimitedStorage, contextMenus, privacy, webNavigation, notifications, cookies',
        'true,,WiseStamp email signature,pbcgnkmbeodkmiijjfnliicelkjfcldg,*://*.wisestamp.com/*, http://local.wisestamp.com:9081/*, https://local.wisestamp.com:8080/*, cookies',
        'true,,Zoom Scheduler,kgjfgplpablkjnlkjmjdecgdpfankdle,unlimitedStorage, https://www.google.com/calendar/*, https://www.google.com/recaptcha/*, https://www.gstatic.com/recaptcha/*, https://calendar.google.com/calendar/*, https://*.zoom.us/*, https://*.zoom.com/*'
      )
    GROUP BY
      exception_key
  description: Highlight chrome extensions with wide-ranging permissions that are not part of your whitelist
  name: 'Detection - Persistence: Unexpected Chrome Extensions'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unexpected crontab entries
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1053/003/ (Scheduled Task/Job: Cron)
    --
    -- false positives:
    --   * crontab entries added by the user
    --
    -- tags: persistent filesystem state
    -- platform: posix
    SELECT
      *
    FROM
      crontab
    WHERE
      command NOT LIKE 'root%run-parts%'
      AND command NOT LIKE '%freshclam%'
      AND command NOT LIKE '%clamscan%'
      AND command NOT LIKE '%e2scrub%'
      AND command NOT LIKE '%zfs-linux%'
      AND command NOT LIKE '%anacron start%'
      AND command NOT LIKE '%/usr/lib/php/sessionclean%'
  description: Unexpected crontab entries
  name: 'Detection - Persistence: Unexpected Cron Entries'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unexpected launchd scripts that use the 'program_arguments' field
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1543/004/ (Create or Modify System Process: Launch Daemon)
    --
    -- false positives:
    --   * Software by new vendors which have not yet been added to the allow list
    --
    -- tags: persistent filesystem state
    -- platform: darwin
    SELECT
      l.label,
      l.name,
      l.path,
      TRIM(REGEX_SPLIT (l.program_arguments, ' -', 0)) AS program_path,
      l.program_arguments,
      l.keep_alive,
      signature.authority AS program_authority,
      hash.sha256
    FROM
      launchd l
      LEFT JOIN signature ON program_path = signature.path
      LEFT JOIN hash ON program_path = hash.path
    WHERE
      (
        run_at_load = 1
        OR keep_alive = 1
      )
      AND (
        program IS NULL
        OR program = ''
      )
      AND l.path NOT LIKE '/System/%'
      AND program_authority NOT IN (
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Foxit Corporation (8GN47HTP75)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Google, Inc. (EQHXZ8M8AV)',
        'Developer ID Application: Keybase, Inc. (99229SGT5K)',
        'Developer ID Application: Kolide Inc (YZ3EM74M78)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Fumihiko Takayama (G43BCU2T37)',
        'Developer ID Application: MacPaw Inc. (S8EX82NJP6)',
        'Developer ID Application: Mersive Technologies (63B5A5WDNG)',
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Proton Technologies AG (6UN54H93QT)',
        'Developer ID Application: Seiko Epson Corporation (TXAEAV5RN4)',
        'Developer ID Application: Sanford, L.P. (N3S6676K3E)', -- DYMO
        'Developer ID Application: Canva Pty Ltd (5HD2ARTBFS)',
        'Developer ID Application: Private Internet Access, Inc. (5357M5NW9W)',
        'Developer ID Application: Tenable, Inc. (4B8J598M7U)',
        'Software Signing', -- Apple
        'yabai-cert'
      )
      AND program_arguments NOT IN (
        '/Applications/Stream Deck.app/Contents/MacOS/Stream Deck --runinbk',
        '/opt/homebrew/opt/mariadb/bin/mysqld_safe',
        '/opt/homebrew/opt/skhd/bin/skhd',
        '/opt/homebrew/opt/jenkins/bin/jenkins --httpListenAddress=127.0.0.1 --httpPort=8080',
        '/opt/homebrew/opt/yubikey-agent/bin/yubikey-agent -l /opt/homebrew/var/run/yubikey-agent.sock',
        '/usr/local/MacGPG2/libexec/fixGpgHome'
      )
      AND program_arguments NOT LIKE '/Users/%/Library/Application Support/com.grammarly.ProjectLlama/Scripts/post-uninstall.sh'
      AND program_arguments NOT LIKE '%/mysqld_safe --datadir=%'
  description: Unexpected launchd scripts that use the 'program_arguments' field
  name: 'Detection - Persistence: Unexpected Launchd Program Arguments'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unexpected launchd scripts that use the 'program' field
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1543/004/ (Create or Modify System Process: Launch Daemon)
    --
    -- false positives:
    --   * Software by new vendors which have not yet been added to the allow list
    --
    -- tags: persistent filesystem state
    -- platform: darwin
    SELECT
      l.label,
      l.name,
      l.path,
      l.program,
      l.program_arguments,
      l.keep_alive,
      signature.authority AS program_authority,
      signature.identifier AS program_identifier,
      hash.sha256
    FROM
      launchd l
      LEFT JOIN signature ON l.program = signature.path
      LEFT JOIN hash ON l.path = hash.path
    WHERE
      (
        run_at_load = 1
        OR keep_alive = 1
      )
      AND l.path NOT LIKE '/System/%'
      AND program IS NOT NULL
      AND program_authority NOT IN (
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        'Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        'Developer ID Application: Valve Corporation (MXGJJ98X76)',
        'Developer ID Application: Wireshark Foundation, Inc. (7Z6EMTD2C6)'
      )
      AND program NOT IN ('/usr/local/MacGPG2/libexec/shutdown-gpg-agent')
  description: Unexpected launchd scripts that use the 'program' field
  name: 'Detection - Persistence: Unexpected Launchd Program'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unexpected small udev rule entries
    --
    -- Typically vendor-provided udev rules are more verbose.
    --
    -- references:
    --   * https://documents.trendmicro.com/assets/white_papers/wp-operation-earth-berberoka.pdf
    --   * https://attack.mitre.org/techniques/T1547/ (Boot or Logon Autostart Execution)
    --
    -- false positives:
    --   * rules installed by 3rd party software
    --
    -- tags: persistent filesystem state
    -- platform: linux
    SELECT
      file.path,
      uid,
      gid,
      mode,
      mtime,
      ctime,
      type,
      size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      file.path LIKE '/usr/lib/udev/rules.d/%'
      AND file.size < 180
      AND file.path NOT IN (
        '/usr/lib/udev/rules.d/50-apport.rules',
        '/usr/lib/udev/rules.d/60-net.rules',
        '/usr/lib/udev/rules.d/60-rfkill.rules',
        '/usr/lib/udev/rules.d/61-mutter.rules',
        '/usr/lib/udev/rules.d/66-saned.rules',
        '/usr/lib/udev/rules.d/70-hypervfcopy.rules',
        '/usr/lib/udev/rules.d/70-hypervkvp.rules',
        '/usr/lib/udev/rules.d/70-hypervvss.rules',
        '/usr/lib/udev/rules.d/70-spice-vdagentd.rules',
        '/usr/lib/udev/rules.d/70-spice-webdavd.rules',
        '/usr/lib/udev/rules.d/71-alpha_imaging_technology_co-vr.rules',
        '/usr/lib/udev/rules.d/71-astro_gaming-controllers.rules',
        '/usr/lib/udev/rules.d/71-betop-controllers.rules',
        '/usr/lib/udev/rules.d/71-nacon-controllers.rules',
        '/usr/lib/udev/rules.d/71-sony-vr.rules',
        '/usr/lib/udev/rules.d/75-probe_mtd.rules',
        '/usr/lib/udev/rules.d/85-hdparm.rules',
        '/usr/lib/udev/rules.d/85-regulatory.rules',
        '/usr/lib/udev/rules.d/90-daxctl-device.rules',
        '/usr/lib/udev/rules.d/91-drm-modeset.rules',
        '/usr/lib/udev/rules.d/96-e2scrub.rules',
        '/usr/lib/udev/rules.d/99-BlackmagicDevices.rules',
        '/usr/lib/udev/rules.d/99-DavinciPanel.rules',
        '/usr/lib/udev/rules.d/99-fuse3.rules',
        '/usr/lib/udev/rules.d/99-fuse.rules',
        '/usr/lib/udev/rules.d/99-libsane1.rules',
        '/usr/lib/udev/rules.d/99-nfs.rules',
        '/usr/lib/udev/rules.d/99-qemu-guest-agent.rules'
      )
  description: Unexpected small udev rule entries
  name: 'Detection - Persistence: Unexpected Small Udev Entry'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unexpected long-running processes running as root
    --
    -- false positives:
    --   * new software requiring escalated privileges
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1543/
    --
    -- tags: persistent process state
    -- platform: linux
    SELECT
      p.pid,
      p.name,
      p.path,
      p.euid,
      p.gid,
      f.ctime,
      f.directory AS dirname,
      p.cmdline,
      mnt_namespace,
      hash.sha256,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN process_namespaces ON p.pid = process_namespaces.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN processes pp ON p.parent = pp.pid
    WHERE
      p.uid = 0
      AND (strftime('%s', 'now') - p.start_time) > 15 -- use osquery as the reference mount namespace
      AND mnt_namespace IN (
        SELECT DISTINCT
          (mnt_namespace)
        FROM
          process_namespaces
          JOIN processes ON processes.pid = process_namespaces.pid
        WHERE
          processes.name IN ('osqueryi', 'osqueryd')
      )
      AND p.path NOT IN (
        '',
        '/sbin/apcupsd',
        '/usr/bin/abrt-dump-journal-core',
        '/usr/bin/abrt-dump-journal-oops',
        '/usr/bin/abrt-dump-journal-xorg',
        '/usr/bin/anacron',
        '/usr/bin/apcupsd',
        '/usr/bin/containerd',
        '/usr/bin/containerd-shim-runc-v2',
        '/usr/bin/crond',
        '/usr/bin/dockerd',
        '/usr/bin/docker-proxy',
        '/usr/bin/fish',
        '/usr/bin/gdm',
        '/usr/bin/gpg-agent',
        '/usr/bin/journalctl',
        '/usr/bin/lightdm',
        '/usr/bin/osqueryd',
        '/usr/bin/pacman',
        '/usr/bin/sshd',
        '/usr/bin/tailscaled',
        '/usr/bin/wpa_supplicant',
        '/usr/libexec/accounts-daemon',
        '/usr/libexec/docker/docker-proxy',
        '/usr/libexec/flatpak-system-helper',
        '/usr/libexec/gdm-session-worker',
        '/usr/libexec/packagekitd',
        '/usr/libexec/polkitd',
        '/usr/libexec/scdaemon',
        '/usr/libexec/snapd/snapd',
        '/usr/libexec/sssd/sssd_kcm',
        '/usr/libexec/udisks2/udisksd',
        '/usr/lib/flatpak-system-helper',
        '/usr/lib/gdm-session-worker',
        '/usr/lib/software-properties/software-properties-dbus',
        '/usr/lib/systemd/systemd',
        '/usr/lib/systemd/systemd-homed',
        '/usr/lib/systemd/systemd-journald',
        '/usr/lib/systemd/systemd-machined',
        '/usr/lib/udisks2/udisksd',
        '/usr/lib/Xorg',
        '/usr/sbin/abrtd',
        '/usr/sbin/abrt-dbus',
        '/usr/sbin/acpid',
        '/usr/sbin/alsactl',
        '/usr/sbin/anacron',
        '/usr/sbin/cron',
        '/usr/sbin/cups-browsed',
        '/usr/sbin/cupsd',
        '/usr/sbin/gdm',
        '/usr/sbin/gdm3',
        '/usr/sbin/gssproxy',
        '/usr/sbin/mcelog',
        '/usr/sbin/pcscd',
        '/usr/sbin/tailscaled',
        '/usr/sbin/thermald',
        '/usr/sbin/wpa_supplicant',
        '/usr/sbin/zed'
      )
      -- Because I don't want to whitelist all of Python3
      AND p.cmdline NOT IN (
        '/usr/bin/python3 -s /usr/sbin/firewalld --nofork --nopid',
        '/usr/bin/python /usr/bin/firewalld --nofork --nopid',
        '/usr/bin/python3 /usr/share/unattended-upgrades/unattended-upgrade-shutdown --wait-for-signal',
        '/usr/bin/python3 /usr/bin/networkd-dispatcher --run-startup-triggers'
      )
      AND NOT p.cmdline LIKE '/usr/bin/python3 /usr/bin/dnf %'
      AND p.path NOT LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
      AND p.path NOT LIKE '/usr/local/kolide-k2/bin/launcher-updates/%/launcher'
      AND p.path NOT LIKE '/nix/store/%/bin/%'
      AND p.path NOT LIKE '/nix/store/%-systemd-%/lib/systemd/systemd%'
      AND p.path NOT LIKE '/nix/store/%/libexec/%'
      AND p.path NOT LIKE '/snap/snapd/%/usr/lib/snapd/snapd'
  description: Unexpected long-running processes running as root
  name: 'Detection - Persistence: Unexpected Uid0 Daemon Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unexpected long-running processes running as root
    --
    -- false positives:
    --   * new software requiring escalated privileges
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1543/
    --
    -- tags: persistent process state
    -- platform: darwin
    SELECT
      p.pid,
      p.name,
      p.path,
      p.euid,
      p.gid,
      f.ctime,
      f.directory AS dirname,
      p.cmdline,
      hash.sha256,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      signature.identifier,
      signature.authority
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN signature ON p.path = signature.path
    WHERE
      p.uid = 0
      AND (strftime('%s', 'now') - p.start_time) > 15
      AND p.path NOT IN (
        '/Applications/Foxit PDF Reader.app/Contents/MacOS/FoxitPDFReaderUpdateService.app/Contents/MacOS/FoxitPDFReaderUpdateService',
        '/Applications/OneDrive.app/Contents/StandaloneUpdaterDaemon.xpc/Contents/MacOS/StandaloneUpdaterDaemon',
        '/Applications/Opal.app/Contents/Library/LaunchServices/com.opalcamera.cameraExtensionShim',
        '/Applications/Parallels Desktop.app/Contents/MacOS/Parallels Service.app/Contents/MacOS/prl_disp_service',
        '/Applications/Parallels Desktop.app/Contents/MacOS/prl_naptd',
        '/bin/bash',
        '/Library/Apple/System/Library/CoreServices/XProtect.app/Contents/MacOS/XProtect',
        '/Library/Apple/System/Library/CoreServices/XProtect.app/Contents/XPCServices/XProtectPluginService.xpc/Contents/MacOS/XProtectPluginService',
        '/Library/Application Support/Adobe/Adobe Desktop Common/ElevationManager/Adobe Installer',
        '/Library/Application Support/Objective Development/Little Snitch/Components/at.obdev.littlesnitch.daemon.bundle/Contents/MacOS/at.obdev.littlesnitch.daemon',
        '/Library/Audio/Plug-Ins/HAL/SolsticeDesktopSpeakers.driver/Contents/XPCServices/RelayXpc.xpc/Contents/MacOS/RelayXpc',
        '/Library/Nessus/run/sbin/nessusd',
        '/Library/Nessus/run/sbin/nessus-service',
        '/Library/PrivilegedHelperTools/com.adobe.acc.installer.v2',
        '/Library/PrivilegedHelperTools/com.docker.vmnetd',
        '/Library/PrivilegedHelperTools/com.macpaw.CleanMyMac4.Agent',
        '/Library/PrivilegedHelperTools/keybase.Helper',
        '/Library/SystemExtensions/2DA71D8A-7905-4012-A7D5-0B246D5AA77B/at.obdev.littlesnitch.networkextension.systemextension/Contents/MacOS/at.obdev.littlesnitch.networkextension',
        '/opt/homebrew/Cellar/telepresence-arm64/2.7.6/bin/telepresence',
        '/sbin/launchd',
        '/System/Library/CoreServices/backupd.bundle/Contents/Resources/backupd',
        '/System/Library/CoreServices/backupd.bundle/Contents/Resources/backupd-helper',
        '/System/Library/CoreServices/CrashReporterSupportHelper',
        '/System/Library/CoreServices/iconservicesagent',
        '/System/Library/CoreServices/launchservicesd',
        '/System/Library/CoreServices/logind',
        '/System/Library/CoreServices/loginwindow.app/Contents/MacOS/loginwindow',
        '/System/Library/CoreServices/osanalyticshelper',
        '/System/Library/CoreServices/powerd.bundle/powerd',
        '/System/Library/CoreServices/ReportCrash',
        '/System/Library/CoreServices/sharedfilelistd',
        '/System/Library/CoreServices/Software Update.app/Contents/Resources/suhelperd',
        '/System/Library/CoreServices/SubmitDiagInfo',
        '/System/Library/CryptoTokenKit/com.apple.ifdreader.slotd/Contents/MacOS/com.apple.ifdreader',
        '/System/Library/CryptoTokenKit/com.apple.ifdreader.slotd/Contents/XPCServices/com.apple.ifdbundle.xpc/Contents/MacOS/com.apple.ifdbundle',
        '/System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/HIServices.framework/Versions/A/XPCServices/com.apple.hiservices-xpcservice.xpc/Contents/MacOS/com.apple.hiservices-xpcservice',
        '/System/Library/Frameworks/AudioToolbox.framework/AudioComponentRegistrar',
        '/System/Library/Frameworks/AudioToolbox.framework/XPCServices/CAReportingService.xpc/Contents/MacOS/CAReportingService',
        '/System/Library/Frameworks/AudioToolbox.framework/XPCServices/com.apple.audio.SandboxHelper.xpc/Contents/MacOS/com.apple.audio.SandboxHelper',
        '/System/Library/Frameworks/ColorSync.framework/Versions/A/XPCServices/com.apple.ColorSyncXPCAgent.xpc/Contents/MacOS/com.apple.ColorSyncXPCAgent',
        '/System/Library/Frameworks/CoreMediaIO.framework/Versions/A/Resources/com.apple.cmio.registerassistantservice',
        '/System/Library/Frameworks/CoreMediaIO.framework/Versions/A/Resources/iOSScreenCapture.plugin/Contents/Resources/iOSScreenCaptureAssistant',
        '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/CarbonCore.framework/Versions/A/Support/coreservicesd',
        '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/CarbonCore.framework/Versions/A/XPCServices/csnameddatad.xpc/Contents/MacOS/csnameddatad',
        '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/FSEvents.framework/Versions/A/Support/fseventsd',
        '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/Metadata.framework/Versions/A/Support/mds',
        '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/Metadata.framework/Versions/A/Support/mds_stores',
        '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/Metadata.framework/Versions/A/Support/mdsync',
        '/System/Library/Frameworks/CryptoTokenKit.framework/ctkahp.bundle/Contents/MacOS/ctkahp',
        '/System/Library/Frameworks/GSS.framework/Helpers/GSSCred',
        '/System/Library/Frameworks/LocalAuthentication.framework/Support/coreauthd',
        '/System/Library/Frameworks/Metal.framework/Versions/A/XPCServices/MTLCompilerService.xpc/Contents/MacOS/MTLCompilerService',
        '/System/Library/Frameworks/NetFS.framework/Versions/A/XPCServices/PlugInLibraryService.xpc/Contents/MacOS/PlugInLibraryService',
        '/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/CVMServer',
        '/System/Library/Frameworks/PCSC.framework/Versions/A/XPCServices/com.apple.ctkpcscd.xpc/Contents/MacOS/com.apple.ctkpcscd',
        '/System/Library/Frameworks/PreferencePanes.framework/Versions/A/XPCServices/cacheAssistant.xpc/Contents/MacOS/cacheAssistant',
        '/System/Library/Frameworks/Security.framework/Versions/A/XPCServices/authd.xpc/Contents/MacOS/authd',
        '/System/Library/Frameworks/Security.framework/Versions/A/XPCServices/com.apple.CodeSigningHelper.xpc/Contents/MacOS/com.apple.CodeSigningHelper',
        '/System/Library/Frameworks/SystemExtensions.framework/Versions/A/Helpers/sysextd',
        '/System/Library/PrivateFrameworks/AccountPolicy.framework/XPCServices/com.apple.AccountPolicyHelper.xpc/Contents/MacOS/com.apple.AccountPolicyHelper',
        '/System/Library/PrivateFrameworks/AmbientDisplay.framework/Versions/A/XPCServices/com.apple.AmbientDisplayAgent.xpc/Contents/MacOS/com.apple.AmbientDisplayAgent',
        '/System/Library/PrivateFrameworks/AppleCredentialManager.framework/AppleCredentialManagerDaemon',
        '/System/Library/PrivateFrameworks/AppleNeuralEngine.framework/XPCServices/ANECompilerService.xpc/Contents/MacOS/ANECompilerService',
        '/System/Library/PrivateFrameworks/AppleNeuralEngine.framework/XPCServices/ANEStorageMaintainer.xpc/Contents/MacOS/ANEStorageMaintainer',
        '/System/Library/PrivateFrameworks/ApplePushService.framework/apsd',
        '/System/Library/PrivateFrameworks/AppStoreDaemon.framework/Versions/A/XPCServices/com.apple.AppStoreDaemon.StorePrivilegedTaskService.xpc/Contents/MacOS/com.apple.AppStoreDaemon.StorePrivilegedTaskService',
        '/System/Library/PrivateFrameworks/AssetCacheServicesExtensions.framework/Versions/A/XPCServices/AssetCacheManagerService.xpc/Contents/MacOS/AssetCacheManagerService',
        '/System/Library/PrivateFrameworks/AssetCacheServicesExtensions.framework/Versions/A/XPCServices/AssetCacheTetheratorService.xpc/Contents/MacOS/AssetCacheTetheratorService',
        '/System/Library/PrivateFrameworks/AuthKit.framework/Versions/A/Support/akd',
        '/System/Library/PrivateFrameworks/CacheDelete.framework/deleted_helper',
        '/System/Library/PrivateFrameworks/CloudKitDaemon.framework/Support/cloudd',
        '/System/Library/PrivateFrameworks/CoreAccessories.framework/Support/accessoryd',
        '/System/Library/PrivateFrameworks/CoreDuetContext.framework/Versions/A/Resources/contextstored',
        '/System/Library/PrivateFrameworks/CoreKDL.framework/Support/corekdld',
        '/System/Library/PrivateFrameworks/CoreSymbolication.framework/coresymbolicationd',
        '/System/Library/PrivateFrameworks/FamilyControls.framework/Versions/A/Resources/parentalcontrolsd',
        '/System/Library/PrivateFrameworks/FindMyMac.framework/Versions/A/Resources/FindMyMacd',
        '/System/Library/PrivateFrameworks/GenerationalStorage.framework/Versions/A/Support/revisiond',
        '/System/Library/PrivateFrameworks/GeoServices.framework/Versions/A/XPCServices/com.apple.geod.xpc/Contents/MacOS/com.apple.geod',
        '/System/Library/PrivateFrameworks/MediaRemote.framework/Support/mediaremoted',
        '/System/Library/PrivateFrameworks/MobileInstallation.framework/XPCServices/com.apple.MobileInstallationHelperService.xpc/Contents/MacOS/com.apple.MobileInstallationHelperService',
        '/System/Library/PrivateFrameworks/MobileSoftwareUpdate.framework/Versions/A/XPCServices/com.apple.MobileSoftwareUpdate.CleanupPreparePathService.xpc/Contents/MacOS/com.apple.MobileSoftwareUpdate.CleanupPreparePathService',
        '/System/Library/PrivateFrameworks/Noticeboard.framework/Versions/A/Resources/nbstated',
        '/System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/Resources/installd',
        '/System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/Resources/system_installd',
        '/System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/XPCServices/package_script_service.xpc/Contents/MacOS/package_script_service',
        '/System/Library/PrivateFrameworks/SiriInference.framework/Support/siriinferenced',
        '/System/Library/PrivateFrameworks/SkyLight.framework/Versions/A/Resources/WindowServer',
        '/System/Library/PrivateFrameworks/StorageKit.framework/Versions/A/Resources/storagekitd',
        '/System/Library/PrivateFrameworks/SystemAdministration.framework/XPCServices/writeconfig.xpc/Contents/MacOS/writeconfig',
        '/System/Library/PrivateFrameworks/SystemMigration.framework/Versions/A/Resources/systemmigrationd',
        '/System/Library/PrivateFrameworks/SystemStatusServer.framework/Support/systemstatusd',
        '/System/Library/PrivateFrameworks/TCC.framework/Support/tccd',
        '/System/Library/PrivateFrameworks/Uninstall.framework/Versions/A/Resources/uninstalld',
        '/System/Library/PrivateFrameworks/ViewBridge.framework/Versions/A/XPCServices/ViewBridgeAuxiliary.xpc/Contents/MacOS/ViewBridgeAuxiliary',
        '/System/Library/PrivateFrameworks/WiFiPolicy.framework/XPCServices/WiFiCloudAssetsXPCService.xpc/Contents/MacOS/WiFiCloudAssetsXPCService',
        '/System/Library/PrivateFrameworks/WirelessDiagnostics.framework/Support/awdd',
        '/System/Library/PrivateFrameworks/XprotectFramework.framework/Versions/A/XPCServices/XprotectService.xpc/Contents/MacOS/XprotectService',
        '/usr/bin/sudo',
        '/usr/bin/sysdiagnose',
        '/usr/libexec/AirPlayXPCHelper',
        '/usr/libexec/airportd',
        '/usr/libexec/amfid',
        '/usr/libexec/aned',
        '/usr/libexec/apfsd',
        '/usr/libexec/applessdstatistics',
        '/usr/libexec/ApplicationFirewall/socketfilterfw',
        '/usr/libexec/ASPCarryLog',
        '/usr/libexec/autofsd',
        '/usr/libexec/automountd',
        '/usr/libexec/batteryintelligenced',
        '/usr/libexec/biokitaggdd',
        '/usr/libexec/biometrickitd',
        '/usr/libexec/bootinstalld',
        '/usr/libexec/colorsyncd',
        '/usr/libexec/colorsync.displayservices',
        '/usr/libexec/configd',
        '/usr/libexec/containermanagerd',
        '/usr/libexec/corebrightnessd',
        '/usr/libexec/coreduetd',
        '/usr/libexec/corestoraged',
        '/usr/libexec/dasd',
        '/usr/libexec/diskarbitrationd',
        '/usr/libexec/diskmanagementd',
        '/usr/libexec/dprivacyd',
        '/usr/libexec/endpointsecurityd',
        '/usr/libexec/findmydeviced',
        '/usr/libexec/InternetSharing',
        '/usr/libexec/IOMFB_bics_daemon',
        '/usr/libexec/ioupsd',
        '/usr/libexec/kernelmanagerd',
        '/usr/libexec/keybagd',
        '/usr/libexec/logd',
        '/usr/libexec/logd_helper',
        '/usr/libexec/lsd',
        '/usr/libexec/memoryanalyticsd',
        '/usr/libexec/microstackshot',
        '/usr/libexec/misagent',
        '/usr/libexec/mobileactivationd',
        '/usr/libexec/mobileassetd',
        '/usr/libexec/nehelper',
        '/usr/libexec/nesessionmanager',
        '/usr/libexec/online-authd',
        '/usr/libexec/opendirectoryd',
        '/usr/libexec/PerfPowerServices',
        '/usr/libexec/periodic-wrapper',
        '/usr/libexec/powerdatad',
        '/usr/libexec/PowerUIAgent',
        '/usr/libexec/remoted',
        '/usr/libexec/rtcreportingd',
        '/usr/libexec/runningboardd',
        '/usr/libexec/sandboxd',
        '/usr/libexec/searchpartyd',
        '/usr/libexec/secinitd',
        '/usr/libexec/securityd_service',
        '/usr/libexec/smd',
        '/usr/libexec/symptomsd-diag',
        '/usr/libexec/sysmond',
        '/usr/libexec/syspolicyd',
        '/usr/libexec/tailspind',
        '/usr/libexec/taskgated',
        '/usr/libexec/thermalmonitord',
        '/usr/libexec/TouchBarServer',
        '/usr/libexec/tzd',
        '/usr/libexec/tzlinkd',
        '/usr/libexec/usbd',
        '/usr/libexec/UserEventAgent',
        '/usr/libexec/warmd',
        '/usr/libexec/watchdogd',
        '/usr/libexec/wifianalyticsd',
        '/usr/libexec/wifip2pd',
        '/usr/libexec/wifivelocityd',
        '/usr/local/kolide-k2/bin/osquery-extension.ext',
        '/usr/sbin/aslmanager',
        '/usr/sbin/auditd',
        '/usr/sbin/BlueTool',
        '/usr/sbin/bluetoothd',
        '/usr/sbin/BTLEServer',
        '/usr/sbin/cfprefsd',
        '/usr/sbin/distnoted',
        '/usr/sbin/filecoordinationd',
        '/usr/sbin/KernelEventAgent',
        '/usr/sbin/mDNSResponderHelper',
        '/usr/sbin/notifyd',
        '/usr/sbin/securityd',
        '/usr/sbin/spindump',
        '/usr/sbin/syslogd',
        '/usr/sbin/systemsoundserverd',
        '/usr/sbin/systemstats',
        '/usr/sbin/WirelessRadioManagerd'
      )
      AND signature.identifier IN (
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Foxit Corporation (8GN47HTP75)',
        'Developer ID Application: Keybase, Inc. (99229SGT5K)',
        'Developer ID Application: Kolide Inc (YZ3EM74M78)',
        'Developer ID Application: MacPaw Inc. (S8EX82NJP6)',
        'Developer ID Application: Mersive Technologies (63B5A5WDNG)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        'Developer ID Application: Opal Camera Inc (97Z3HJWCRT)',
        'Developer ID Application: Parallels International GmbH (4C6364ACXT)',
        'Developer ID Application: Private Internet Access, Inc. (5357M5NW9W)',
        'Developer ID Application: Tenable, Inc. (4B8J598M7U)',
        'Software Signing'
      )
    GROUP BY
      p.path
  description: Unexpected long-running processes running as root
  name: 'Detection - Persistence: Unexpected Uid0 Daemon Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Pick out exotic processes based on their command-line (events-based)
    --
    -- references:
    --   * https://themittenmac.com/what-does-apt-activity-look-like-on-macos/
    --
    -- false positives:
    --   * possible, but none known
    --
    -- tags: transient process events
    -- platform: linux
    -- interval: 60
    SELECT
      p.pid,
      p.path,
      REPLACE(
        p.path,
        RTRIM(p.path, REPLACE(p.path, '/', '')),
        ''
      ) AS basename,
      -- On macOS there is often a trailing space
      TRIM(p.cmdline) AS cmd,
      p.mode,
      p.cwd,
      p.euid,
      p.parent,
      p.syscall,
      hash.sha256,
      pp.path AS parent_path,
      pp.name AS parent_name,
      TRIM(p.cmdline) AS parent_cmd,
      pp.euid AS parent_euid,
      phash.sha256 AS parent_sha256
    FROM
      uptime,
      process_events p
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN hash AS phash ON pp.path = phash.path
    WHERE
      p.time > (strftime('%s', 'now') -60)
      AND (
        basename IN (
          'bitspin',
          'bpftool',
          'heyoka',
          'nstx',
          'dnscat2',
          'tuns',
          'iodine',
          'rshell',
          'rsh',
          'incbit',
          'insmod',
          'kmod',
          'lushput',
          'mkfifo',
          'msfvenom',
          'nc',
          'socat'
        )
        -- Chrome Stealer
        OR cmd LIKE '%chrome%-load-extension%'
        -- Known attack scripts
        OR basename LIKE '%pwn%'
        OR basename LIKE '%attack%'
        -- Unusual behaviors
        OR cmd LIKE '%ufw disable%'
        OR cmd LIKE '%iptables -P % ACCEPT%'
        OR cmd LIKE '%iptables -F%'
        OR cmd LIKE '%chattr -ia%'
        OR cmd LIKE '%chmod 777 %'
        OR cmd LIKE '%touch%acmr%'
        OR cmd LIKE '%touch -r%'
        OR cmd LIKE '%ld.so.preload%'
        OR cmd LIKE '%urllib.urlopen%'
        OR cmd LIKE '%nohup%tmp%'
        OR cmd LIKE '%iptables stop'
        OR cmd LIKE '%systemctl stop firewalld%'
        OR cmd LIKE '%systemctl disable firewalld%'
        OR cmd LIKE '%pkill -f%'
        OR cmd LIKE '%rm -f%/tmp%'
        OR cmd LIKE '%rm -rf /boot%'
        OR cmd LIKE '%xargs kill -9%'
        OR cmd LIKE '%nohup /bin/bash%'
        OR cmd LIKE '%echo%|%base64 --decode %|%'
        OR cmd LIKE '%UserKnownHostsFile=/dev/null%'
        -- Crypto miners
        OR cmd LIKE '%minerd%'
        OR cmd LIKE '%monero%'
        OR cmd LIKE '%nanopool%'
        OR cmd LIKE '%nicehash%'
        OR cmd LIKE '%stratum%'
        OR basename LIKE '%xig%'
        OR basename LIKE '%xmr%'
        -- Random keywords
        OR cmd LIKE '%ransom%'
        -- Reverse shells
        OR cmd LIKE '%/dev/tcp/%'
        OR cmd LIKE '%/dev/udp/%'
        OR cmd LIKE '%fsockopen%'
        OR cmd LIKE '%openssl%quiet%'
        OR cmd LIKE '%pty.spawn%'
        OR cmd LIKE '%sh -i'
        OR cmd LIKE '%socat%'
        OR cmd LIKE '%SOCK_STREAM%'
        OR cmd LIKE '%Socket.%'
      ) -- Things that could reasonably happen at boot.
      AND NOT (
        p.path IN ('/usr/bin/kmod', '/bin/kmod')
        AND parent_path = '/usr/lib/systemd/systemd'
        AND parent_cmd = '/sbin/init'
      )
      AND NOT (
        p.path IN ('/usr/bin/kmod', '/bin/kmod')
        AND parent_name IN (
          'firewalld',
          'mkinitramfs',
          'systemd',
          'dockerd',
          'kube-proxy'
        )
      )
      AND NOT (
        p.path IN ('/usr/bin/kmod', '/bin/kmod')
        AND uptime.total_seconds < 15
      )
      AND NOT (
        p.path = '/usr/bin/mkfifo'
        AND cmd LIKE '%/org.gpgtools.log.%/fifo'
      )
      AND NOT cmd LIKE '%modprobe -va%'
      AND NOT cmd LIKE 'modprobe -ab%'
      AND NOT cmd LIKE '%modprobe overlay'
      AND NOT cmd LIKE '%modprobe aufs'
      AND NOT cmd IN ('lsmod')
  description: Pick out exotic processes based on their command-line (events-based)
  name: 'Detection - Execution: Exotic Command Events Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Pick out exotic processes based on their command-line (events-based)
    --
    -- references:
    --   * https://themittenmac.com/what-does-apt-activity-look-like-on-macos/
    --
    -- false positives:
    --   * possible, but none known
    --
    -- tags: transient process events
    -- platform: darwin
    -- interval: 45
    SELECT
      p.pid,
      p.path,
      REPLACE(
        p.path,
        RTRIM(p.path, REPLACE(p.path, '/', '')),
        ''
      ) AS basename,
      -- On macOS there is often a trailing space
      TRIM(p.cmdline) AS cmd,
      p.mode,
      p.cwd,
      p.euid,
      p.parent,
      p.syscall,
      hash.sha256,
      pp.path AS parent_path,
      pp.name AS parent_name,
      TRIM(p.cmdline) AS parent_cmd,
      pp.euid AS parent_euid,
      phash.sha256 AS parent_sha256
    FROM
      uptime,
      process_events p
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN hash AS phash ON pp.path = phash.path
    WHERE
      p.time > (strftime('%s', 'now') -45)
      AND (
        basename IN (
          'bitspin',
          'bpftool',
          'csrutil',
          'heyoka',
          'nstx',
          'dnscat2',
          'tuns',
          'iodine',
          'rshell',
          'rsh',
          'incbit',
          'kmod',
          'lushput',
          'mkfifo',
          'msfvenom',
          'nc',
          'socat'
        ) -- Chrome Stealer
        OR cmd LIKE '%set visible of front window to false%'
        OR cmd LIKE '%chrome%-load-extension%' -- Known attack scripts
        OR basename LIKE '%pwn%'
        OR basename LIKE '%attack%' -- Unusual behaviors
        OR cmd LIKE '%chattr -ia%'
        OR cmd LIKE '%chmod 777 %'
        OR cmd LIKE '%touch%acmr%'
        OR cmd LIKE '%touch -r%'
        OR cmd LIKE '%ld.so.preload%'
        OR cmd LIKE '%urllib.urlopen%'
        OR cmd LIKE '%nohup%tmp%'
        OR cmd LIKE '%killall Terminal%'
        OR cmd LIKE '%iptables stop'
        OR cmd LIKE '%pkill -f%'
        OR cmd LIKE '%rm -f /var/tmp%'
        OR cmd LIKE '%rm -rf /boot%'
        OR cmd LIKE '%rm -f /tmp%'
        OR cmd LIKE '%xargs kill -9%'
        OR cmd LIKE '%nohup /bin/bash%'
        OR cmd LIKE '%echo%|%base64 --decode %|%'
        OR cmd LIKE '%launchctl list%'
        OR (
          cmd LIKE '%UserKnownHostsFile=/dev/null%'
          AND NOT parent_name = 'limactl'
        ) -- Random keywords
        OR cmd LIKE '%ransom%' -- Reverse shells
        OR cmd LIKE '%fsockopen%'
        OR cmd LIKE '%openssl%quiet%'
        OR cmd LIKE '%pty.spawn%'
        OR (
          cmd LIKE '%sh -i'
          AND NOT parent_name = 'sh'
        )
        OR cmd LIKE '%socat%'
        OR cmd LIKE '%SOCK_STREAM%'
        OR (
          cmd LIKE '%Socket.%'
          AND NOT basename IN ('compile', 'sed', 'mv')
          AND NOT cmd LIKE "%sys/socket.h%"
        )
      ) -- Things that could reasonably happen at boot.
      AND NOT (
        p.path = '/usr/bin/mkfifo'
        AND cmd LIKE '%/org.gpgtools.log.%/fifo'
      )
      AND NOT (
        cmd LIKE '%csrutil status'
        AND parent_name IN ('Dropbox')
      ) -- The source of these commands is still a mystery to me.
      AND NOT (
        cmd IN (
          '/usr/bin/csrutil status',
          '/usr/bin/csrutil report'
        )
        AND p.parent = -1
      )
      AND NOT cmd LIKE '/bin/rm -f /tmp/periodic.%'
  description: Pick out exotic processes based on their command-line (events-based)
  name: 'Detection - Execution: Exotic Command Events Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Pick out exotic processes based on their command-line (state-based)
    --
    -- false positives:
    --   * possible, but none known
    --
    -- tags: transient process state
    -- platform: posix
    SELECT
      p.path,
      p.name,
      p.cmdline AS cmd,
      p.cwd,
      p.euid,
      p.parent,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmd,
      cp.name AS child_name,
      cp.cmdline AS child_cmd,
      hash.sha256 AS child_sha256,
      phash.sha256 AS parent_sha256
    FROM
      processes p
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN processes cp ON p.pid = cp.parent
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN hash AS phash ON pp.path = phash.path
    WHERE
      -- Known attack scripts
      p.name IN ('nc', 'mkfifo')
      OR p.name LIKE '%pwn%'
      OR p.name LIKE '%xig%'
      OR p.name LIKE '%xmr%'
      OR cmd LIKE '%bitspin%'
      OR cmd LIKE '%lushput%'
      OR cmd LIKE '%incbit%'
      OR cmd LIKE '%traitor%'
      OR cmd LIKE '%msfvenom%'
      -- Unusual behaviors
      OR cmd LIKE '%ufw disable%'
      OR cmd LIKE '%iptables -P % ACCEPT%'
      OR cmd LIKE '%iptables -F%'
      OR cmd LIKE '%chattr -ia%'
      OR cmd LIKE '%chmod 777 %'
      OR cmd LIKE '%bpftool%'
      OR cmd LIKE '%touch%acmr%'
      OR cmd LIKE '%ld.so.preload%'
      OR cmd LIKE '%urllib.urlopen%'
      OR cmd LIKE '%nohup%tmp%'
      OR cmd LIKE '%set visible of front window to false%'
      OR cmd LIKE '%chrome%--load-extension%'
      OR (cmd LIKE '%UserKnownHostsFile=/dev/null%' AND NOT parent_name='limactl')
      -- Crypto miners
      OR cmd LIKE '%c3pool%'
      OR cmd LIKE '%cryptonight%'
      OR cmd LIKE '%f2pool%'
      OR cmd LIKE '%hashrate%'
      OR cmd LIKE '%hashvault%'
      OR cmd LIKE '%minerd%'
      OR cmd LIKE '%monero%'
      OR cmd LIKE '%nanopool%'
      OR cmd LIKE '%nicehash%'
      OR cmd LIKE '%stratum%'
      -- Random keywords
      OR cmd LIKE '%ransom%'
      OR cmd LIKE '%malware%'
      OR cmd LIKE '%plant%'
      -- Reverse shells
      OR cmd LIKE '%/dev/tcp/%'
      OR cmd LIKE '%/dev/udp/%'
      OR cmd LIKE '%fsockopen%'
      OR cmd LIKE '%openssl%quiet%'
      OR cmd LIKE '%pty.spawn%'
      OR (cmd LIKE '%sh -i' AND NOT parent_name='sh')
      OR cmd LIKE '%socat%'
      OR cmd LIKE '%SOCK_STREAM%'
      OR cmd LIKE '%Socket.fork%'
      OR cmd LIKE '%Socket.new%'
      OR cmd LIKE '%socket.socket%'
  description: Pick out exotic processes based on their command-line (state-based)
  name: 'Detection - Execution: Exotic Commands'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Programs who were recently added to disk, based on btime/ctime
    --
    -- false-positives:
    --   * many
    --
    -- tags: transient process state often
    -- platform: linux
    SELECT
      p.pid,
      p.path,
      p.name,
      p.cmdline,
      p.cwd,
      p.euid,
      p.parent,
      f.directory,
      f.ctime,
      f.btime,
      f.mtime,
      p.start_time,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.cwd AS parent_cwd,
      pp.euid AS parent_euid,
      ch.sha256 AS child_sha256,
      ph.sha256 AS parent_sha256
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash AS ch ON p.path = ch.path
      LEFT JOIN hash AS ph ON pp.path = ph.path
    WHERE
      p.start_time > 0
      AND f.ctime > 0 -- Only process programs that had an inode modification within the last 3 minutes
      AND (p.start_time - MAX(f.ctime, f.btime)) < 180
      AND p.start_time >= MAX(f.ctime, f.ctime)
      AND NOT f.directory IN ('/usr/lib/firefox', '/usr/local/kolide-k2/bin') -- Typically daemons or long-running desktop apps
      AND NOT p.path IN (
        '',
        '/opt/google/chrome/chrome',
        '/usr/bin/containerd',
        '/usr/bin/dockerd',
        '/usr/bin/gedit',
        '/usr/bin/obs',
        '/usr/bin/pipewire',
        '/usr/bin/tailscaled',
        '/usr/bin/udevadm',
        '/usr/lib/at-spi2-registryd',
        '/usr/lib/at-spi-bus-launcher',
        '/usr/libexec/fwupd/fwupd',
        '/usr/libexec/sssd/sssd_kcm',
        '/usr/lib/fwupd/fwupd',
        '/usr/lib/gdm',
        '/usr/lib/gdm-session-worker',
        '/usr/lib/gdm-x-session',
        '/usr/lib/slack/chrome_crashpad_handler',
        '/usr/lib/slack/slack',
        '/usr/lib/systemd/systemd',
        '/usr/lib/systemd/systemd-journald',
        '/usr/lib/systemd/systemd-logind',
        '/usr/lib/systemd/systemd-oomd',
        '/usr/lib/systemd/systemd-resolved',
        '/usr/lib/systemd/systemd-timesyncd',
        '/usr/lib/x86_64-linux-gnu/obs-plugins/obs-browser-page',
        '/usr/lib/xf86-video-intel-backlight-helper',
        '/usr/sbin/chronyd',
        '/usr/sbin/cupsd',
        '/usr/sbin/tailscaled'
      )
      AND NOT p.path LIKE '%-go-build%'
      AND NOT p.path LIKE '/home/%/bin/%'
      AND NOT p.path LIKE '/home/%/terraform-provider-%'
      AND NOT p.path LIKE '/home/%/%.test'
      AND NOT p.path LIKE '/home/%/Projects/%'
      AND NOT p.path LIKE '/home/%/node_modules/.bin/exec-bin/%'
      AND NOT p.path LIKE '/nix/store/%/bin/%'
      AND NOT p.path LIKE '/usr/local/bin/%'
      AND NOT p.path LIKE '/usr/local/Cellar/%'
      AND NOT p.path LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
      AND NOT p.path LIKE '%/.vscode/extensions/%'
      AND NOT pp.path IN ('/usr/bin/gnome-shell') -- Filter out developers working on their own code
      AND NOT (
        p.path LIKE '/home/%'
        AND p.uid > 499
        AND f.ctime = f.mtime
        AND f.uid = p.uid
        AND p.cmdline LIKE './%'
      )
    GROUP BY
      p.pid
  description: Programs who were recently added to disk, based on btime/ctime
  name: 'Detection - Execution: Recently Created Executables Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Programs who were recently added to disk, based on btime/ctime
    --
    -- false-positives:
    --   * many
    --
    -- tags: transient process state often
    -- platform: darwin
    SELECT
      p.pid,
      p.path,
      p.name,
      p.cmdline,
      p.cwd,
      p.euid,
      p.parent,
      f.directory,
      f.ctime,
      f.btime,
      f.mtime,
      p.start_time,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.cwd AS parent_cwd,
      pp.euid AS parent_euid,
      ch.sha256 AS child_sha256,
      ph.sha256 AS parent_sha256,
      signature.authority,
      signature.identifier
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash AS ch ON p.path = ch.path
      LEFT JOIN hash AS ph ON pp.path = ph.path
      LEFT JOIN signature ON p.path = signature.path
    WHERE
      p.start_time > 0
      AND f.ctime > 0 -- Only process programs that had an inode modification within the last 3 minutes
      AND (p.start_time - MAX(f.ctime, f.btime)) < 180
      AND p.start_time >= MAX(f.ctime, f.ctime)
      AND signature.authority NOT IN (
        'Apple Mac OS Application Signing',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Brave Software, Inc. (KL8N8XSYF4)',
        'Developer ID Application: Brother Industries, LTD. (5HCL85FLGW)',
        'Developer ID Application: Bryan Jones (49EYHPJ4Q3)',
        'Developer ID Application: CodeWeavers Inc. (9C6B7X7Z8E)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Emmanouil Konstantinidis (3YP8SXP3BF)',
        'Developer ID Application: Galvanix (5BRAQAFB8B)',
        'Developer ID Application: General Arcade (Pte. Ltd.) (S8JLSG5ES7)',
        'Developer ID Application: GEORGE NACHMAN (H7V7XYVQ7D)',
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        'Developer ID Application: GitHub (VEKTX9H2N7)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Michael Jones (YD6LEYT6WZ)',
        'Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        'Developer ID Application: RescueTime, Inc (FSY4RB8H39)',
        'Developer ID Application: Seiko Epson Corporation (TXAEAV5RN4)',
        'Developer ID Application: Yubico Limited (LQA3CS5MM7)',
        'Software Signing'
      )
      AND NOT p.path LIKE '/Applications/%.app/%'
      AND NOT p.path LIKE '%-go-build%'
      AND NOT p.path LIKE '/Library/Apple/System/%'
      AND NOT p.path LIKE '/Library/Application Support/Adobe/Adobe Desktop Common/%'
      AND NOT p.path LIKE '%/Library/Application Support/com.elgato.StreamDeck%' -- Known parent processes, typically GUI shells and updaters
      AND NOT p.path LIKE '/Library/Application Support/Logitech.localized/%'
      AND NOT p.path LIKE '/nix/store/%/bin/%'
      AND NOT p.path LIKE '/opt/homebrew/bin/%'
      AND NOT p.path LIKE '/opt/homebrew/Cellar/%'
      AND NOT p.path LIKE '/private/tmp/%/Creative Cloud Installer.app/Contents/MacOS/Install'
      AND NOT p.path LIKE '/private/tmp/go-build%'
      AND NOT p.path LIKE '/private/tmp/nix-build-%'
      AND NOT p.path LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%'
      AND NOT p.path LIKE '/private/var/folders/%/bin/%'
      AND NOT p.path LIKE '/private/var/folders/%/go-build%'
      AND NOT p.path LIKE '/private/var/folders/%/T/download/ARMDCHammer'
      AND NOT p.path LIKE '/private/var/folders/%/GoLand/%'
      AND NOT p.path LIKE '/private/var/folders/%/T/pulumi-go.%'
      AND NOT p.path LIKE '/Users/%/bin/%'
      AND NOT p.path LIKE '/Users/%/code/%'
      AND NOT p.path LIKE '/Users/%/Library/Application Support/%/Contents/MacOS/%'
      AND NOT p.path LIKE '/Users/%/Library/Application Support/iTerm2/iTermServer-%'
      AND NOT p.path LIKE '/Users/%/Library/Caches/%/Contents/MacOS/%'
      AND NOT p.path LIKE '/Users/%/Library/Google/%.bundle/Contents/Helpers/%'
      AND NOT p.path LIKE '/Users/%/Library/Mobile Documents/%/Contents/Frameworks%'
      AND NOT p.path LIKE '/Users/%/terraform-provider-%'
      AND NOT p.path LIKE '/Users/%/%.test'
      AND NOT p.path LIKE '/usr/local/bin/%'
      AND NOT p.path LIKE '/usr/local/Cellar/%'
      AND NOT p.path LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
      AND NOT p.path LIKE '%/.vscode/extensions/%'
      AND NOT (
        p.path LIKE '/Users/%'
        AND p.uid > 499
        AND f.ctime = f.mtime
        AND f.uid = p.uid
        AND p.cmdline LIKE './%'
      )
    GROUP BY
      p.pid
  description: Programs who were recently added to disk, based on btime/ctime
  name: 'Detection - Execution: Recently Created Executables Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Uncover reverse-shell processes
    --
    -- refs:
    --   * https://www.invicti.com/blog/web-security/understanding-reverse-shells/
    --   * https://attack.mitre.org/techniques/T1059/ (Command & Scripting Interpreter)
    --
    -- false-positives:
    --   * none known
    --
    -- tags: transient process state often
    -- platform: posix
    SELECT DISTINCT
      (p.pid),
      p.parent,
      p.name,
      p.path,
      p.cmdline,
      p.cwd,
      p.root,
      p.uid,
      p.gid,
      p.start_time,
      pos.remote_address,
      pos.remote_port,
      pp.cmdline,
      pp.path
    FROM
      process_open_files pof
      JOIN process_open_sockets pos USING (pid)
      LEFT JOIN processes p ON pof.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT OUTER JOIN process_open_files ON p.pid = process_open_files.pid
    WHERE
      p.name IN ('sh', 'bash', 'perl', 'python')
      AND pof.pid IS NULL
      AND pos.remote_port > 0
      AND NOT (
        p.path = '/usr/bin/bash'
        AND pp.cmdline LIKE 'pacman -S%'
      )
  description: Uncover reverse-shell processes
  name: 'Detection - Execution: Reverse Shell Socket'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Suspicious URL requests by built-in fetching tools (event-based)
    --
    -- refs:
    --   * https://attack.mitre.org/techniques/T1105/ (Ingress Tool Transfer)
    --   * https://attack.mitre.org/techniques/T1571/ (Non-Standard Port)
    --
    -- interval: 60
    -- tags: transient process events
    -- platform: posix
    SELECT
      p.pid,
      p.path,
      p.cmdline,
      REGEX_MATCH (p.cmdline, '/(\d+\.\d+\.\d+\.\d+)[:/]', 1) AS remote_address,
      REGEX_MATCH (p.cmdline, '/(:\d+\/)/', 1) AS remote_port,
      p.mode,
      p.cwd,
      p.euid,
      p.parent,
      p.syscall,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.euid AS parent_euid,
      hash.sha256 AS parent_sha256
    FROM
      process_events p
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON pp.path = hash.path
    WHERE
      p.time > (strftime('%s', 'now') -60)
      -- NOTE: Sync remaining portion with sketchy-fetchers
      AND (
        INSTR(p.cmdline, 'wget ') > 0
        OR INSTR(p.cmdline, 'curl ') > 0
      )
      AND (
        -- If it's an IP or port, it's suspicious
        remote_address NOT IN ('', '127.0.0.1', '::1')
        OR remote_port != ''
        -- Or if it matches weird keywords we've seen
        OR p.cmdline LIKE '%.onion%'
        OR p.cmdline LIKE '%tor2web%'
        OR p.cmdline LIKE '%aliyun%'
        OR p.cmdline LIKE '%pastebin%'
        OR p.cmdline LIKE '%curl.*write-out%'
        OR p.cmdline LIKE '%curl %--user-agent%'
        OR p.cmdline LIKE '%curl -k%'
        OR p.cmdline LIKE '%curl -sL %'
        OR p.cmdline LIKE '%curl%--connect-timeout%'
        OR p.cmdline LIKE '%curl%--output /dev/null%'
        OR p.cmdline LIKE '%curl%--O /dev/null%'
        OR p.cmdline LIKE '%curl%--insecure%'
        OR p.cmdline LIKE '%wget %--user-agent%'
        OR p.cmdline LIKE '%wget %--no-check-certificate%'
        OR p.cmdline LIKE '%wget -nc%'
        OR p.cmdline LIKE '%wget -t%'
        -- Or anything launched by a system user
        OR (
          p.cmdline LIKE '%wget -%'
          AND p.euid < 500
        )
        OR (
          p.cmdline LIKE '%curl %'
          AND p.euid < 500
          AND p.cmdline NOT LIKE "%./configure %--with-curl%"
        )
      )
      -- Exceptions for all calls
      AND pp.name NOT IN ('makepkg', 'apko') -- Exceptions for non-privileged calls
      AND NOT (
        p.euid > 500
        AND (
          p.cmdline LIKE '%--dump-header%'
          OR p.cmdline LIKE '%127.0.0.1:%'
          OR p.cmdline LIKE '%/192.168.%:%'
          OR p.cmdline LIKE '%/api/v%'
          OR p.cmdline LIKE '%application/json%'
          OR p.cmdline LIKE '%/chainctl_%'
          OR p.cmdline LIKE '%ctlog%'
          OR p.cmdline LIKE '%curl -X %'
          OR p.cmdline LIKE 'git %'
          OR p.cmdline LIKE '%go mod %'
          OR p.cmdline LIKE '%grpcurl%'
          OR p.cmdline LIKE '%Homebrew%'
          OR p.cmdline LIKE '%https://api.github.com/%'
          OR p.cmdline LIKE '%If-None-Match%'
          OR p.cmdline LIKE "%libcurl%"
          OR p.cmdline LIKE '%LICENSES/vendor/%'
          OR p.cmdline LIKE '%localhost:%'
          OR p.cmdline LIKE '%/openid/v1/jwks%'
          OR p.cmdline LIKE '%--progress-bar%'
          OR p.cmdline LIKE '%.well-known/openid-configuration%'
          OR p.cmdline LIKE 'wget --no-check-certificate https://github.com/'
          OR p.cmdline LIKE 'curl -sL wttr.in%'
          OR parent_cmdline LIKE '%brew.rb%'
          OR parent_cmdline LIKE '%brew.sh%'
        )
      )
  description: Suspicious URL requests by built-in fetching tools (event-based)
  name: 'Detection - Execution: Sketchy Fetcher Events'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Suspicious URL requests by built-in fetching tools (state-based)
    --
    -- refs:
    --   * https://attack.mitre.org/techniques/T1105/ (Ingress Tool Transfer)
    --   * https://attack.mitre.org/techniques/T1571/ (Non-Standard Port)
    --
    -- tags: transient process state
    -- platform: posix
    SELECT
      p.pid,
      p.path,
      p.name,
      p.cmdline,
      REGEX_MATCH (p.cmdline, '/(\d+\.\d+\.\d+\.\d+)[:/]', 1) AS remote_address,
      REGEX_MATCH (p.cmdline, '/(:\d+\/)/', 1) AS remote_port,
      p.cwd,
      p.euid,
      p.parent,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.euid AS parent_euid,
      hash.sha256 AS parent_sha256
    FROM
      processes p
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON pp.path = hash.path
    WHERE
      -- NOTE: Sync remaining portion with sketchy-fetcher-events
      (
        INSTR(p.cmdline, 'wget ') > 0
        OR INSTR(p.cmdline, 'curl ') > 0
      )
      AND (
        remote_address NOT IN ('', '127.0.0.1', '::1')
        OR remote_port != ''
        OR p.cmdline LIKE '%.onion%'
        OR p.cmdline LIKE '%tor2web%'
        OR p.cmdline LIKE '%aliyun%'
        OR p.cmdline LIKE '%pastebin%'
        OR p.cmdline LIKE '%curl %--user-agent%'
        OR p.cmdline LIKE '%curl -k%'
        OR p.cmdline LIKE '%curl -sL %'
        OR p.cmdline LIKE '%curl%--insecure%'
        OR p.cmdline LIKE '%wget %--user-agent%'
        OR p.cmdline LIKE '%wget %--no-check-certificate%'
        OR p.cmdline LIKE '%curl%--connect-timeout%'
        OR p.cmdline LIKE '%wget -nc%'
        OR p.cmdline LIKE '%wget -t%'
        OR (
          p.cmdline LIKE '%wget %'
          AND p.euid < 500
        )
        OR (
          p.cmdline LIKE '%curl %'
          AND p.euid < 500
          AND p.cmdline NOT LIKE "%./configure %--with-curl%"
        )
      )
      -- Exceptions for all calls
      AND pp.name NOT IN ('makepkg') -- Exceptions for non-privileged calls
      AND NOT (
        p.euid > 500
        AND (
          p.cmdline LIKE '%--dump-header%'
          OR p.cmdline LIKE '%/api/v%'
          OR p.cmdline LIKE '%curl -X %'
          OR p.cmdline LIKE '%go mod %'
          OR p.cmdline LIKE '%application/json%'
          OR p.cmdline LIKE '%grpcurl%'
          OR p.cmdline LIKE '%Homebrew%'
          OR p.cmdline LIKE '%Nixpkgs/%'
          OR p.cmdline LIKE '%If-None-Match%'
          OR p.cmdline LIKE '%ctlog%'
          OR p.cmdline LIKE '%.well-known/openid-configuration%'
          OR p.cmdline LIKE '%/openid/v1/jwks%'
          OR p.cmdline LIKE '%--progress-bar%'
          OR parent_cmdline LIKE '%brew.rb%'
          OR parent_cmdline LIKE '%brew.sh%'
          OR parent_cmdline LIKE '/nix/store/%-builder.sh'
          OR p.cmdline LIKE 'git %'
          OR p.cmdline LIKE '%LICENSES/vendor/%'
          OR p.cmdline LIKE '%localhost:%'
          OR p.cmdline LIKE '%127.0.0.1:%'
          OR p.name IN ('apko')
        )
      )
  description: Suspicious URL requests by built-in fetching tools (state-based)
  name: 'Detection - Execution: Sketchy Fetcher'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unusually small programs (events-based)
    --
    -- references:
    --   * https://cybersecurity.att.com/blogs/labs-research/shikitega-new-stealthy-malware-targeting-linux
    --
    -- interval: 30
    -- tags: transient process events
    SELECT
      p.pid,
      p.path,
      p.cmdline,
      file.size,
      p.mode,
      p.cwd,
      p.euid,
      p.parent,
      p.syscall,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.euid AS parent_euid,
      hash.sha256 AS parent_sha256
    FROM
      process_events p
      LEFT JOIN file ON p.path = file.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON pp.path = hash.path
    WHERE
      p.time > (strftime('%s', 'now') -30)
      AND file.size > 0
      AND file.size < 10000
      AND p.path NOT LIKE '%.sh'
      AND p.path NOT LIKE '%.py'
      AND p.path NOT LIKE '%.rb'
      -- Removes a false-positive we've seen on Linux, generated through 'runc init'
      AND NOT (
        p.path = "/"
        AND file.size < 8192
      )
  description: Unusually small programs (events-based)
  name: 'Detection - Execution: Tiny Executable Events'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Unusually small programs (state-based)
    --
    -- references:
    --   * https://cybersecurity.att.com/blogs/labs-research/shikitega-new-stealthy-malware-targeting-linux
    --
    -- tags: transient process state
    SELECT
      p.pid,
      p.path,
      p.cmdline,
      file.size,
      file.mode,
      p.cwd,
      p.euid,
      p.parent,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.euid AS parent_euid,
      hash.sha256 AS parent_sha256
    FROM
      processes p
      LEFT JOIN file ON p.path = file.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON pp.path = hash.path
    WHERE
      file.size > 0
      AND file.size < 10000
  description: Unusually small programs (state-based)
  name: 'Detection - Execution: Tiny Executable'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Applications setting environment variables to bypass security protections
    --
    -- Inpsired by BPFdoor and other intrusions
    -- https://www.sandflysecurity.com/blog/compromised-linux-cheat-sheet/
    --
    -- WARNING: This query is known to require a higher than average wall time.
    --
    -- tags: transient state
    -- platform: linux
    SELECT
      key,
      value,
      p.pid,
      p.path,
      p.cmdline,
      p.parent AS parent_pid,
      pp.cmdline AS parent_cmd
    FROM
      process_envs pe
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
    WHERE
      (
        key = 'HISTFILE'
        AND NOT VALUE LIKE '/home/%/.%_history'
      )
      OR (
        key = 'LD_PRELOAD'
        AND NOT p.path LIKE '%/firefox'
        AND NOT pe.value = 'libfakeroot.so'
        AND NOT pe.value LIKE ':/home/%/.local/share/Steam'
        AND NOT pe.value LIKE ':/home/%/.var/app/com.valvesoftware.Steam/%'
        AND NOT pe.value LIKE ':/snap/%'
        AND NOT pe.value LIKE '/app/bin/%'
        AND NOT pe.value LIKE 'libmozsandbox.so%'
      )
  description: Applications setting environment variables to bypass security protections
  name: 'Detection - Execution: Unexpected Env Values Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Applications setting environment variables to bypass security protections
    --
    -- Inpsired by BPFdoor and other intrusions
    -- https://www.sandflysecurity.com/blog/compromised-linux-cheat-sheet/
    --
    -- WARNING: This query is known to require a higher than average wall time.
    --
    -- tags: transient state rapid
    -- platform: darwin
    SELECT
      key,
      value,
      p.pid,
      p.path,
      p.cmdline,
      p.parent AS parent_pid,
      pp.cmdline AS parent_cmd
    FROM
      process_envs pe
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
    WHERE
      (
        key = 'HISTFILE'
        AND NOT VALUE LIKE '/Users/%/.%_history'
      )
      OR (
        key = 'LD_PRELOAD'
        AND NOT p.path LIKE '%/firefox'
        AND NOT pe.value = 'libfakeroot.so'
        AND NOT pe.value LIKE 'libmozsandbox.so%'
        AND NOT pe.value LIKE ':/snap/%' -- Yes, on macOS (emote)
      )
      OR (
        key = 'DYLD_INSERT_LIBRARIES' -- actively exploited on programs which disable library security
      )
      OR (
        key = 'DYLD_FRAMEWORK_PATH' -- sort of obsolete, but may affect SIP abusers
      )
  description: Applications setting environment variables to bypass security protections
  name: 'Detection - Execution: Unexpected Env Values Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Catch applications running from unusual directories, such as /tmp (event-based)
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1074/
    --
    -- false positives:
    --   * programs running in alternative namespaces (Docker)
    --
    -- interval: 60
    -- platform: linux
    -- tags: process events
    SELECT
      pe.pid,
      pe.path,
      REGEX_MATCH (pe.path, '(.*)/', 1) AS dirname,
      pe.mode,
      pe.cwd,
      pe.euid,
      pe.parent,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmd,
      pp.euid AS parent_euid,
      phash.sha256 AS parent_sha256,
      hash.sha256 AS sha256
    FROM
      process_events pe
      LEFT JOIN processes p ON pe.pid = pe.pid
      LEFT JOIN processes pp ON pe.parent = p.pid
      LEFT JOIN hash ON pe.path = hash.path
      LEFT JOIN hash phash ON pp.path = hash.path
    WHERE
      pe.time > (strftime('%s', 'now') -60)
      AND dirname NOT LIKE '/home/%'
      AND dirname NOT LIKE '/nix/store/%/bin'
      AND dirname NOT LIKE '/nix/store/%/lib/%'
      AND dirname NOT LIKE '/nix/store/%/libexec'
      AND dirname NOT LIKE '/nix/store/%/libexec/%'
      AND dirname NOT LIKE '/nix/store/%/share/%'
      AND dirname NOT LIKE '/opt/%'
      AND dirname NOT LIKE '/tmp/go-build%'
      AND dirname NOT LIKE '/snap/%'
      AND dirname NOT LIKE '/usr/libexec/%'
      AND dirname NOT LIKE '/usr/local/%/bin/%'
      AND dirname NOT LIKE '/usr/local/%bin'
      AND dirname NOT LIKE '/usr/local/%libexec'
      and dirname NOT LIKE '/usr/local/Cellar/%'
      AND dirname NOT LIKE '/usr/lib/%'
      AND dirname NOT LIKE '/usr/lib64/%'
      AND dirname NOT LIKE '/tmp/%/bin'
      AND dirname NOT LIKE '/usr/local/go/pkg/tool/%'
      AND dirname NOT IN (
        '/',
        '/app',
        '/bin',
        '/ko-app',
        '/sbin',
        '/usr/bin',
        '/usr/lib',
        '/usr/lib64/firefox',
        '/usr/lib/bluetooth',
        '/usr/lib/cups/notifier',
        '/usr/lib/evolution-data-server',
        '/usr/libexec',
        '/usr/libexec/ApplicationFirewall',
        '/usr/libexec/rosetta',
        '/usr/lib/firefox',
        '/usr/lib/fwupd',
        '/usr/lib/ibus',
        '/usr/lib/libreoffice/program',
        '/usr/lib/polkit-1',
        '/usr/lib/slack',
        '/usr/lib/snapd',
        '/usr/lib/systemd',
        '/usr/lib/telepathy',
        '/usr/lib/udisks2',
        '/usr/lib/xorg',
        '/usr/sbin',
        '/usr/share/code',
        '/usr/share/teams',
        '/usr/share/teams/resources/app.asar.unpacked/node_modules/slimcore/bin'
      )
      AND NOT pe.path IN ('/usr/lib32/ld-linux.so.2')
      AND NOT (
        dirname = ''
        AND p.name LIKE 'runc%'
      )
      AND NOT (
        dirname = ''
        AND parent_name IN ('dockerd')
      )
      AND NOT (pe.euid = 65532)
    GROUP BY
      pe.pid
  description: Catch applications running from unusual directories, such as /tmp (event-based)
  name: 'Detection - Execution: Unexpected Execdir Events Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Catch applications running from unusual directories, such as /tmp
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1074/
    --
    -- false positives:
    --   * software installers and updaters
    --   * developers running programs out of /tmp
    --
    -- interval: 60
    -- platform: darwin
    -- tags: filesystem events
    SELECT
      p.pid,
      p.path,
      REGEX_MATCH (p.path, '(.*)/', 1) AS dirname,
      REPLACE(file.directory, u.directory, '~') AS homedir,
      p.cmdline,
      p.mode,
      p.cwd,
      p.euid,
      p.parent,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmd,
      pp.euid AS parent_euid,
      hash.sha256 AS parent_sha256
    FROM
      process_events p
      LEFT JOIN processes ON p.pid = processes.pid
      LEFT JOIN file ON p.path = file.path
      LEFT JOIN users u ON p.uid = u.uid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON pp.path = hash.path
    WHERE
      p.time > (strftime('%s', 'now') -60)
      -- The process_events table on macOS ends up with relative directories for some reason?
      AND dirname LIKE '/%'
      AND file.size > 0
      AND dirname NOT IN (
        '/bin',
        '/Library/DropboxHelperTools/Dropbox_u501',
        '/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers/GoogleSoftwareUpdateAgent.app/Contents/MacOS',
        '/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers.app/Contents/MacOS',
        '/Library/Printers/DYMO/Utilities',
        '/Library/Application Support/Logitech.localized/Logitech Options.localized/LogiMgrUpdater.app/Contents/Resources',
        '/usr/lib/system',
        '/Library/PrivilegedHelperTools',
        '/sbin',
        '/nix/store',
        '/usr/bin',
        '/usr/lib',
        '/Library/TeX/texbin',
        '/usr/lib/bluetooth',
        '/usr/lib/cups/notifier',
        '/Library/Frameworks/Python.framework/Versions/3.10/bin',
        '/usr/libexec',
        '/usr/libexec/ApplicationFirewall',
        '/usr/libexec/rosetta',
        '/node_modules/.bin',
        '/nix/var/nix/profiles/default/bin',
        '/run/current-system/sw/bin',
        '/usr/libexec/firmwarecheckers/eficheck',
        '/usr/sbin',
        '/usr/share/code'
      )
      AND dirname NOT LIKE '/Applications/%.app/%'
      AND dirname NOT LIKE '/etc/profiles/per-user/%/bin'
      AND dirname NOT LIKE '/home/%'
      AND dirname NOT LIKE '/Library/%/%.bundle/Contents/Helpers'
      AND dirname NOT LIKE '/Library/%/Resources/%/Contents/MacOS'
      AND dirname NOT LIKE '/Library/%/sbin' -- Nessus
      AND dirname NOT LIKE '/Library/Apple/System/%'
      AND dirname NOT LIKE '/Library/Application Support/%/Contents/MacOS'
      AND dirname NOT LIKE '/Library/Application Support/Adobe/%'
      AND dirname NOT LIKE '/Library/Audio/Plug-Ins/%/Contents/MacOS'
      AND dirname NOT LIKE '/Library/CoreMediaIO/Plug-Ins/%'
      AND dirname NOT LIKE '/Library/Developer/%'
      AND dirname NOT LIKE '/Library/Developer/CommandLineTools/Library/%'
      AND dirname NOT LIKE '/Library/Internet Plug-Ins/%/Contents/MacOS'
      AND dirname NOT LIKE '/Library/Java/JavaVirtualMachines/%'
      AND dirname NOT LIKE '/Library/SystemExtensions/%'
      AND dirname NOT LIKE '/nix/store/%'
      AND dirname NOT LIKE '/opt/%'
      AND dirname NOT LIKE '/private/tmp/go-build%/exe'
      AND dirname NOT LIKE '/private/tmp/nix-build-%'
      AND dirname NOT LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%.xpc/Contents/MacOS'
      AND dirname NOT LIKE '/private/var/folders/%/bin'
      AND dirname NOT LIKE '/private/var/folders/%/Contents/%'
      AND dirname NOT LIKE '/private/var/folders/%/go-build%'
      AND dirname NOT LIKE '/private/var/folders/%/GoLand'
      AND dirname NOT LIKE '/snap/%'
      AND dirname NOT LIKE '/store/%/bin'
      AND dirname NOT LIKE '/System/%'
      AND dirname NOT LIKE '/Users/%'
      AND dirname NOT LIKE '/usr/libexec/%'
      AND dirname NOT LIKE '/usr/local/%'
      AND dirname NOT LIKE '/Volumes/com.getdropbox.dropbox-%'
      -- Unexplained data issue
      AND dirname NOT LIKE '../%'
      AND p.path NOT IN (
        '/Applications/Stats.app/Contents/MacOS/Stats',
        '/usr/libexec/AssetCache/AssetCache',
        '_build/krew/bin/git',
        '/Library/PrivilegedHelperTools/com.adobe.acc.installer.v2',
        '/Library/DropboxHelperTools/DropboxHelperInstaller',
        '/Library/PrivilegedHelperTools/com.adobe.ARMDC.Communicator',
        '/Library/PrivilegedHelperTools/com.adobe.ARMDC.SMJobBlessHelper',
        '/Library/PrivilegedHelperTools/com.docker.vmnetd',
        '/Library/PrivilegedHelperTools/com.macpaw.CleanMyMac4.Agent',
        '/Library/PrivilegedHelperTools/keybase.Helper'
      )
      -- Nix
      AND parent_path NOT LIKE '/nix/store/%'
      -- Homebrew and other compilations
      AND parent_cmd NOT LIKE '%./configure%'
      -- Pulumi executables are often executed from $TMPDIR
      AND NOT (
        dirname LIKE '/private/var/%'
        AND processes.name LIKE 'pulumi-go.%'
      )
      -- Chrome executes patches from /tmp :(
      AND NOT (
        dirname LIKE '/private/tmp/%'
        AND processes.name = 'goobspatch'
      )
      -- Don't spam alerts with repeated invocations of the same command-line
    GROUP BY
      p.cmdline,
      p.cwd,
      p.euid
  description: Catch applications running from unusual directories, such as /tmp
  name: 'Detection - Execution: Unexpected Execdir Events Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Programs running out of unexpected directories, such as /tmp (state-based)
    --
    -- references:
    --   * https://blog.talosintelligence.com/2022/10/alchimist-offensive-framework.html
    --
    -- tags: transient process rapid state
    -- platform: linux
    SELECT
      p.pid,
      p.name,
      p.path,
      p.euid,
      p.gid,
      f.ctime,
      f.directory AS dirname,
      p.cmdline,
      hash.sha256,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.euid AS parent_euid,
      hash.sha256 AS parent_sha256
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN hash ON hash.path = p.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      -- NOTE: Everything after this is shared with process_events/unexpected-executable-directory-events
    WHERE
      dirname NOT IN (
        '/bin',
        '/usr/share/teams/resources/app.asar.unpacked/node_modules/slimcore/bin',
        '/sbin',
        '/usr/bin',
        '/usr/lib',
        '/usr/lib/bluetooth',
        '/usr/lib/cups/notifier',
        '/usr/share/teams',
        '/usr/lib/evolution-data-server',
        '/usr/lib/firefox',
        '/usr/lib/fwupd',
        '/usr/lib/ibus',
        '/usr/lib/libreoffice/program',
        '/usr/lib/polkit-1',
        '/usr/lib/slack',
        '/usr/lib/snapd',
        '/usr/lib/systemd',
        '/usr/lib/telepathy',
        '/usr/lib/udisks2',
        '/usr/lib/xorg',
        '/usr/lib64/firefox',
        '/usr/libexec',
        '/usr/sbin',
        '/usr/share/code'
      )
      AND dirname NOT LIKE '/home/%'
      AND dirname NOT LIKE '/nix/store/%'
      AND dirname NOT LIKE '/opt/%'
      AND dirname NOT LIKE '/snap/%'
      AND dirname NOT LIKE '/tmp/%/bin'
      AND dirname NOT LIKE '/tmp/go-build%'
      AND dirname NOT LIKE '/usr/lib/%'
      AND dirname NOT LIKE '/usr/lib64/%'
      AND dirname NOT LIKE '/usr/libexec/%'
      AND dirname NOT LIKE '/usr/local/%'
      AND p.path NOT IN (
        '/usr/lib/firefox/firefox',
        '/usr/lib64/firefox/firefox'
      )
      AND NOT (
        dirname = ''
        AND p.name LIKE 'runc%'
      )
  description: Programs running out of unexpected directories, such as /tmp (state-based)
  name: 'Detection - Execution: Unexpected Execdir Linux'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find programs running from strange directories on macOS
    --
    -- false positives:
    --   - Vendors who are doing weird things that are not in the signature list
    --
    -- See "execdir-events" for the version that is more likely to catch things
    --
    -- platform: darwin
    -- tags: transient seldom process filesystem state
    SELECT
      p.pid,
      p.name,
      p.path,
      p.euid,
      p.gid,
      f.ctime,
      f.directory AS dirname,
      REPLACE(f.directory, u.directory, '~') AS dirname,
      p.cmdline,
      hash.sha256,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.euid AS parent_euid,
      hash.sha256 AS parent_sha256,
      signature.identifier,
      signature.authority
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN hash ON hash.path = p.path
      LEFT JOIN users u ON p.uid = u.uid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN signature ON p.path = signature.path -- NOTE: Everything after this is shared with process_events/unexpected-executable-directory-events
    WHERE
      dirname NOT IN (
        '/bin',
        '/Library/DropboxHelperTools/Dropbox_u501',
        '/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers/GoogleSoftwareUpdateAgent.app/Contents/MacOS',
        '/Library/Printers/DYMO/Utilities',
        '/Library/PrivilegedHelperTools',
        '/opt/homebrew/Caskroom/google-cloud-sdk/latest/google-cloud-sdk/bin/gke-gcloud-auth-plugin',
        '/opt/usr/bin',
        '/opt/X11/bin',
        '/opt/X11/libexec',
        '/sbin',
        '/usr/bin',
        '/usr/lib',
        '/usr/lib/bluetooth',
        '/usr/lib/cups/notifier',
        '/usr/lib/fwupd',
        '/usr/lib/ibus',
        '/usr/libexec',
        '/usr/libexec/ApplicationFirewall',
        '/usr/libexec/AssetCache',
        '/usr/libexec/rosetta',
        '/usr/sbin',
        '/usr/share/code',
        '/usr/share/teams/resources/app.asar.unpacked/node_modules/slimcore/bin'
      )
      AND homedir NOT IN (
        '~/bin',
        '~/go/bin',
        '~/Library/Application Support/cloud-code/installer/google-cloud-sdk/bin',
        '~/Library/Application Support/Code/User/globalStorage/grafana.vscode-jsonnet/bin',
        '~/Library/Application Support/com.elgato.StreamDeck/Plugins/com.lostdomain.zoom.sdPlugin'
      )
      AND signature.authority NOT IN (
        'Apple Mac OS Application Signing',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',
        'Developer ID Application: Figma, Inc. (T8RA8NE3B7)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: CodeWeavers Inc. (9C6B7X7Z8E)',
        'Developer ID Application: GEORGE NACHMAN (H7V7XYVQ7D)',
        'Developer ID Application: Hashicorp, Inc. (D38WU7D763)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        'Developer ID Application: Objective-See, LLC (VBG97UB4TA)',
        'Developer ID Application: Opal Camera Inc (97Z3HJWCRT)',
        'Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        'Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        'Developer ID Application: Tenable, Inc. (4B8J598M7U)',
        'Developer ID Application: Valve Corporation (MXGJJ98X76)',
        'Developer ID Application: Wireshark Foundation, Inc. (7Z6EMTD2C6)',
        'Apple iPhone OS Application Signing',
        'Developer ID Application: Node.js Foundation (HX7739G8FX)',
        'Software Signing'
      )
      AND homedir NOT LIKE '~/%/node_modules/.pnpm/esbuild-%/node_modules/esbuild-darwin-arm64/bin'
      AND dirname NOT LIKE '/private/var/folders/%/d/Wrapper/%.app'
      AND dirname NOT LIKE '/Applications/%.app/%'
      AND dirname NOT LIKE '/Applications/Utilities/Adobe Creative Cloud/%'
      AND dirname NOT LIKE '/Library/%/%.bundle/Contents/Helpers'
      AND dirname NOT LIKE '/Library/%/Resources/%/Contents/MacOS'
      AND dirname NOT LIKE '/Library/%/sbin' -- Nessus
      AND dirname NOT LIKE '/Library/Apple/System/Library%'
      AND dirname NOT LIKE '/Library/Application Support/%/Contents/MacOS'
      AND dirname NOT LIKE '/Library/Application Support/Adobe/%'
      AND dirname NOT LIKE '/Library/Audio/Plug-Ins/%/Contents/MacOS'
      AND dirname NOT LIKE '/Library/CoreMediaIO/Plug-Ins/%'
      AND dirname NOT LIKE '/Library/Developer/%'
      AND dirname NOT LIKE '/Library/Developer/CommandLineTools/Library/%'
      AND dirname NOT LIKE '/Library/Internet Plug-Ins/%/Contents/MacOS'
      AND dirname NOT LIKE '/Library/Java/JavaVirtualMachines/%'
      AND dirname NOT LIKE '/Library/Printers/%.app/Contents/MacOS'
      AND dirname NOT LIKE '/Library/PrivilegedHelperTools/com.%'
      AND dirname NOT LIKE '/nix/store/%'
      AND dirname NOT LIKE '/opt/homebrew/Cellar/%/bin'
      AND dirname NOT LIKE '/opt/homebrew/Cellar/%/libexec'
      AND dirname NOT LIKE '/opt/homebrew/Cellar/%/libexec/%'
      AND dirname NOT LIKE '/opt/homebrew/Cellar/%/Contents/MacOS'
      AND dirname NOT LIKE '/opt/homebrew/Caskroom/%/bin'
      AND dirname NOT LIKE '/private/tmp/%.app/Contents/MacOS'
      AND dirname NOT LIKE '/private/tmp/go-build%/exe'
      AND dirname NOT LIKE '/private/tmp/nix-build-%'
      AND dirname NOT LIKE '/private/tmp/PKInstallSandbox.%/Scripts/com.microsoft.OneDrive.%'
      AND dirname NOT LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%.xpc/Contents/MacOS'
      AND dirname NOT LIKE '/private/var/folders/%/bin'
      AND dirname NOT LIKE '/private/var/folders/%/Contents/%'
      AND dirname NOT LIKE '/private/var/folders/%/go-build%'
      AND dirname NOT LIKE '/private/var/folders/%/GoLand'
      AND dirname NOT LIKE '/System/%'
      AND dirname NOT LIKE '/Users/%/bin/%'
      AND dirname NOT LIKE '/Users/%/src/%'
      AND dirname NOT LIKE '/usr/libexec/%'
      AND dirname NOT LIKE '/usr/local/%'
      AND NOT (
        dirname LIKE '/private/var/%'
        AND p.name LIKE 'pulumi-go.%'
      ) -- Chrome executes patches from /tmp :(
      AND NOT (
        dirname LIKE '/private/tmp/%'
        AND p.name = 'goobspatch'
      )
      AND NOT (
        homedir = '~'
        AND p.name = 'cloud_sql_proxy'
      )
  description: Find programs running from strange directories on macOS
  name: 'Detection - Execution: Unexpected Execdir Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find processes running that are tied to binaries with unsual permissions. Namely, 0777.
    --
    -- references:
    --   * https://attack.mitre.org/techniques/T1222/
    --
    -- false positives:
    --   * poorly written software
    --
    -- platform: posix
    -- tags: persistent filesystem state
    SELECT
      p.pid,
      p.name,
      p.path,
      f.mode,
      f.uid,
      f.gid,
      hash.sha256,
      pp.name AS parent_name,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmd,
      hash.sha256 AS parent_sha256
    FROM
      processes p
      JOIN file f ON p.path = f.path
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN processes pp ON pp.pid = p.parent
    WHERE
      f.mode NOT IN (
        '0500',
        '0544',
        '0555',
        '0711',
        '0755',
        '0775',
        '6755',
        '0700',
        '2755',
        '4511',
        '4555',
        '4755'
      )
      -- Vendors who are very relaxed about permissions
      AND NOT (
        f.path IN (
          '/Library/Application Support/Logitech/com.logitech.vc.LogiVCCoreService/LogiVCCoreService.app/Contents/MacOS/LogiVCCoreService',
          '/Applications/Camera Settings.app/Contents/MacOS/LogitechCamera'
        )
        AND f.mode = '0777'
        AND f.uid > 500
      )
      AND NOT (
        f.path LIKE '/Users/%/Library/Application Support/Code/User/globalStorage/grafana.vscode-jsonnet/bin/jsonnet-language-server'
        AND f.mode = '0777'
        AND f.uid > 500
      )
      AND NOT (
        f.path = '/usr/bin/sudo'
        AND f.mode = '0411'
        AND f.uid = 0
      )
      AND NOT (
        f.path LIKE '/home/%/.local/share/JetBrains/Toolbox/bin/jetbrains-toolbox'
        AND f.mode = '0744'
        AND f.uid = 0
      )
  description: Find processes running that are tied to binaries with unsual permissions. Namely, 0777.
  name: 'Detection - Execution: Unexpected Executable Permissions'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Gatekeeper exceptions are exceptions for downloaded binaries
    --
    -- references:
    --   * https://posts.specterops.io/hunting-for-bad-apples-part-2-6f2d01b1f7d3
    --
    -- false positives:
    --   * developers downloading binaries from Github
    --
    -- platform: darwin
    -- tags: persistent filesystem state gatekeeper
    SELECT
      gap.ctime,
      gap.mtime,
      gap.path,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      signature.identifier,
      signature.authority
    FROM
      gatekeeper_approved_apps AS gap
      LEFT JOIN file ON gap.path = file.path
      LEFT JOIN hash ON gap.path = hash.path
      LEFT JOIN signature ON gap.path = signature.path
    WHERE
      gap.path NOT LIKE '/Users/%/bin/%'
      AND gap.path NOT LIKE '/Users/%/rekor-cli'
      AND gap.path NOT LIKE '/usr/local/bin/%'
      AND gap.path NOT LIKE '/Users/%/scorecard-darwin-amd64'
      AND gap.path NOT LIKE '/Users/%/scorecard-darwin-amd64'
      AND gap.path NOT LIKE '/Users/%/configure'
    GROUP BY
      gap.requirement
  description: Gatekeeper exceptions are exceptions for downloaded binaries
  name: 'Detection - Execution: Unexpected Gatekeeper Approvals Macos'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Detect weird mounts, like mounting the EFI partition
    --
    -- references:
    --   * https://www.welivesecurity.com/2022/07/19/i-see-what-you-did-there-look-cloudmensis-macos-spyware/
    --
    -- platform: linux
    -- tags: transient filesystem state
    SELECT
      *
    FROM
      mounts
    WHERE
      device = '/dev/disk0s1'
      AND type = 'msdos';
  description: Detect weird mounts, like mounting the EFI partition
  name: 'Detection - Execution: Unexpected Mounts'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Detect unusual calls to osascript
    --
    -- false positives:
    --   * none observed, but they are expected
    --
    -- interval: 60
    -- platform: darwin
    -- tags: process events
    SELECT
      p.pid,
      p.path,
      TRIM(p.cmdline) AS cmd,
      p.mode,
      p.cwd,
      p.euid,
      p.parent,
      p.syscall,
      hash.sha256,
      pp.path AS parent_path,
      pp.name AS parent_name,
      TRIM(p.cmdline) AS parent_cmd,
      pp.euid AS parent_euid,
      phash.sha256 AS parent_sha256
    FROM
      uptime,
      process_events p
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN hash AS phash ON pp.path = phash.path
    WHERE
      p.path = '/usr/bin/osascript'
      AND p.time > (strftime('%s', 'now') -60)
      AND NOT cmd LIKE 'osascript -e set zoomStatus%'
      AND NOT cmd LIKE 'osascript openChrome.applescript http://127.0.0.1:%'
      AND NOT cmd IN (
        'osascript -e user locale of (get system info)',
        'osascript'
      )
  description: Detect unusual calls to osascript
  name: 'Detection - Execution: Unexpected Osascript Calls'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find unexpected use of raw sockets in executables, sometimes used for C&C communications
    --
    -- false positives:
    --   * operating-system network managers
    --
    -- tags: transient process state
    -- platform: posix
    SELECT
      pop.pid,
      p.path,
      p.cmdline,
      p.name,
      hash.sha256
    FROM
      process_open_sockets pop
      JOIN processes p ON pop.pid = p.pid
      JOIN hash ON p.path = hash.path
    WHERE
      family = 17 -- PF_PACKET
      AND name NOT IN (
        'wpa_supplicant',
        'NetworkManager',
        'dhcpcd',
        'tcpdump'
      )
  description: Find unexpected use of raw sockets in executables, sometimes used for C&C communications
  name: 'Detection - Execution: Unexpected Raw Socket'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Find unexpected setuid binaries on disk
    --
    -- false positives:
    --   * new software
    --
    -- tags: persistent seldom
    -- platform: posix
    SELECT
      file.path,
      gid,
      uid,
      mode,
      type,
      size,
      sha256
    FROM
      file
      JOIN hash ON file.path = hash.path
    WHERE
      (
        file.path LIKE '/bin/%'
        OR file.path LIKE '/home/%/bin/%'
        OR file.path LIKE '/opt/%/bin/%'
        OR file.path LIKE '/opt/%/sbin/%'
        OR file.path LIKE '/sbin/%'
        OR file.path LIKE '/tmp/%'
        OR file.path LIKE '/Users/%/bin/%'
        OR file.path LIKE '/usr/bin/%'
        OR file.path LIKE '/usr/lib/%'
        OR file.path LIKE '/usr/lib64/%'
        OR file.path LIKE '/usr/libexec/%'
        OR file.path LIKE '/usr/local/bin/%'
        OR file.path LIKE '/usr/local/lib/%'
        OR file.path LIKE '/usr/local/lib64/%'
        OR file.path LIKE '/usr/local/libexec/%'
        OR file.path LIKE '/usr/local/sbin/%'
        OR file.path LIKE '/usr/sbin/%'
        OR file.path LIKE '/var/lib/%'
        OR file.path LIKE '/var/tmp/%'
      )
      AND type = 'regular'
      AND mode NOT LIKE '0%'
      AND mode NOT LIKE '1%'
      AND mode NOT LIKE '2%'
      AND NOT (
        mode LIKE '4%11'
        AND uid = 0
        AND gid = 0
        AND file.path IN (
          '/bin/cdda2wav',
          '/bin/cdrecord',
          '/bin/icedax',
          '/bin/mount.nfs',
          '/bin/mount.nfs4',
          '/bin/readcd',
          '/bin/readom',
          '/bin/rscsi',
          '/bin/staprun',
          '/bin/sudo',
          '/bin/sudoedit',
          '/bin/umount.nfs',
          '/bin/umount.nfs4',
          '/bin/wodim',
          '/sbin/cdda2wav',
          '/sbin/cdrecord',
          '/sbin/icedax',
          '/sbin/mount.nfs',
          '/sbin/mount.nfs4',
          '/sbin/readcd',
          '/sbin/readom',
          '/sbin/rscsi',
          '/sbin/umount.nfs',
          '/sbin/umount.nfs4',
          '/sbin/userhelper',
          '/sbin/wodim',
          '/usr/bin/cdda2wav',
          '/usr/bin/cdrecord',
          '/usr/bin/icedax',
          '/usr/bin/mount.nfs',
          '/usr/bin/mount.nfs4',
          '/usr/bin/readcd',
          '/usr/bin/readom',
          '/usr/bin/rscsi',
          '/usr/bin/staprun',
          '/usr/bin/sudo',
          '/usr/bin/sudoedit',
          '/usr/bin/umount.nfs',
          '/usr/bin/umount.nfs4',
          '/usr/bin/wodim',
          '/usr/libexec/security_authtrampoline',
          '/usr/sbin/cdda2wav',
          '/usr/sbin/cdrecord',
          '/usr/sbin/icedax',
          '/usr/sbin/mount.nfs',
          '/usr/sbin/mount.nfs4',
          '/usr/sbin/readcd',
          '/usr/sbin/readom',
          '/usr/sbin/rscsi',
          '/usr/sbin/umount.nfs',
          '/usr/sbin/umount.nfs4',
          '/usr/sbin/userhelper',
          '/usr/sbin/wodim'
        )
      )
      AND NOT (
        mode LIKE '4%55'
        AND uid = 0
        AND gid = 0
        AND file.path IN (
          '/bin/chage',
          '/bin/chfn',
          '/bin/chsh',
          '/bin/crontab',
          '/bin/doas',
          '/bin/expiry',
          '/bin/fusermount-glusterfs',
          '/bin/fusermount',
          '/bin/fusermount3',
          '/bin/gpasswd',
          '/bin/ksu',
          '/bin/mount',
          '/bin/ndisc6',
          '/bin/newgidmap',
          '/bin/newgrp',
          '/bin/newuidmap',
          '/usr/bin/newgidmap',
          '/bin/nvidia-modprobe',
          '/bin/passwd',
          '/bin/pkexec',
          '/bin/ps',
          '/bin/rdisc6',
          '/bin/rltraceroute6',
          '/bin/sg',
          '/bin/su',
          '/bin/sudo',
          '/bin/sudoedit',
          '/bin/suexec',
          '/bin/ubuntu-core-launcher',
          '/bin/umount',
          '/bin/vmware-user-suid-wrapper',
          '/bin/vmware-user',
          '/sbin/chage',
          '/sbin/chfn',
          '/sbin/chsh',
          '/sbin/crontab',
          '/sbin/doas',
          '/sbin/expiry',
          '/sbin/fusermount',
          '/sbin/fusermount3',
          '/sbin/gpasswd',
          '/sbin/grub2-set-bootflag',
          '/sbin/ksu',
          '/sbin/mount.nfs',
          '/sbin/mount.nfs4',
          '/sbin/mount',
          '/sbin/ndisc6',
          '/sbin/newgrp',
          '/sbin/nvidia-modprobe',
          '/sbin/pam_timestamp_check',
          '/sbin/passwd',
          '/sbin/pkexec',
          '/sbin/rdisc6',
          '/sbin/rltraceroute6',
          '/sbin/sg',
          '/sbin/su',
          '/sbin/sudo',
          '/sbin/sudoedit',
          '/sbin/suexec',
          '/sbin/umount.nfs',
          '/sbin/umount.nfs4',
          '/sbin/umount',
          '/sbin/unix_chkpwd',
          '/usr/bin/at',
          '/usr/bin/atq',
          '/usr/bin/atrm',
          '/usr/bin/batch',
          '/usr/bin/chage',
          '/usr/bin/chfn',
          '/usr/bin/chsh',
          '/usr/bin/crontab',
          '/usr/bin/doas',
          '/usr/bin/expiry',
          '/usr/bin/fusermount-glusterfs',
          '/usr/bin/fusermount',
          '/usr/bin/fusermount3',
          '/usr/bin/gpasswd',
          '/usr/bin/ksu',
          '/usr/bin/login',
          '/usr/bin/mount',
          '/usr/bin/ndisc6',
          '/usr/bin/newgrp',
          '/usr/bin/newuidmap',
          '/usr/bin/nvidia-modprobe',
          '/usr/bin/passwd',
          '/usr/bin/pkexec',
          '/usr/bin/quota',
          '/usr/bin/mullvad-exclude',
          '/usr/sbin/mullvad-exclude',
          '/usr/bin/rdisc6',
          '/usr/bin/rltraceroute6',
          '/usr/bin/sg',
          '/sbin/mullvad-exclude',
          '/bin/mullvad-exclude',
          '/usr/bin/su',
          '/usr/bin/sudo',
          '/usr/bin/sudoedit',
          '/usr/bin/suexec',
          '/usr/bin/top',
          '/usr/bin/ubuntu-core-launcher',
          '/usr/bin/umount',
          '/usr/bin/vmware-user-suid-wrapper',
          '/usr/bin/vmware-user',
          '/usr/lib/mail-dotlock',
          '/usr/lib/xf86-video-intel-backlight-helper',
          '/usr/lib/Xorg.wrap',
          '/usr/lib64/mail-dotlock',
          '/usr/lib64/xf86-video-intel-backlight-helper',
          '/usr/lib64/Xorg.wrap',
          '/usr/libexec/authopen',
          '/usr/libexec/polkit-agent-helper-1',
          '/usr/libexec/qemu-bridge-helper',
          '/usr/libexec/Xorg.wrap',
          '/usr/sbin/chage',
          '/usr/sbin/chfn',
          '/usr/sbin/chsh',
          '/usr/sbin/crontab',
          '/usr/sbin/doas',
          '/usr/sbin/expiry',
          '/usr/sbin/fusermount',
          '/usr/sbin/fusermount3',
          '/usr/sbin/gpasswd',
          '/usr/sbin/grub2-set-bootflag',
          '/usr/sbin/ksu',
          '/usr/sbin/mount.nfs',
          '/usr/sbin/mount.nfs4',
          '/usr/sbin/mount',
          '/usr/sbin/ndisc6',
          '/usr/sbin/newgrp',
          '/usr/sbin/nvidia-modprobe',
          '/usr/sbin/pam_timestamp_check',
          '/usr/sbin/passwd',
          '/usr/sbin/pkexec',
          '/usr/sbin/rdisc6',
          '/usr/sbin/rltraceroute6',
          '/usr/sbin/sg',
          '/usr/sbin/su',
          '/usr/sbin/sudo',
          '/usr/sbin/sudoedit',
          '/usr/sbin/suexec',
          '/usr/sbin/traceroute',
          '/usr/sbin/traceroute6',
          '/usr/sbin/umount.nfs',
          '/usr/sbin/umount.nfs4',
          '/usr/sbin/umount',
          '/usr/sbin/unix_chkpwd'
        )
      )
      AND NOT (
        mode = '4754'
        AND uid = 0
        AND gid = 30
        AND file.path IN ('/usr/sbin/pppd', '/sbin/pppd')
      )
      AND NOT (
        mode = '6755'
        AND uid = 0
        AND gid = 0
        AND file.path IN (
          '/bin/mount.cifs',
          '/bin/mount.smb3',
          '/bin/unix_chkpwd',
          '/sbin/mount.cifs',
          '/sbin/mount.smb3',
          '/sbin/unix_chkpwd',
          '/usr/bin/mount.cifs',
          '/usr/bin/mount.smb3',
          '/usr/bin/unix_chkpwd',
          '/usr/lib/xtest',
          '/usr/lib64/xtest',
          '/usr/sbin/mount.cifs',
          '/usr/sbin/mount.smb3',
          '/usr/sbin/unix_chkpwd'
        )
      )
      AND NOT (
        mode = '4110'
        AND uid = 0
        AND gid = 156
        AND file.path IN ('/bin/staprun', '/usr/bin/staprun')
      )
  description: Find unexpected setuid binaries on disk
  name: 'Detection - Execution: Unexpected Setuid Binaries'
kind: query
---
apiVersion: v1
spec:
  query: |
    -- Returns a list of malware matches from macOS XProtect
    --
    -- tags: persistent often malware xprotect
    -- platform: darwin
    SELECT
      *
    FROM
      xprotect_reports;
  description: Returns a list of malware matches from macOS XProtect
  name: 'Detection - Execution: Xprotect Reports'
kind: query

